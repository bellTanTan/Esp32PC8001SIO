# File esp32pc8001sio_ram.asm
0000			                ORG     0A000H 
a000			_PROG_TOP: 
a000			_MON_ENTRY: 
a000 cd 10 a0		                CALL    _ENTRY 
a003 c3 81 00		                JP      ROM_BASPROMPT 
a006 00			                NOP 
a007 00			                NOP 
a008 00			                NOP 
a009 00			                NOP 
a00a 00			                NOP 
a00b 00			                NOP 
a00c 00			                NOP 
a00d 01			                DB      VER_MAJOR 
a00e 00			                DB      VER_MINOR 
a00f 02			                DB      VER_REVISION 
a010			_ENTRY: 
a010 cd 55 a0		                CALL    ENTRY_SETUP 
a013 c9			                RET 
a014			NEWJPTBL: 
a014 c3 17 a0		                JP      NEW_CMD 
a017			NEW_CMD: 
a017			                INCLUDE "esp32pc8001sio.asm" 
a017			;******************************************************************************** 
a017			; 
a017			; Created by tan (trinity09181718@gmail.com) 
a017			; Copyright (c) 2022 tan 
a017			; All rights reserved. 
a017			; 
a017			; Please contact trinity09181718@gmail.com if you need a commercial license. 
a017			; This software is available under GPL v3. 
a017			; 
a017			;******************************************************************************** 
a017			; 
a017			; Implementation contents as N-BASIC command extension 
a017			; 
a017			; CMD BME 
a017			; CMD FTPLIST 
a017			; CMD FTPGET,nnn 
a017			; CMD FTPGET,nnn,&hXXXX 
a017			; CMD SNTP 
a017			; CMD SPILIST 
a017			; CMD SPIGET,nnn 
a017			; CMD SPIGET,nnn,&hXXXX 
a017			; CMD VER 
a017			; 
a017			; Implementation contents as N80-BASIC command extension 
a017			; 
a017			; MAT BME 
a017			; MAT FTPLIST 
a017			; MAT FTPGET,nnn 
a017			; MAT FTPGET,nnn,&hXXXX 
a017			; MAT SNTP 
a017			; MAT SPILIST 
a017			; MAT SPIGET,nnn 
a017			; MAT SPIGET,nnn,&hXXXX 
a017			; MAT VER 
a017			; 
a017			;******************************************************************************** 
a017			; 更新履歴 
a017			; 2022/10/10 v1.0.2 PC-8001mkIIにてRS-232C受信割込テーブル位置(8000H,8001H)を書換え 
a017			;                   られるタイプのバイナリ受信処理対応(確認不足) 
a017			;                   (cmt Planet Taizer:8000H~E7FFHが顕著) 
a017			;                   多段ロード形式cmtファイル対応 
a017			; 2022/10/01 v1.0.1 spiffs関連実装 
a017			;                   PC-8001とPC-8001mkIIのboot判定とフックコマンドの切り替え 
a017			;                   PC-8001mkII RS-232C 受信割込9600bps実装 
a017			;                   cmd ftpget or mat ftpget or cmd spiget or mat spigetにて 
a017			;                   PC-8001時EA00H or PC-8001mkII E600H 以上に入りこむメモリー 
a017			;                   オーバー判定と受信不良の不具合改修 
a017			;                   (cmt Scramble:C010H~E9FFHが顕著) 
a017			;                   cmd sntp or mat sntp で月がBCDとして設定されてしまう不具合改修 
a017			; 2022/09/17 v1.0.0 リリース 
a017			; 2022/08/07 v1.0.0 GitHub 公開 
a017			;******************************************************************************** 
a017			; 
a017			; CONSTANT CONTROL CODE 
a017			; 
a017			NUL:            EQU     00H 
a017			SOH:            EQU     01H 
a017			STX:            EQU     02H 
a017			EOT:            EQU     04H 
a017			ACK:            EQU     06H 
a017			BS:             EQU     08H 
a017			LF:             EQU     0AH 
a017			CR:             EQU     0DH 
a017			NAK:            EQU     15H 
a017			CAN:            EQU     18H 
a017			ESC:            EQU     1BH 
a017			; 
a017			; CONSTANT I/O PORT 
a017			; 
a017			KEYBRD9:        EQU     09H 
a017			USARTDW:        EQU     20H 
a017			USARTCW:        EQU     21H             ; MODE SETUP 
a017			                                        ; 76543210 
a017			                                        ; ||||||++--- BAUD RATE FACTOR 
a017			                                        ; ||||||      00 : SYNC MODE 
a017			                                        ; ||||||      01 : 1X 
a017			                                        ; ||||||      10 : 16X 
a017			                                        ; ||||||      11 : 64X 
a017			                                        ; ||||++----- CHARACTER LENGTH 
a017			                                        ; ||||        00 : 5BITS 
a017			                                        ; ||||        01 : 6BITS 
a017			                                        ; ||||        10 : 7BITS 
a017			                                        ; ||||        11 : 8BITS 
a017			                                        ; |||+------- PARITY ENABLE 
a017			                                        ; |||         1 : ENABLE 
a017			                                        ; |||         0 : DISABLE 
a017			                                        ; ||+-------- EVEN PARITY GENARATION/CHECK 
a017			                                        ; ||          1 : EVEN 
a017			                                        ; ||          0 : ODD 
a017			                                        ; ++--------- NUMBER OF STOP BITS 
a017			                                        ;             00 : INVALID 
a017			                                        ;             01 : 1 BIT 
a017			                                        ;             10 : 1.5 BITS 
a017			                                        ;             11 : 2 BITS 
a017			                                        ; 
a017			                                        ; COMMAND SETUP 
a017			                                        ; 76543210 
a017			                                        ; |||||||+--- TRANSMIT ENABLE 
a017			                                        ; |||||||     1 : ENABLE 
a017			                                        ; |||||||     0 : DISABLE 
a017			                                        ; ||||||+---- DATA TERMINAL READY 
a017			                                        ; ||||||      "high" will force ~DTR output zero 
a017			                                        ; |||||+----- RECEIVE ENABLE 
a017			                                        ; |||||       1 : ENABLE 
a017			                                        ; |||||       0 : DISABLE 
a017			                                        ; ||||+------ SEND BREAK CHARACTER 
a017			                                        ; ||||        1 : forces TxD "low" 
a017			                                        ; ||||        0 : normal operation 
a017			                                        ; |||+------- ERROR RESET 
a017			                                        ; |||         1 : reset all error flags PE,OE,FE 
a017			                                        ; ||+-------- REQUEST TO SEND 
a017			                                        ; ||          "high" will force ~RTS output zero 
a017			                                        ; |+--------- INTERNAL RESET 
a017			                                        ; |           "high" returns USART to Mode Instruction Format 
a017			                                        ; +---------- ENTER HUNT MODE 
a017			                                        ;             1 = enable search for Sync Characters 
a017			                                        ; 
a017			                                        ; STATUS READ 
a017			                                        ; 76543210 
a017			                                        ; |||||||+--- TxRDY 
a017			                                        ; ||||||+---- RxRDY 
a017			                                        ; |||||+----- TxEMPTY 
a017			                                        ; ||||+------ PE(PARITY ERROR) 
a017			                                        ; |||+------- OE(OVERRUN ERROR) 
a017			                                        ; ||+-------- FE(FRAMING ERROR) 
a017			                                        ; |+--------- SYNDET 
a017			                                        ; +---------- DSR 
a017			CONTROL1:       EQU     30H 
a017			INTLEVEL:       EQU     0E4H 
a017			INTMASK:        EQU     0E6H 
a017			; 
a017			; CONSTANT PC-8001mkII ROM BASIC CMD ENTRY 
a017			; 
a017			PC8001MK2_NMODE:        EQU     1875H 
a017			PC8001MK2_N80MODE:      EQU     0E730H 
a017			; 
a017			; CONSTANT ROM BASIC ROUTINE 
a017			; 
a017			ROM_BASPROMPT:  EQU     0081H 
a017			ROM_DSPCHR:     EQU     0257H 
a017			ROM_MOVECURSOR: EQU     03A9H 
a017			ROM_DSPCURSOR:  EQU     0BE2H 
a017			ROM_BEEP:       EQU     0D43H 
a017			ROM_KEYWAIT:    EQU     0F75H 
a017			ROM_KEYSCAN:    EQU     0FACH 
a017			ROM_TIMEREAD:   EQU     1602H 
a017			ROM_TIMEWRITE:  EQU     1663H 
a017			ROM_PC8001CHK:  EQU     175FH 
a017			ROM_BIN2DECASC: EQU     309FH 
a017			ROM_SYNERR:     EQU     3BDFH 
a017			ROM_MSGOUT:     EQU     52EDH 
a017			ROM_MON_UNEXT:  EQU     5C35H 
a017			ROM_HEXASC2BIN: EQU     5E4BH 
a017			ROM_DSPHEX4:    EQU     5EC0H 
a017			ROM_CMPHLDE:    EQU     5ED3H 
a017			ROM_DSP1CHR:    EQU     5FB0H 
a017			ROM_DSPCRLF:    EQU     5FCAH 
a017			; 
a017			; CONSTANT ROM BASIC WORK AREA 
a017			; 
a017			PC8001RAM_TOP:  EQU     8000H 
a017			VECTOR_TBL_SIO: EQU     8000H 
a017			N80ROM_WORKTOP: EQU     0E600H 
a017			NROM_WORKTOP:   EQU     0EA00H 
a017			LAST_INTLEVEL:  EQU     0EA55H 
a017			FLG_INTEXEC:    EQU     0EA56H 
a017			FUNKEY_DISPSTS: EQU     0EA60H 
a017			CRT_TEXT_ROWS:  EQU     0EA62H 
a017			CURSOR_YPOS:    EQU     0EA63H 
a017			CURSOR_XPOS:    EQU     0EA64H 
a017			CRT_TEXT_COLS:  EQU     0EA65H 
a017			CTL1_OUTDATA:   EQU     0EA66H 
a017			FUNCKEY_FLAG:   EQU     0EA68H 
a017			BCD_TIME_SEC:   EQU     0EA76H 
a017			BCD_TIME_YEAR:  EQU     0EA7BH 
a017			FUNCKEY_DATA:   EQU     0EAC0H 
a017			OUTPUT_DEVICE:  EQU     0EB49H 
a017			BASAREA_TOP:    EQU     0EB54H 
a017			FUNCKEY_PTR:    EQU     0EDC0H 
a017			RS232C_CH1BUF:  EQU     0EDCEH                  ; AREA DS 128 
a017			RS232C_CH2BUF:  EQU     0EE4EH                  ; AREA DS 128 
a017			VARAREA_TOP:    EQU     0EFA0H 
a017			ARRAYAREA_TOP:  EQU     0EFA2H 
a017			FREEAREA_TOP:   EQU     0EFA4H 
a017			BIN_ACC:        EQU     0F0A8H 
a017			CMD_ENTRY:      EQU     0F0FCH 
a017			MAT_ENTRY:      EQU     0F111H 
a017			; 
a017			; N-BASIC ROM FREE AREA1 : F216~F2FF 
a017			; N-BASIC ROM FREE AREA2 : FF3D~FFFF 
a017			; CONSTANT ESP32PC8001SIO WORK AREA 
a017			; 
a017			SAVESP:         EQU     0F216H                  ; WORD DW 
a017			LISTCNT:        EQU     0F218H                  ; WORD DW 
a017			SELLISTNO:      EQU     0F21AH                  ; WORD DW 
a017			LOADADRS:       EQU     0F21CH                  ; WORD DW 
a017			EXECADRS:       EQU     0F21EH                  ; WORD DW 
a017			LOAD_ENDADRS:   EQU     0F220H                  ; WORD DW    
a017			LOADSIZE:       EQU     0F222H                  ; WORD DW 
a017			SAVESIOIRQ:     EQU     0F224H                  ; WORD DW 
a017			ROM_WORKTOP:    EQU     0F226H                  ; WORD DW 
a017			EXT_ENTRY:      EQU     0F228H                  ; WORD DW 
a017			DIVICOUNT:      EQU     0F22AH                  ; WORD DW 
a017			SELDIVINO:      EQU     0F22CH                  ; WORD DW 
a017			EXECADRS2:      EQU     0F22EH                  ; WORD DW 
a017			MODEWORD:       EQU     0F230H                  ; BYTE DB 
a017			CTLWORD:        EQU     0F231H                  ; BYTE DB 
a017			EXTNO:          EQU     0F232H                  ; BYTE DB 
a017			CHKBLKNO:       EQU     0F233H                  ; BYTE DB 
a017			LFRECVCOUNT:    EQU     0F234H                  ; BYTE DB 
a017			RCVBUF_RPOS:    EQU     0F235H                  ; BYTE DB 
a017			RCVBUF_WPOS:    EQU     0F236H                  ; BYTE DB 
a017			SAVE_ENTRY:     EQU     0F237H                  ; AREA DS 3 
a017			DISPBUF_TOP:    EQU     0F240H                  ; AREA DS 
a017			FLGDATA:        EQU     0F2FFH                  ; BYTE DB       76543210 
a017			                                                ;               |||||||+--- <CR><LF> first send 
a017			                                                ;               ||||||+---- load basic cmt type        
a017			                                                ;               |||||+----- sio recv time out (5sec) 
a017			                                                ;               ||||+------ sio recv cancel (keyboard STOP key) 
a017			                                                ;               |||+------- enable keyboard STOP key check 
a017			                                                ;               ||+-------- exec machine PC-8001 
a017			                                                ;               |+--------- reserve 
a017			                                                ;               +---------- reserve 
a017			FLG_FIRSTSEND:  EQU     00000001B 
a017			FLG_LOADBAS:    EQU     00000010B 
a017			FLG_RCVTIMEOUT: EQU     00000100B 
a017			FLG_RCVCANCEL:  EQU     00001000B 
a017			FLG_ENABLESTOP: EQU     00010000B 
a017			FLG_EXECPC8001: EQU     00100000B 
a017			; 
a017			SNDBUF_TOP:     EQU     RS232C_CH1BUF           ; AREA DS 
a017			RCVBUF_TOP:     EQU     RS232C_CH1BUF           ; AREA DS 
a017			RCVBUF_HEADER:  EQU     RS232C_CH1BUF           ; BYTE DB 
a017			RCVBUF_BLKNO:   EQU     RS232C_CH1BUF +1        ; BYTE DB 
a017			RCVBUF_CBLKNO:  EQU     RS232C_CH1BUF +2        ; BYTE DB 
a017			RCVBUF_DATA:    EQU     RS232C_CH1BUF +3        ; AREA DS 
a017			RCVBUF_CHKSUM:  EQU     RCVBUF_DATA +128        ; BYTE DB 
a017			RCVBUF_BOTTOM:  EQU     RCVBUF_CHKSUM           ; BYTE DB 
a017			; 
a017			; CONSTANT ESP32PC8001SIO VERSION DATA 
a017			; 
a017			VER_MAJOR:      EQU     1 
a017			VER_MINOR:      EQU     0 
a017			VER_REVISION:   EQU     2 
a017			; 
a017			                ;ORG    0H 
a017			; 
a017			; 
a017			; 
a017			EXT_START:                                      ; SP RETURN ADRS 
a017 c5			                PUSH    BC 
a018 d5			                PUSH    DE 
a019 cd da a7		                CALL    PARSER_EXTPARAM 
a01c d1			                POP     DE 
a01d c1			                POP     BC 
a01e 38 0e		                JR      C,EXT_NON 
a020 f3			                DI 
a021 ed 73 16 f2	                LD      (SAVESP),SP 
a025 eb			                EX      DE,HL 
a026 21 ff ff		                LD      HL,0FFFFH 
a029 f9			                LD      SP,HL 
a02a eb			                EX      DE,HL 
a02b fb			                EI 
a02c fd e9		                JP      (IY) 
a02e			EXT_NON: 
a02e dd 2a 38 f2	                LD      IX,(SAVE_ENTRY + 1)     ; IX -> ORIGINAL ENTRY 
a032			                                                ; STACK DATA RETURN ADRS HOLD 
a032 dd e9		                JP      (IX)                    ; JUMP ORIGINAL ENTRY 
a034			EXT_EXIT: 
a034 af			                XOR     A 
a035 18 0e		                JR      EXT_010 
a037			EXT_MYERR_EXIT: 
a037 3e 01		                LD      A,1 
a039 dd 21 81 00	                LD      IX,ROM_BASPROMPT        ; IX -> (SP) RETURN ADRS 
a03d 18 06		                JR      EXT_010 
a03f			EXT_DLEXEC_EXIT: 
a03f 3e 02		                LD      A,2 
a041 dd 2a 1e f2	                LD      IX,(EXECADRS)           ; IX -> (SP) RETURN ADRS 
a045			EXT_010: 
a045 f3			                DI 
a046 eb			                EX      DE,HL 
a047 2a 16 f2		                LD      HL,(SAVESP) 
a04a f9			                LD      SP,HL 
a04b eb			                EX      DE,HL 
a04c fb			                EI 
a04d fe 00		                CP      0 
a04f c8			                RET     Z 
a050 f3			                DI 
a051 dd e3		                EX      (SP),IX                 ; STACK DATA RETURN ADRS CHANGE         
a053 fb			                EI 
a054 c9			                RET 
a055			; 
a055			; 
a055			; 
a055			ENTRY_SETUP: 
a055 c5			                PUSH    BC 
a056 d5			                PUSH    DE 
a057 e5			                PUSH    HL 
a058 af			                XOR     A 
a059 32 ff f2		                LD      (FLGDATA),A 
a05c 21 00 00		                LD      HL,0 
a05f 22 28 f2		                LD      (EXT_ENTRY),HL 
a062 3a 5f 17		                LD      A,(ROM_PC8001CHK) 
a065 fe 80		                CP      80H             ; N-BASIC IMPLEMENTED IN PC-8001 
a067 28 11		                JR      Z,ENTRY_SETUP_020 
a069 fe af		                CP      0AFH            ; N-BASIC IMPLEMENTED IN PC-8001mkII 
a06b 28 02		                JR      Z,ENTRY_SETUP_010 
a06d 18 56		                JR      ENTRY_SETUP_080 
a06f			ENTRY_SETUP_010: 
a06f 2a fd f0		                LD      HL,(CMD_ENTRY + 1) 
a072 11 30 e7		                LD      DE,PC8001MK2_N80MODE 
a075 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a078			                                        ; HL<DE : 0  1 
a078			                                        ; HL=DE : 1  0 
a078			                                        ; HL>DE : 0  0 
a078 28 08		                JR      Z,ENTRY_SETUP_030 
a07a			ENTRY_SETUP_020: 
a07a 21 fc f0		                LD      HL,CMD_ENTRY 
a07d 22 28 f2		                LD      (EXT_ENTRY),HL 
a080 18 06		                JR      ENTRY_SETUP_040 
a082			ENTRY_SETUP_030: 
a082 21 11 f1		                LD      HL,MAT_ENTRY 
a085 22 28 f2		                LD      (EXT_ENTRY),HL 
a088			ENTRY_SETUP_040: 
a088 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a08b 11 14 a0		                LD      DE,NEWJPTBL 
a08e 06 03		                LD      B,3 
a090			ENTRY_SETUP_L010: 
a090 4e			                LD      C,(HL) 
a091 1a			                LD      A,(DE) 
a092 b9			                CP      C 
a093 20 06		                JR      NZ,ENTRY_SETUP_050 
a095 23			                INC     HL 
a096 13			                INC     DE 
a097 10 f7		                DJNZ    ENTRY_SETUP_L010 
a099 18 2a		                JR      ENTRY_SETUP_080 
a09b			ENTRY_SETUP_050: 
a09b 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a09e 11 37 f2		                LD      DE,SAVE_ENTRY 
a0a1 06 03		                LD      B,3 
a0a3			ENTRY_SETUP_L020: 
a0a3 4e			                LD      C,(HL) 
a0a4 1a			                LD      A,(DE) 
a0a5 b9			                CP      C 
a0a6 20 06		                JR      NZ,ENTRY_SETUP_060 
a0a8 23			                INC     HL 
a0a9 13			                INC     DE 
a0aa 10 f7		                DJNZ    ENTRY_SETUP_L020 
a0ac 18 0b		                JR      ENTRY_SETUP_070 
a0ae			ENTRY_SETUP_060: 
a0ae 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a0b1 11 37 f2		                LD      DE,SAVE_ENTRY 
a0b4 01 03 00		                LD      BC,3 
a0b7 ed b0		                LDIR 
a0b9			ENTRY_SETUP_070: 
a0b9 21 14 a0		                LD      HL,NEWJPTBL 
a0bc ed 5b 28 f2	                LD      DE,(EXT_ENTRY) 
a0c0 01 03 00		                LD      BC,3 
a0c3 ed b0		                LDIR 
a0c5			ENTRY_SETUP_080: 
a0c5 e1			                POP     HL 
a0c6 d1			                POP     DE 
a0c7 c1			                POP     BC 
a0c8 c9			                RET 
a0c9			; 
a0c9			; 
a0c9			; 
a0c9			EXT_BME: 
a0c9 e5			                PUSH    HL 
a0ca cd 44 a9		                CALL    INIT_SIO 
a0cd da b6 a7		                JP      C,EXT_ERR5 
a0d0 21 46 ac		                LD      HL,TBL_EXT_BME 
a0d3 11 ce ed		                LD      DE,SNDBUF_TOP 
a0d6 01 03 00		                LD      BC,3 
a0d9 ed b0		                LDIR 
a0db 21 10 ad		                LD      HL,TBL_CRLF 
a0de 01 02 00		                LD      BC,2 
a0e1 ed b0		                LDIR 
a0e3 06 05		                LD      B,5 
a0e5 cd 53 ab		                CALL    SENDBUF_OUT 
a0e8 06 01		                LD      B,1 
a0ea cd 5e ab		                CALL    RECVBUF_IN 
a0ed 3a ff f2		                LD      A,(FLGDATA) 
a0f0 e6 04		                AND     FLG_RCVTIMEOUT 
a0f2 c2 a2 a7		                JP      NZ,EXT_ERR1 
a0f5 11 46 ac		                LD      DE,TBL_EXT_BME 
a0f8 06 03		                LD      B,3 
a0fa cd 95 ab		                CALL    RECVBUF_CHK 
a0fd da a7 a7		                JP      C,EXT_ERR2 
a100 06 00		                LD      B,0 
a102 cd 12 a1		                CALL    EXT_BME_MSG 
a105 06 01		                LD      B,1 
a107 cd 12 a1		                CALL    EXT_BME_MSG 
a10a 06 02		                LD      B,2 
a10c cd 12 a1		                CALL    EXT_BME_MSG 
a10f c3 d2 a7		                JP      EXT_END 
a112			EXT_BME_MSG: 
a112 e5			                PUSH    HL 
a113 78			                LD      A,B 
a114 fe 01		                CP      1 
a116 28 09		                JR      Z,EXT_BME_000 
a118 fe 02		                CP      2 
a11a 28 0a		                JR      Z,EXT_BME_010 
a11c 21 c8 ac		                LD      HL,TBL_TEMP_MSG0 
a11f 18 08		                JR      EXT_BME_020 
a121			EXT_BME_000: 
a121 21 d3 ac		                LD      HL,TBL_HUMI_MSG0 
a124 18 03		                JR      EXT_BME_020 
a126			EXT_BME_010: 
a126 21 dd ac		                LD      HL,TBL_PRESS_MSG0 
a129			EXT_BME_020: 
a129 11 40 f2		                LD      DE,DISPBUF_TOP 
a12c			EXT_BME_L010: 
a12c 7e			                LD      A,(HL) 
a12d 12			                LD      (DE),A 
a12e 23			                INC     HL 
a12f 13			                INC     DE 
a130 fe 00		                CP      0 
a132 20 f8		                JR      NZ,EXT_BME_L010 
a134 e1			                POP     HL 
a135 1b			                DEC     DE 
a136			EXT_BME_L020: 
a136 7e			                LD      A,(HL) 
a137 fe 2c		                CP      ',' 
a139 28 09		                JR      Z,EXT_BME_050 
a13b fe 0d		                CP      CR 
a13d 28 05		                JR      Z,EXT_BME_050 
a13f 12			                LD      (DE),A 
a140 23			                INC     HL 
a141 13			                INC     DE 
a142 18 f2		                JR      EXT_BME_L020 
a144			EXT_BME_050: 
a144 23			                INC     HL 
a145 e5			                PUSH    HL 
a146 78			                LD      A,B 
a147 fe 01		                CP      1 
a149 28 09		                JR      Z,EXT_BME_060 
a14b fe 02		                CP      2 
a14d 28 0a		                JR      Z,EXT_BME_070 
a14f 21 d0 ac		                LD      HL,TBL_TEMP_MSG1 
a152 18 08		                JR      EXT_BME_L030 
a154			EXT_BME_060: 
a154 21 db ac		                LD      HL,TBL_HUMI_MSG1 
a157 18 03		                JR      EXT_BME_L030 
a159			EXT_BME_070: 
a159 21 e5 ac		                LD      HL,TBL_PRESS_MSG1 
a15c			EXT_BME_L030: 
a15c 7e			                LD      A,(HL) 
a15d 12			                LD      (DE),A 
a15e 23			                INC     HL 
a15f 13			                INC     DE 
a160 fe 00		                CP      0 
a162 20 f8		                JR      NZ,EXT_BME_L030 
a164 e1			                POP     HL 
a165 1b			                DEC     DE 
a166 c5			                PUSH    BC 
a167 d5			                PUSH    DE 
a168 e5			                PUSH    HL 
a169 cd ab ab		                CALL    MSG_DISP 
a16c e1			                POP     HL 
a16d d1			                POP     DE 
a16e c1			                POP     BC 
a16f c9			                RET 
a170			; 
a170			; 
a170			; 
a170			EXT_FTPLIST: 
a170 e5			                PUSH    HL 
a171 cd 44 a9		                CALL    INIT_SIO 
a174 da b6 a7		                JP      C,EXT_ERR5 
a177 21 8b ac		                LD      HL,TBL_EXT_FTPLIST2 
a17a 11 ce ed		                LD      DE,SNDBUF_TOP 
a17d 01 07 00		                LD      BC,7 
a180 ed b0		                LDIR 
a182 21 10 ad		                LD      HL,TBL_CRLF 
a185 01 02 00		                LD      BC,2 
a188 ed b0		                LDIR 
a18a 06 09		                LD      B,9 
a18c cd 53 ab		                CALL    SENDBUF_OUT 
a18f 06 01		                LD      B,1 
a191 cd 5e ab		                CALL    RECVBUF_IN 
a194 3a ff f2		                LD      A,(FLGDATA) 
a197 e6 04		                AND     FLG_RCVTIMEOUT 
a199 c2 a2 a7		                JP      NZ,EXT_ERR1 
a19c 11 8b ac		                LD      DE,TBL_EXT_FTPLIST2 
a19f 06 07		                LD      B,7 
a1a1 cd 95 ab		                CALL    RECVBUF_CHK 
a1a4 da a7 a7		                JP      C,EXT_ERR2 
a1a7			EXT_FTPLIST_000: 
a1a7 e5			                PUSH    HL 
a1a8 21 bb ac		                LD      HL,TBL_COUNT_MSG0 
a1ab 11 40 f2		                LD      DE,DISPBUF_TOP 
a1ae			EXT_FTPLIST_L000: 
a1ae 7e			                LD      A,(HL) 
a1af 12			                LD      (DE),A 
a1b0 23			                INC     HL 
a1b1 13			                INC     DE 
a1b2 fe 00		                CP      0 
a1b4 20 f8		                JR      NZ,EXT_FTPLIST_L000 
a1b6 1b			                DEC     DE 
a1b7 e1			                POP     HL 
a1b8 e5			                PUSH    HL 
a1b9 01 03 00		                LD      BC,3 
a1bc ed b0		                LDIR 
a1be cd ab ab		                CALL    MSG_DISP 
a1c1 e1			                POP     HL 
a1c2			; 
a1c2 7e			                LD      A,(HL) 
a1c3 e6 0f		                AND     0FH 
a1c5 5f			                LD      E,A 
a1c6 3e 64		                LD      A,100 
a1c8 e5			                PUSH    HL 
a1c9 cd be ab		                CALL    MUL_88_2_16 
a1cc 22 18 f2		                LD      (LISTCNT),HL 
a1cf e1			                POP     HL 
a1d0 23			                INC     HL 
a1d1 7e			                LD      A,(HL) 
a1d2 e6 0f		                AND     0FH 
a1d4 5f			                LD      E,A 
a1d5 3e 0a		                LD      A,10 
a1d7 e5			                PUSH    HL 
a1d8 cd be ab		                CALL    MUL_88_2_16 
a1db eb			                EX      DE,HL 
a1dc 2a 18 f2		                LD      HL,(LISTCNT) 
a1df 19			                ADD     HL,DE 
a1e0 22 18 f2		                LD      (LISTCNT),HL 
a1e3 e1			                POP     HL 
a1e4 23			                INC     HL 
a1e5 7e			                LD      A,(HL) 
a1e6 e6 0f		                AND     0FH 
a1e8 5f			                LD      E,A 
a1e9 3e 01		                LD      A,1 
a1eb e5			                PUSH    HL 
a1ec cd be ab		                CALL    MUL_88_2_16 
a1ef eb			                EX      DE,HL 
a1f0 2a 18 f2		                LD      HL,(LISTCNT) 
a1f3 19			                ADD     HL,DE 
a1f4 22 18 f2		                LD      (LISTCNT),HL 
a1f7 e1			                POP     HL 
a1f8 2a 18 f2		                LD      HL,(LISTCNT) 
a1fb 11 00 00		                LD      DE,0 
a1fe cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a201			                                        ; HL<DE : 0  1 
a201			                                        ; HL=DE : 1  0 
a201			                                        ; HL>DE : 0  0 
a201 ca d2 a7		                JP      Z,EXT_END 
a204 ed 53 1a f2	                LD      (SELLISTNO),DE 
a208			EXT_FTPLIST_L010: 
a208 af			                XOR     A 
a209 32 35 f2		                LD      (RCVBUF_RPOS),A 
a20c 32 36 f2		                LD      (RCVBUF_WPOS),A 
a20f 21 40 f2		                LD      HL,DISPBUF_TOP 
a212 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a216 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a21a 01 00 00		                LD      BC,0 
a21d cd 9f 30		                CALL    ROM_BIN2DECASC 
a220 21 99 ac		                LD      HL,TBL_EXT_LIST 
a223 11 ce ed		                LD      DE,SNDBUF_TOP 
a226 01 05 00		                LD      BC,5 
a229 ed b0		                LDIR 
a22b 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a22e 01 03 00		                LD      BC,3 
a231 ed b0		                LDIR 
a233 21 10 ad		                LD      HL,TBL_CRLF 
a236 01 02 00		                LD      BC,2 
a239 ed b0		                LDIR 
a23b 06 0a		                LD      B,10 
a23d cd 53 ab		                CALL    SENDBUF_OUT 
a240 06 01		                LD      B,1 
a242 cd 5e ab		                CALL    RECVBUF_IN 
a245 3a ff f2		                LD      A,(FLGDATA) 
a248 e6 04		                AND     FLG_RCVTIMEOUT 
a24a c2 a2 a7		                JP      NZ,EXT_ERR1 
a24d 11 99 ac		                LD      DE,TBL_EXT_LIST 
a250 06 04		                LD      B,4 
a252 cd 95 ab		                CALL    RECVBUF_CHK 
a255 da a7 a7		                JP      C,EXT_ERR2 
a258 11 40 f2		                LD      DE,DISPBUF_TOP 
a25b 01 03 00		                LD      BC,3 
a25e ed b0		                LDIR 
a260 3e 3a		                LD      A,':' 
a262 12			                LD      (DE),A 
a263 13			                INC     DE 
a264 3a 65 ea		                LD      A,(CRT_TEXT_COLS) 
a267 fe 48		                CP      72 
a269 28 1a		                JR      Z,EXT_FTPLIST_040 
a26b fe 50		                CP      80 
a26d 28 16		                JR      Z,EXT_FTPLIST_040 
a26f 06 04		                LD      B,4 
a271			EXT_FTPLIST_010: 
a271 7e			                LD      A,(HL) 
a272 23			                INC     HL 
a273 fe 2c		                CP      ',' 
a275 28 02		                JR      Z,EXT_FTPLIST_020 
a277 18 f8		                JR      EXT_FTPLIST_010 
a279			EXT_FTPLIST_020: 
a279 10 f6		                DJNZ    EXT_FTPLIST_010 
a27b			EXT_FTPLIST_030: 
a27b 7e			                LD      A,(HL) 
a27c 12			                LD      (DE),A 
a27d 23			                INC     HL 
a27e 13			                INC     DE 
a27f fe 0d		                CP      CR 
a281 28 15		                JR      Z,EXT_FTPLIST_070 
a283 18 f6		                JR      EXT_FTPLIST_030 
a285			EXT_FTPLIST_040: 
a285 23			                INC     HL 
a286			EXT_FTPLIST_L020: 
a286 7e			                LD      A,(HL) 
a287 fe 2c		                CP      ',' 
a289 28 06		                JR      Z,EXT_FTPLIST_050 
a28b fe 0d		                CP      CR 
a28d 28 09		                JR      Z,EXT_FTPLIST_070 
a28f 18 02		                JR      EXT_FTPLIST_060 
a291			EXT_FTPLIST_050: 
a291 3e 20		                LD      A,' ' 
a293			EXT_FTPLIST_060: 
a293 12			                LD      (DE),A 
a294 23			                INC     HL 
a295 13			                INC     DE 
a296 18 ee		                JR      EXT_FTPLIST_L020 
a298			EXT_FTPLIST_070: 
a298 cd ab ab		                CALL    MSG_DISP 
a29b db 09		                IN      A,(KEYBRD9) 
a29d 57			                LD      D,A 
a29e e6 01		                AND     00000001B 
a2a0 ca d2 a7		                JP      Z,EXT_END 
a2a3 7a			                LD      A,D 
a2a4 e6 80		                AND     10000000B 
a2a6 20 0d		                JR      NZ,EXT_FTPLIST_090 
a2a8			EXT_FTPLIST_080: 
a2a8 db 09		                IN      A,(KEYBRD9) 
a2aa 57			                LD      D,A 
a2ab e6 01		                AND     00000001B 
a2ad ca d2 a7		                JP      Z,EXT_END 
a2b0 7a			                LD      A,D 
a2b1 e6 80		                AND     10000000B 
a2b3 28 f3		                JR      Z,EXT_FTPLIST_080 
a2b5			EXT_FTPLIST_090: 
a2b5 2a 18 f2		                LD      HL,(LISTCNT) 
a2b8 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a2bc 13			                INC     DE 
a2bd ed 53 1a f2	                LD      (SELLISTNO),DE 
a2c1 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a2c4			                                        ; HL<DE : 0  1 
a2c4			                                        ; HL=DE : 1  0 
a2c4			                                        ; HL>DE : 0  0 
a2c4 c2 08 a2		                JP      NZ,EXT_FTPLIST_L010 
a2c7 c3 d2 a7		                JP      EXT_END 
a2ca			; 
a2ca			; 
a2ca			; 
a2ca			EXT_FTPGET: 
a2ca e5			                PUSH    HL 
a2cb cd 44 a9		                CALL    INIT_SIO 
a2ce da b6 a7		                JP      C,EXT_ERR5 
a2d1 21 40 f2		                LD      HL,DISPBUF_TOP 
a2d4 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a2d8 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a2dc 01 00 00		                LD      BC,0 
a2df cd 9f 30		                CALL    ROM_BIN2DECASC 
a2e2 21 92 ac		                LD      HL,TBL_EXT_FTPGET2 
a2e5 11 ce ed		                LD      DE,SNDBUF_TOP 
a2e8 01 07 00		                LD      BC,7 
a2eb ed b0		                LDIR 
a2ed 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a2f0 01 03 00		                LD      BC,3 
a2f3 ed b0		                LDIR 
a2f5 21 10 ad		                LD      HL,TBL_CRLF 
a2f8 01 02 00		                LD      BC,2 
a2fb ed b0		                LDIR 
a2fd 06 0c		                LD      B,12 
a2ff cd 53 ab		                CALL    SENDBUF_OUT 
a302 06 01		                LD      B,1 
a304 cd 5e ab		                CALL    RECVBUF_IN 
a307 3a ff f2		                LD      A,(FLGDATA) 
a30a e6 04		                AND     FLG_RCVTIMEOUT 
a30c c2 a2 a7		                JP      NZ,EXT_ERR1 
a30f 11 92 ac		                LD      DE,TBL_EXT_FTPGET2 
a312 06 06		                LD      B,6 
a314 cd 95 ab		                CALL    RECVBUF_CHK 
a317 da a7 a7		                JP      C,EXT_ERR2 
a31a			EXT_FTPGET_000: 
a31a 23			                INC     HL 
a31b 23			                INC     HL 
a31c 23			                INC     HL 
a31d 23			                INC     HL 
a31e 7e			                LD      A,(HL) 
a31f e6 0f		                AND     0FH 
a321 fe 00		                CP      0               ; ERROR 
a323 ca ac a7		                JP      Z,EXT_ERR3 
a326 fe 01		                CP      1               ; OK 
a328 ca 2e a3		                JP      Z,EXT_FTPGET_010 
a32b c3 a7 a7		                JP      EXT_ERR2 
a32e			EXT_FTPGET_010: 
a32e 23			                INC     HL 
a32f 23			                INC     HL 
a330 06 03		                LD      B,3 
a332 11 00 00		                LD      DE,0 
a335			EXT_FTPGET_020: 
a335 7e			                LD      A,(HL) 
a336 e5			                PUSH    HL 
a337 eb			                EX      DE,HL 
a338 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a33b eb			                EX      DE,HL 
a33c e1			                POP     HL 
a33d 23			                INC     HL 
a33e 10 f5		                DJNZ    EXT_FTPGET_020 
a340 ed 53 2a f2	                LD      (DIVICOUNT),DE 
a344 21 00 00		                LD      HL,0 
a347 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a34a			                                        ; HL<DE : 0  1 
a34a			                                        ; HL=DE : 1  0 
a34a			                                        ; HL>DE : 0  0 
a34a ca a7 a7		                JP      Z,EXT_ERR2 
a34d 23			                INC     HL 
a34e cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a351			                                        ; HL<DE : 0  1 
a351			                                        ; HL=DE : 1  0 
a351			                                        ; HL>DE : 0  0 
a351 28 05		                JR      Z,EXT_FTPGET_030 
a353 11 01 00		                LD      DE,1 
a356 18 03		                JR      EXT_FTPGET_040 
a358			EXT_FTPGET_030: 
a358 11 00 00		                LD      DE,0 
a35b			EXT_FTPGET_040: 
a35b ed 53 2c f2	                LD      (SELDIVINO),DE 
a35f			EXT_FTPGET_050: 
a35f 21 40 f2		                LD      HL,DISPBUF_TOP 
a362 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a366 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a36a 01 00 00		                LD      BC,0 
a36d cd 9f 30		                CALL    ROM_BIN2DECASC 
a370 21 45 f2		                LD      HL,DISPBUF_TOP + 5 
a373 ed 5b 2c f2	                LD      DE,(SELDIVINO) 
a377 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a37b 01 00 00		                LD      BC,0 
a37e cd 9f 30		                CALL    ROM_BIN2DECASC 
a381 21 9e ac		                LD      HL,TBL_EXT_GET 
a384 11 ce ed		                LD      DE,SNDBUF_TOP 
a387 01 04 00		                LD      BC,4 
a38a ed b0		                LDIR 
a38c 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a38f 01 03 00		                LD      BC,3 
a392 ed b0		                LDIR 
a394 3e 2c		                LD      A,',' 
a396 12			                LD      (DE),A 
a397 13			                INC     DE 
a398 21 47 f2		                LD      HL,DISPBUF_TOP + 7 
a39b 01 03 00		                LD      BC,3 
a39e ed b0		                LDIR 
a3a0 21 10 ad		                LD      HL,TBL_CRLF 
a3a3 01 02 00		                LD      BC,2 
a3a6 ed b0		                LDIR 
a3a8 06 0d		                LD      B,13 
a3aa cd 53 ab		                CALL    SENDBUF_OUT 
a3ad 06 01		                LD      B,1 
a3af cd 5e ab		                CALL    RECVBUF_IN 
a3b2 3a ff f2		                LD      A,(FLGDATA) 
a3b5 e6 04		                AND     FLG_RCVTIMEOUT 
a3b7 c2 a2 a7		                JP      NZ,EXT_ERR1 
a3ba 11 9e ac		                LD      DE,TBL_EXT_GET 
a3bd 06 03		                LD      B,3 
a3bf cd 95 ab		                CALL    RECVBUF_CHK 
a3c2 da a7 a7		                JP      C,EXT_ERR2 
a3c5 23			                INC     HL 
a3c6 23			                INC     HL 
a3c7 23			                INC     HL 
a3c8 23			                INC     HL 
a3c9 23			                INC     HL 
a3ca 23			                INC     HL 
a3cb 23			                INC     HL 
a3cc 23			                INC     HL 
a3cd 7e			                LD      A,(HL)          ; RESULT 
a3ce e6 0f		                AND     0FH 
a3d0 fe 00		                CP      0               ; ERROR 
a3d2 ca ac a7		                JP      Z,EXT_ERR3 
a3d5 fe 01		                CP      1               ; OK 
a3d7 ca dd a3		                JP      Z,EXT_FTPGET_060 
a3da c3 a7 a7		                JP      EXT_ERR2 
a3dd			EXT_FTPGET_060: 
a3dd 23			                INC     HL 
a3de 23			                INC     HL 
a3df 7e			                LD      A,(HL)          ; DATA TYPE 
a3e0			; 
a3e0 f5			                PUSH    AF 
a3e1 23			                INC     HL 
a3e2 23			                INC     HL 
a3e3 06 04		                LD      B,4 
a3e5 11 00 00		                LD      DE,0 
a3e8			EXT_FTPGET_L010: 
a3e8 7e			                LD      A,(HL) 
a3e9 e5			                PUSH    HL 
a3ea eb			                EX      DE,HL 
a3eb cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a3ee eb			                EX      DE,HL 
a3ef e1			                POP     HL 
a3f0 23			                INC     HL 
a3f1 10 f5		                DJNZ    EXT_FTPGET_L010 
a3f3 ed 53 1c f2	                LD      (LOADADRS),DE 
a3f7 23			                INC     HL 
a3f8 06 04		                LD      B,4 
a3fa 11 00 00		                LD      DE,0 
a3fd			EXT_FTPGET_L020: 
a3fd 7e			                LD      A,(HL) 
a3fe e5			                PUSH    HL 
a3ff eb			                EX      DE,HL 
a400 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a403 eb			                EX      DE,HL 
a404 e1			                POP     HL 
a405 23			                INC     HL 
a406 10 f5		                DJNZ    EXT_FTPGET_L020 
a408 ed 53 20 f2	                LD      (LOAD_ENDADRS),DE 
a40c 23			                INC     HL 
a40d 06 04		                LD      B,4 
a40f 11 00 00		                LD      DE,0 
a412			EXT_FTPGET_L030: 
a412 7e			                LD      A,(HL) 
a413 e5			                PUSH    HL 
a414 eb			                EX      DE,HL 
a415 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a418 eb			                EX      DE,HL 
a419 e1			                POP     HL 
a41a 23			                INC     HL 
a41b 10 f5		                DJNZ    EXT_FTPGET_L030 
a41d ed 53 2e f2	                LD      (EXECADRS2),DE 
a421 e5			                PUSH    HL 
a422 2a 20 f2		                LD      HL,(LOAD_ENDADRS) 
a425 ed 5b 1c f2	                LD      DE,(LOADADRS) 
a429 cd ad a8		                CALL    CLRCFRET 
a42c ed 52		                SBC     HL,DE 
a42e 23			                INC     HL         
a42f 22 22 f2		                LD      (LOADSIZE),HL 
a432 e1			                POP     HL 
a433 f1			                POP     AF 
a434			; 
a434 e6 0f		                AND     0FH 
a436 fe 00		                CP      0               ; ERROR 
a438 ca ac a7		                JP      Z,EXT_ERR3 
a43b fe 01		                CP      1               ; ANY BIN 
a43d ca 4b a4		                JP      Z,EXT_FTPGET_100 
a440 fe 02		                CP      2               ; BASIC BIN 
a442 28 25		                JR      Z,EXT_FTPGET_110 
a444 fe 03		                CP      3               ; Z80 BIN 
a446 28 31		                JR      Z,EXT_FTPGET_200 
a448 c3 a7 a7		                JP      EXT_ERR2 
a44b			EXT_FTPGET_100: 
a44b ed 5b 1e f2	                LD      DE,(EXECADRS) 
a44f e5			                PUSH    HL 
a450 21 00 00		                LD      HL,0 
a453 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a456			                                        ; HL<DE : 0  1 
a456			                                        ; HL=DE : 1  0 
a456			                                        ; HL>DE : 0  0 
a456 e1			                POP     HL 
a457 ca b1 a7		                JP      Z,EXT_ERR4 
a45a ed 53 1c f2	                LD      (LOADADRS),DE 
a45e d5			                PUSH    DE 
a45f 11 00 00		                LD      DE,0 
a462 ed 53 1e f2	                LD      (EXECADRS),DE 
a466 d1			                POP     DE 
a467 18 10		                JR      EXT_FTPGET_200 
a469			EXT_FTPGET_110: 
a469 3a ff f2		                LD      A,(FLGDATA) 
a46c f6 02		                OR      FLG_LOADBAS 
a46e 32 ff f2		                LD      (FLGDATA),A 
a471 ed 5b 54 eb	                LD      DE,(BASAREA_TOP) 
a475 ed 53 1c f2	                LD      (LOADADRS),DE 
a479			EXT_FTPGET_200: 
a479 3a ff f2		                LD      A,(FLGDATA) 
a47c f6 10		                OR      FLG_ENABLESTOP 
a47e 32 ff f2		                LD      (FLGDATA),A 
a481 3e 01		                LD      A,1 
a483 32 33 f2		                LD      (CHKBLKNO),A 
a486			EXT_FTPGET_L040: 
a486 af			                XOR     A 
a487 32 35 f2		                LD      (RCVBUF_RPOS),A 
a48a 32 36 f2		                LD      (RCVBUF_WPOS),A 
a48d 3e 15		                LD      A,NAK 
a48f cd 48 ab		                CALL    OUT_SIO 
a492			EXT_FTPGET_L050: 
a492 cd b7 aa		                CALL    IN_SIO 
a495 fe 04		                CP      EOT 
a497 ca 5f a5		                JP      Z,EXT_FTPGET_310 
a49a fe 01		                CP      SOH 
a49c 28 2f		                JR      Z,EXT_FTPGET_210 
a49e 3a ff f2		                LD      A,(FLGDATA) 
a4a1 e6 04		                AND     FLG_RCVTIMEOUT 
a4a3 20 e1		                JR      NZ,EXT_FTPGET_L040 
a4a5 3a ff f2		                LD      A,(FLGDATA) 
a4a8 e6 08		                AND     FLG_RCVCANCEL 
a4aa c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4ad 18 e3		                JR      EXT_FTPGET_L050 
a4af			EXT_FTPGET_L060: 
a4af cd b7 aa		                CALL    IN_SIO 
a4b2 fe 04		                CP      EOT 
a4b4 ca 5f a5		                JP      Z,EXT_FTPGET_310 
a4b7 fe 01		                CP      SOH 
a4b9 28 12		                JR      Z,EXT_FTPGET_210 
a4bb 3a ff f2		                LD      A,(FLGDATA) 
a4be e6 04		                AND     FLG_RCVTIMEOUT 
a4c0 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4c3 3a ff f2		                LD      A,(FLGDATA) 
a4c6 e6 08		                AND     FLG_RCVCANCEL 
a4c8 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4cb 18 e2		                JR      EXT_FTPGET_L060 
a4cd			EXT_FTPGET_210: 
a4cd cd b2 a8		                CALL    CLR_RCVBUF 
a4d0 77			                LD      (HL),A 
a4d1 23			                INC     HL 
a4d2 06 83		                LD      B,131 
a4d4			EXT_FTPGET_L070: 
a4d4 cd b7 aa		                CALL    IN_SIO 
a4d7 4f			                LD      C,A 
a4d8 3a ff f2		                LD      A,(FLGDATA) 
a4db e6 04		                AND     FLG_RCVTIMEOUT 
a4dd c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4e0 3a ff f2		                LD      A,(FLGDATA) 
a4e3 e6 08		                AND     FLG_RCVCANCEL 
a4e5 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4e8 79			                LD      A,C 
a4e9 77			                LD      (HL),A 
a4ea 23			                INC     HL 
a4eb 10 e7		                DJNZ    EXT_FTPGET_L070 
a4ed			; 
a4ed af			                XOR     A 
a4ee 32 35 f2		                LD      (RCVBUF_RPOS),A 
a4f1 32 36 f2		                LD      (RCVBUF_WPOS),A 
a4f4 cd af aa		                CALL    DISABLE_RTS 
a4f7 cd f1 a8		                CALL    CHK_RCVDATA 
a4fa 38 58		                JR      C,EXT_FTPGET_300 
a4fc d5			                PUSH    DE 
a4fd 2a 22 f2		                LD      HL,(LOADSIZE) 
a500 11 80 00		                LD      DE,128 
a503 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a506			                                        ; HL<DE : 0  1 
a506			                                        ; HL=DE : 1  0 
a506			                                        ; HL>DE : 0  0 
a506 38 02		                JR      C,EXT_FTPGET_220 
a508 d5			                PUSH    DE 
a509 e1			                POP     HL 
a50a			EXT_FTPGET_220: 
a50a e5			                PUSH    HL 
a50b c1			                POP     BC 
a50c d1			                POP     DE 
a50d cd c1 a8		                CALL    CHK_MEMOVER 
a510 da fd a5		                JP      C,EXT_FTPGET_CANCEL 
a513 c5			                PUSH    BC 
a514 21 d1 ed		                LD      HL,RCVBUF_DATA 
a517 f3			                DI 
a518 ed b0		                LDIR 
a51a 3a ff f2		                LD      A,(FLGDATA) 
a51d e6 20		                AND     FLG_EXECPC8001 
a51f 20 17		                JR      NZ,EXT_FTPGET_240 
a521 d5			                PUSH    DE 
a522 e5			                PUSH    HL 
a523 21 34 aa		                LD      HL,SIOIRQ_ENTRY 
a526 ed 5b 00 80	                LD      DE,(VECTOR_TBL_SIO) 
a52a cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a52d			                                        ; HL<DE : 0  1 
a52d			                                        ; HL=DE : 1  0 
a52d			                                        ; HL>DE : 0  0 
a52d 28 07		                JR      Z,EXT_FTPGET_230 
a52f ed 53 24 f2	                LD      (SAVESIOIRQ),DE 
a533 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
a536			EXT_FTPGET_230: 
a536 e1			                POP     HL 
a537 d1			                POP     DE 
a538			EXT_FTPGET_240: 
a538 fb			                EI 
a539 c1			                POP     BC 
a53a cd 1e a9		                CALL    DISP_PROGRESS 
a53d 2a 22 f2		                LD      HL,(LOADSIZE) 
a540 ed 42		                SBC     HL,BC 
a542 22 22 f2		                LD      (LOADSIZE),HL 
a545 cd a7 aa		                CALL    ENABLE_RTS 
a548			; 
a548 3e 06		                LD      A,ACK 
a54a cd 48 ab		                CALL    OUT_SIO         
a54d 21 33 f2		                LD      HL,CHKBLKNO 
a550 34			                INC     (HL) 
a551 c3 af a4		                JP      EXT_FTPGET_L060 
a554			EXT_FTPGET_300: 
a554 cd a7 aa		                CALL    ENABLE_RTS 
a557 3e 15		                LD      A,NAK 
a559 cd 48 ab		                CALL    OUT_SIO         
a55c c3 af a4		                JP      EXT_FTPGET_L060 
a55f			EXT_FTPGET_310: 
a55f 3e 06		                LD      A,ACK 
a561 cd 48 ab		                CALL    OUT_SIO 
a564 3a ff f2		                LD      A,(FLGDATA) 
a567 e6 02		                AND     FLG_LOADBAS 
a569 28 1a		                JR      Z,EXT_FTPGET_320 
a56b			EXT_FTPGET_FIXBAS: 
a56b d5			                PUSH    DE 
a56c 2a 1c f2		                LD      HL,(LOADADRS) 
a56f eb			                EX      DE,HL 
a570 ed 52		                SBC     HL,DE 
a572 e5			                PUSH    HL 
a573 c1			                POP     BC 
a574 e1			                POP     HL 
a575 af			                XOR     A 
a576 ed b9		                CPDR 
a578 23			                INC     HL 
a579 77			                LD      (HL),A 
a57a 23			                INC     HL 
a57b 77			                LD      (HL),A 
a57c 22 a0 ef		                LD      (VARAREA_TOP),  HL 
a57f 22 a2 ef		                LD      (ARRAYAREA_TOP),HL 
a582 22 a4 ef		                LD      (FREEAREA_TOP), HL 
a585			EXT_FTPGET_320: 
a585 2a 2c f2		                LD      HL,(SELDIVINO) 
a588 23			                INC     HL 
a589 22 2c f2		                LD      (SELDIVINO),HL 
a58c ed 5b 2a f2	                LD      DE,(DIVICOUNT) 
a590 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a593			                                        ; HL<DE : 0  1 
a593			                                        ; HL=DE : 1  0 
a593			                                        ; HL>DE : 0  0 
a593 28 18		                JR      Z,EXT_FTPGET_340 
a595 cd ca 5f		                CALL    ROM_DSPCRLF 
a598 cd 02 16		                CALL    ROM_TIMEREAD 
a59b 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
a59e 57			                LD      D,A 
a59f			EXT_FTPGET_330: 
a59f d5			                PUSH    DE 
a5a0 cd 02 16		                CALL    ROM_TIMEREAD 
a5a3 d1			                POP     DE 
a5a4 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
a5a7 ba			                CP      D 
a5a8 28 f5		                JR      Z,EXT_FTPGET_330 
a5aa c3 5f a3		                JP      EXT_FTPGET_050 
a5ad			EXT_FTPGET_340: 
a5ad 3e 01		                LD      A,1 
a5af cd ff a9		                CALL    TERM_SIO 
a5b2 e1			                POP     HL 
a5b3 e5			                PUSH    HL 
a5b4 21 00 00		                LD      HL,0 
a5b7 ed 5b 1e f2	                LD      DE,(EXECADRS) 
a5bb cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a5be			                                        ; HL<DE : 0  1 
a5be			                                        ; HL=DE : 1  0 
a5be			                                        ; HL>DE : 0  0 
a5be e1			                POP     HL 
a5bf 28 03		                JR      Z,EXT_FTPGET_350 
a5c1 c3 3f a0		                JP      EXT_DLEXEC_EXIT 
a5c4			EXT_FTPGET_350: 
a5c4 e5			                PUSH    HL 
a5c5 21 00 00		                LD      HL,0 
a5c8 ed 5b 2e f2	                LD      DE,(EXECADRS2) 
a5cc cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a5cf			                                        ; HL<DE : 0  1 
a5cf			                                        ; HL=DE : 1  0 
a5cf			                                        ; HL>DE : 0  0 
a5cf e1			                POP     HL 
a5d0 ca 34 a0		                JP      Z,EXT_EXIT 
a5d3 3a ff f2		                LD      A,(FLGDATA) 
a5d6 e6 02		                AND     FLG_LOADBAS 
a5d8 c2 e2 a5		                JP      NZ,EXT_FTPGET_360 
a5db ed 53 1e f2	                LD      (EXECADRS),DE 
a5df c3 3f a0		                JP      EXT_DLEXEC_EXIT 
a5e2			EXT_FTPGET_360: 
a5e2 e5			                PUSH    HL 
a5e3 21 b6 ac		                LD      HL,TBL_RUN 
a5e6 11 c0 ea		                LD      DE,FUNCKEY_DATA 
a5e9 01 05 00		                LD      BC,5 
a5ec ed b0		                LDIR 
a5ee 21 c0 ea		                LD      HL,FUNCKEY_DATA 
a5f1 22 c0 ed		                LD      (FUNCKEY_PTR),HL 
a5f4 21 68 ea		                LD      HL,FUNCKEY_FLAG 
a5f7 36 01		                LD      (HL),1 
a5f9 e1			                POP     HL 
a5fa c3 34 a0		                JP      EXT_EXIT 
a5fd			EXT_FTPGET_CANCEL: 
a5fd cd a7 aa		                CALL    ENABLE_RTS 
a600 3e 18		                LD      A,CAN 
a602 cd 48 ab		                CALL    OUT_SIO 
a605 cd ca 5f		                CALL    ROM_DSPCRLF 
a608 af			                XOR     A 
a609 32 49 eb		                LD      (OUTPUT_DEVICE),A 
a60c 3c			                INC     A 
a60d 32 64 ea		                LD      (CURSOR_XPOS),A 
a610 21 cd ab		                LD      HL,ERR_MSG_000 
a613 cd ed 52		                CALL    ROM_MSGOUT 
a616 cd 43 0d		                CALL    ROM_BEEP 
a619 af			                XOR     A 
a61a cd ff a9		                CALL    TERM_SIO 
a61d e1			                POP     HL 
a61e c3 37 a0		                JP      EXT_MYERR_EXIT 
a621			; 
a621			; 
a621			; 
a621			EXT_SNTP: 
a621 e5			                PUSH    HL 
a622 cd 44 a9		                CALL    INIT_SIO 
a625 da b6 a7		                JP      C,EXT_ERR5 
a628 21 63 ac		                LD      HL,TBL_EXT_SNTP 
a62b 11 ce ed		                LD      DE,SNDBUF_TOP 
a62e 01 04 00		                LD      BC,4 
a631 ed b0		                LDIR 
a633 21 10 ad		                LD      HL,TBL_CRLF 
a636 01 02 00		                LD      BC,2 
a639 ed b0		                LDIR 
a63b 06 06		                LD      B,6 
a63d cd 53 ab		                CALL    SENDBUF_OUT 
a640 06 01		                LD      B,1 
a642 cd 5e ab		                CALL    RECVBUF_IN 
a645 3a ff f2		                LD      A,(FLGDATA) 
a648 e6 04		                AND     FLG_RCVTIMEOUT 
a64a c2 a2 a7		                JP      NZ,EXT_ERR1 
a64d 11 63 ac		                LD      DE,TBL_EXT_SNTP 
a650 06 04		                LD      B,4 
a652 cd 95 ab		                CALL    RECVBUF_CHK 
a655 da a7 a7		                JP      C,EXT_ERR2 
a658 11 7b ea		                LD      DE,BCD_TIME_YEAR 
a65b 0e 00		                LD      C,0 
a65d 23			                INC     HL 
a65e 23			                INC     HL 
a65f			EXT_SNTP_L000: 
a65f 7e			                LD      A,(HL)          ; ASCII DECIMAL -> BCD 
a660 e6 0f		                AND     0FH 
a662 cb 27		                SLA     A 
a664 cb 27		                SLA     A 
a666 cb 27		                SLA     A 
a668 cb 27		                SLA     A 
a66a 47			                LD      B,A 
a66b 23			                INC     HL 
a66c 7e			                LD      A,(HL) 
a66d e6 0f		                AND     0FH 
a66f b0			                OR      B 
a670 47			                LD      B,A 
a671 79			                LD      A,C 
a672 fe 01		                CP      1               ; MONTH NOT BCD         
a674 20 19		                JR      NZ,EXT_SNTP_000 
a676 d5			                PUSH    DE              ; BCD -> BIN 
a677 e5			                PUSH    HL 
a678 78			                LD      A,B 
a679 e6 f0		                AND     0F0H 
a67b cb 2f		                SRA     A 
a67d cb 2f		                SRA     A 
a67f cb 2f		                SRA     A 
a681 cb 2f		                SRA     A 
a683 1e 0a		                LD      E,10                 
a685 cd be ab		                CALL    MUL_88_2_16 
a688 78			                LD      A,B 
a689 e6 0f		                AND     0FH 
a68b 85			                ADD     A,L 
a68c 47			                LD      B,A 
a68d e1			                POP     HL 
a68e d1			                POP     DE 
a68f			EXT_SNTP_000: 
a68f 78			                LD      A,B 
a690 12			                LD      (DE),A 
a691 23			                INC     HL 
a692 1b			                DEC     DE 
a693 7e			                LD      A,(HL) 
a694 fe 0d		                CP      CR 
a696 28 04		                JR      Z,EXT_SNTP_010 
a698 23			                INC     HL 
a699 0c			                INC     C 
a69a 18 c3		                JR      EXT_SNTP_L000 
a69c			EXT_SNTP_010: 
a69c cd 63 16		                CALL    ROM_TIMEWRITE 
a69f c3 d2 a7		                JP      EXT_END 
a6a2			; 
a6a2			; 
a6a2			; 
a6a2			EXT_SPIFFSLIST: 
a6a2 e5			                PUSH    HL 
a6a3 cd 44 a9		                CALL    INIT_SIO 
a6a6 da b6 a7		                JP      C,EXT_ERR5 
a6a9 21 a2 ac		                LD      HL,TBL_EXT_SPIFFSLIST2 
a6ac 11 ce ed		                LD      DE,SNDBUF_TOP 
a6af 01 0a 00		                LD      BC,10 
a6b2 ed b0		                LDIR 
a6b4 21 10 ad		                LD      HL,TBL_CRLF 
a6b7 01 02 00		                LD      BC,2 
a6ba ed b0		                LDIR 
a6bc 06 0c		                LD      B,12 
a6be cd 53 ab		                CALL    SENDBUF_OUT 
a6c1 06 01		                LD      B,1 
a6c3 cd 5e ab		                CALL    RECVBUF_IN 
a6c6 3a ff f2		                LD      A,(FLGDATA) 
a6c9 e6 04		                AND     FLG_RCVTIMEOUT 
a6cb c2 a2 a7		                JP      NZ,EXT_ERR1 
a6ce 11 a2 ac		                LD      DE,TBL_EXT_SPIFFSLIST2 
a6d1 06 0a		                LD      B,10 
a6d3 cd 95 ab		                CALL    RECVBUF_CHK 
a6d6 da a7 a7		                JP      C,EXT_ERR2 
a6d9 c3 a7 a1		                JP      EXT_FTPLIST_000 
a6dc			; 
a6dc			; 
a6dc			; 
a6dc			EXT_SPIFFSGET: 
a6dc e5			                PUSH    HL 
a6dd cd 44 a9		                CALL    INIT_SIO 
a6e0 da b6 a7		                JP      C,EXT_ERR5 
a6e3 21 40 f2		                LD      HL,DISPBUF_TOP 
a6e6 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a6ea ed 53 a8 f0	                LD      (BIN_ACC),DE 
a6ee 01 00 00		                LD      BC,0 
a6f1 cd 9f 30		                CALL    ROM_BIN2DECASC 
a6f4 21 ac ac		                LD      HL,TBL_EXT_SPIFFSGET2 
a6f7 11 ce ed		                LD      DE,SNDBUF_TOP 
a6fa 01 0a 00		                LD      BC,10 
a6fd ed b0		                LDIR 
a6ff 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a702 01 03 00		                LD      BC,3 
a705 ed b0		                LDIR 
a707 21 10 ad		                LD      HL,TBL_CRLF 
a70a 01 02 00		                LD      BC,2 
a70d ed b0		                LDIR 
a70f 06 0f		                LD      B,15 
a711 cd 53 ab		                CALL    SENDBUF_OUT 
a714 06 01		                LD      B,1 
a716 cd 5e ab		                CALL    RECVBUF_IN 
a719 3a ff f2		                LD      A,(FLGDATA) 
a71c e6 04		                AND     FLG_RCVTIMEOUT 
a71e c2 a2 a7		                JP      NZ,EXT_ERR1 
a721 11 ac ac		                LD      DE,TBL_EXT_SPIFFSGET2 
a724 06 09		                LD      B,9 
a726 cd 95 ab		                CALL    RECVBUF_CHK 
a729 da a7 a7		                JP      C,EXT_ERR2 
a72c c3 1a a3		                JP      EXT_FTPGET_000 
a72f			; 
a72f			; 
a72f			; 
a72f			EXT_VER: 
a72f e5			                PUSH    HL 
a730 cd 44 a9		                CALL    INIT_SIO 
a733 da b6 a7		                JP      C,EXT_ERR5 
a736 21 81 ac		                LD      HL,TBL_EXT_VER 
a739 11 ce ed		                LD      DE,SNDBUF_TOP 
a73c 01 03 00		                LD      BC,3 
a73f ed b0		                LDIR 
a741 21 10 ad		                LD      HL,TBL_CRLF 
a744 01 02 00		                LD      BC,2 
a747 ed b0		                LDIR 
a749 06 05		                LD      B,5 
a74b cd 53 ab		                CALL    SENDBUF_OUT 
a74e 06 01		                LD      B,1 
a750 cd 5e ab		                CALL    RECVBUF_IN 
a753 3a ff f2		                LD      A,(FLGDATA) 
a756 e6 04		                AND     FLG_RCVTIMEOUT 
a758 20 48		                JR      NZ,EXT_ERR1 
a75a 11 81 ac		                LD      DE,TBL_EXT_VER 
a75d 06 03		                LD      B,3 
a75f cd 95 ab		                CALL    RECVBUF_CHK 
a762 38 43		                JR      C,EXT_ERR2 
a764 e5			                PUSH    HL 
a765 21 e9 ac		                LD      HL,TBL_ESP32_VER 
a768 11 40 f2		                LD      DE,DISPBUF_TOP 
a76b			EXT_VER_L010: 
a76b 7e			                LD      A,(HL) 
a76c 12			                LD      (DE),A 
a76d 23			                INC     HL 
a76e 13			                INC     DE 
a76f fe 00		                CP      0 
a771 20 f8		                JR      NZ,EXT_VER_L010 
a773 e1			                POP     HL 
a774 1b			                DEC     DE 
a775			EXT_VER_L020: 
a775 7e			                LD      A,(HL) 
a776 fe 2c		                CP      ',' 
a778 28 06		                JR      Z,EXT_VER_010 
a77a fe 0d		                CP      CR 
a77c 28 09		                JR      Z,EXT_VER_030 
a77e 18 02		                JR      EXT_VER_020 
a780			EXT_VER_010: 
a780 3e 2e		                LD      A,'.' 
a782			EXT_VER_020: 
a782 12			                LD      (DE),A 
a783 23			                INC     HL 
a784 13			                INC     DE 
a785 18 ee		                JR      EXT_VER_L020 
a787			EXT_VER_030: 
a787 cd ab ab		                CALL    MSG_DISP 
a78a 21 fa ac		                LD      HL,TBL_SIO_VER 
a78d 11 40 f2		                LD      DE,DISPBUF_TOP 
a790			EXT_VER_L030: 
a790 7e			                LD      A,(HL) 
a791 12			                LD      (DE),A 
a792 23			                INC     HL 
a793 13			                INC     DE 
a794 fe 00		                CP      0 
a796 20 f8		                JR      NZ,EXT_VER_L030 
a798 cd ab ab		                CALL    MSG_DISP 
a79b 18 35		                JR      EXT_END 
a79d			; 
a79d			; 
a79d			; 
a79d			EXT_ERR0: 
a79d 21 cd ab		                LD      HL,ERR_MSG_000 
a7a0 18 17		                JR      EXT_ERR 
a7a2			EXT_ERR1: 
a7a2 21 db ab		                LD      HL,ERR_MSG_001 
a7a5 18 12		                JR      EXT_ERR 
a7a7			EXT_ERR2: 
a7a7 21 ec ab		                LD      HL,ERR_MSG_002 
a7aa 18 0d		                JR      EXT_ERR 
a7ac			EXT_ERR3: 
a7ac 21 06 ac		                LD      HL,ERR_MSG_003 
a7af 18 08		                JR      EXT_ERR 
a7b1			EXT_ERR4: 
a7b1 21 1c ac		                LD      HL,ERR_MSG_004 
a7b4 18 03		                JR      EXT_ERR 
a7b6			EXT_ERR5: 
a7b6 21 31 ac		                LD      HL,ERR_MSG_005 
a7b9			EXT_ERR: 
a7b9 af			                XOR     A 
a7ba 32 49 eb		                LD      (OUTPUT_DEVICE),A 
a7bd 3c			                INC     A 
a7be 32 64 ea		                LD      (CURSOR_XPOS),A 
a7c1 cd ed 52		                CALL    ROM_MSGOUT 
a7c4 cd ca 5f		                CALL    ROM_DSPCRLF 
a7c7 cd 43 0d		                CALL    ROM_BEEP 
a7ca af			                XOR     A 
a7cb cd ff a9		                CALL    TERM_SIO 
a7ce e1			                POP     HL 
a7cf c3 37 a0		                JP      EXT_MYERR_EXIT 
a7d2			EXT_END: 
a7d2 af			                XOR     A 
a7d3 cd ff a9		                CALL    TERM_SIO 
a7d6 e1			                POP     HL 
a7d7 c3 34 a0		                JP      EXT_EXIT 
a7da			; 
a7da			; 
a7da			; 
a7da			PARSER_EXTPARAM: 
a7da e5			                PUSH    HL 
a7db 21 00 00		                LD      HL,0 
a7de 22 1c f2		                LD      (LOADADRS),    HL 
a7e1 22 1e f2		                LD      (EXECADRS),    HL 
a7e4 22 20 f2		                LD      (LOAD_ENDADRS),HL 
a7e7 22 22 f2		                LD      (LOADSIZE),    HL 
a7ea af			                XOR     A 
a7eb 32 32 f2		                LD      (EXTNO),A 
a7ee 3a ff f2		                LD      A,(FLGDATA) 
a7f1 e6 fd		                AND     ~FLG_LOADBAS 
a7f3 e6 fb		                AND     ~FLG_RCVTIMEOUT 
a7f5 32 ff f2		                LD      (FLGDATA),A 
a7f8 e1			                POP     HL 
a7f9 11 46 ac		                LD      DE,TBL_EXT 
a7fc			PARSER_EXTPARAM_000: 
a7fc 1a			                LD      A,(DE) 
a7fd fe 00		                CP      0 
a7ff ca b0 a8		                JP      Z,SETCFRET 
a802 e5			                PUSH    HL 
a803			PARSER_EXTPARAM_010: 
a803 be			                CP      (HL) 
a804 20 09		                JR      NZ,PARSER_EXTPARAM_020 
a806 23			                INC     HL 
a807 13			                INC     DE 
a808 1a			                LD      A,(DE) 
a809 fe 00		                CP      0 
a80b 28 11		                JR      Z,PARSER_EXTPARAM_040 
a80d 18 f4		                JR      PARSER_EXTPARAM_010 
a80f			PARSER_EXTPARAM_020: 
a80f e1			                POP     HL 
a810			PARSER_EXTPARAM_030: 
a810 13			                INC     DE 
a811 1a			                LD      A,(DE) 
a812 fe 00		                CP      0 
a814 20 fa		                JR      NZ,PARSER_EXTPARAM_030 
a816 13			                INC     DE 
a817 13			                INC     DE 
a818 13			                INC     DE 
a819 13			                INC     DE 
a81a 13			                INC     DE 
a81b 13			                INC     DE 
a81c 18 de		                JR      PARSER_EXTPARAM_000 
a81e			PARSER_EXTPARAM_040: 
a81e 2b			                DEC     HL 
a81f 13			                INC     DE 
a820 1a			                LD      A,(DE) 
a821 32 32 f2		                LD      (EXTNO),A 
a824 13			                INC     DE 
a825 e5			                PUSH    HL 
a826 1a			                LD      A,(DE) 
a827 6f			                LD      L,A 
a828 13			                INC     DE 
a829 1a			                LD      A,(DE) 
a82a 67			                LD      H,A 
a82b e5			                PUSH    HL 
a82c dd e1		                POP     IX 
a82e 13			                INC     DE 
a82f 1a			                LD      A,(DE) 
a830 6f			                LD      L,A 
a831 13			                INC     DE 
a832 1a			                LD      A,(DE) 
a833 67			                LD      H,A 
a834 e5			                PUSH    HL 
a835 fd e1		                POP     IY 
a837 e1			                POP     HL 
a838 d1			                POP     DE 
a839 dd e9		                JP      (IX) 
a83b			PARSER_EXT_BME: 
a83b			PARSER_EXT_FTPLIST: 
a83b			PARSER_EXT_SNTP: 
a83b			PARSER_EXT_SPIFFSLIST: 
a83b			PARSER_EXT_VER: 
a83b 23			                INC     HL 
a83c 7e			                LD      A,(HL) 
a83d fe 00		                CP      0 
a83f 28 6c		                JR      Z,CLRCFRET 
a841 fe 3a		                CP      ':' 
a843 28 68		                JR      Z,CLRCFRET 
a845 18 69		                JR      SETCFRET 
a847			PARSER_EXT_FTPGET: 
a847			PARSER_EXT_SPIFFSGET: 
a847 cd 99 a8		                CALL    PARSER_SKIP 
a84a fe 0f		                CP      0FH             ; ID CODE 0FH : 1 byte hex 
a84c 28 17		                JR      Z,PARSER_EXT_FTPGET_210 
a84e fe 11		                CP      11H             ; ID CODE 11H -> 0, 12H -> 1, ... 19H -> 8, 1AH -> 9 
a850 28 0c		                JR      Z,PARSER_EXT_FTPGET_000 
a852 fe 1a		                CP      1AH 
a854 38 08		                JR      C,PARSER_EXT_FTPGET_000 
a856 28 06		                JR      Z,PARSER_EXT_FTPGET_000 
a858 fe 1c		                CP      1CH             ; ID CODE 0CH : 2 byte hex 
a85a 28 0f		                JR      Z,PARSER_EXT_FTPGET_300 
a85c 18 52		                JR      SETCFRET 
a85e			PARSER_EXT_FTPGET_000: 
a85e d6 11		                SUB     A,11H 
a860 5f			                LD      E,A 
a861 af			                XOR     A 
a862 57			                LD      D,A 
a863 18 0a		                JR      PARSER_EXT_FTPGET_310 
a865			PARSER_EXT_FTPGET_210: 
a865 23			                INC     HL 
a866 5e			                LD      E,(HL) 
a867 af			                XOR     A 
a868 57			                LD      D,A 
a869 18 04		                JR      PARSER_EXT_FTPGET_310 
a86b			PARSER_EXT_FTPGET_300: 
a86b 23			                INC     HL 
a86c 5e			                LD      E,(HL) 
a86d 23			                INC     HL 
a86e 56			                LD      D,(HL) 
a86f			PARSER_EXT_FTPGET_310: 
a86f ed 53 1a f2	                LD      (SELLISTNO),DE 
a873 23			                INC     HL 
a874 7e			                LD      A,(HL) 
a875 fe 00		                CP      0 
a877 28 34		                JR      Z,CLRCFRET 
a879 fe 3a		                CP      ':' 
a87b 28 30		                JR      Z,CLRCFRET 
a87d 2b			                DEC     HL 
a87e cd 99 a8		                CALL    PARSER_SKIP 
a881 fe 0c		                CP      0CH             ; ID CODE "&H" 
a883 20 2b		                JR      NZ,SETCFRET 
a885 23			                INC     HL 
a886 5e			                LD      E,(HL) 
a887 23			                INC     HL 
a888 56			                LD      D,(HL) 
a889 ed 53 1e f2	                LD      (EXECADRS),DE 
a88d 23			                INC     HL 
a88e 7e			                LD      A,(HL) 
a88f fe 00		                CP      0 
a891 28 1a		                JR      Z,CLRCFRET 
a893 fe 3a		                CP      ':' 
a895 28 16		                JR      Z,CLRCFRET 
a897 18 17		                JR      SETCFRET 
a899			PARSER_SKIP: 
a899 23			                INC     HL 
a89a 7e			                LD      A,(HL) 
a89b fe 20		                CP      ' ' 
a89d 28 fa		                JR      Z,PARSER_SKIP 
a89f fe 2c		                CP      ',' 
a8a1 28 03		                JR      Z,PARSER_SKIP_010 
a8a3 d1			                POP     DE 
a8a4 18 0a		                JR      SETCFRET 
a8a6			PARSER_SKIP_010: 
a8a6 23			                INC     HL 
a8a7 7e			                LD      A,(HL) 
a8a8 fe 20		                CP      ' ' 
a8aa 28 fa		                JR      Z,PARSER_SKIP_010 
a8ac c9			                RET 
a8ad			CLRCFRET: 
a8ad 37			                SCF 
a8ae 3f			                CCF 
a8af c9			                RET 
a8b0			SETCFRET: 
a8b0 37			                SCF 
a8b1 c9			                RET 
a8b2			; 
a8b2			; 
a8b2			; 
a8b2			CLR_RCVBUF: 
a8b2 21 ce ed		                LD      HL,RCVBUF_TOP 
a8b5 f5			                PUSH    AF 
a8b6 e5			                PUSH    HL 
a8b7 06 84		                LD      B,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
a8b9 af			                XOR     A 
a8ba			CLR_RCVBUF_L010: 
a8ba 77			                LD      (HL),A 
a8bb 23			                INC     HL 
a8bc 10 fc		                DJNZ    CLR_RCVBUF_L010 
a8be e1			                POP     HL 
a8bf f1			                POP     AF 
a8c0 c9			                RET 
a8c1			; 
a8c1			; 
a8c1			; 
a8c1			CHK_MEMOVER: 
a8c1 d5			                PUSH    DE 
a8c2 21 00 a0		                LD      HL,_PROG_TOP 
a8c5 11 00 80		                LD      DE,PC8001RAM_TOP 
a8c8 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8cb			                                        ; HL<DE : 0  1 
a8cb			                                        ; HL=DE : 1  0 
a8cb			                                        ; HL>DE : 0  0 
a8cb d1			                POP     DE 
a8cc 38 17		                JR      C,CHK_MEMOVER_010 
a8ce d5			                PUSH    DE 
a8cf eb			                EX      DE,HL 
a8d0 09			                ADD     HL,BC 
a8d1 11 00 a0		                LD      DE,_PROG_TOP 
a8d4 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8d7			                                        ; HL<DE : 0  1 
a8d7			                                        ; HL=DE : 1  0 
a8d7			                                        ; HL>DE : 0  0 
a8d7 d1			                POP     DE 
a8d8 38 0b		                JR      C,CHK_MEMOVER_010 
a8da d5			                PUSH    DE 
a8db eb			                EX      DE,HL 
a8dc 09			                ADD     HL,BC 
a8dd 11 12 ad		                LD      DE,_PROG_END 
a8e0 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8e3			                                        ; HL<DE : 0  1 
a8e3			                                        ; HL=DE : 1  0 
a8e3			                                        ; HL>DE : 0  0 
a8e3 d1			                POP     DE 
a8e4 d8			                RET     C 
a8e5			CHK_MEMOVER_010: 
a8e5 d5			                PUSH    DE 
a8e6 eb			                EX      DE,HL 
a8e7 09			                ADD     HL,BC 
a8e8 eb			                EX      DE,HL 
a8e9 2a 26 f2		                LD      HL,(ROM_WORKTOP) 
a8ec cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8ef			                                        ; HL<DE : 0  1 
a8ef			                                        ; HL=DE : 1  0 
a8ef			                                        ; HL>DE : 0  0 
a8ef d1			                POP     DE 
a8f0 c9			                RET 
a8f1			; 
a8f1			; 
a8f1			; 
a8f1			CHK_RCVDATA: 
a8f1 21 ce ed		                LD      HL,RCVBUF_TOP 
a8f4 7e			                LD      A,(HL) 
a8f5 fe 01		                CP      SOH 
a8f7 20 b7		                JR      NZ,SETCFRET 
a8f9 4f			                LD      C,A 
a8fa 23			                INC     HL 
a8fb 3a 33 f2		                LD      A,(CHKBLKNO) 
a8fe be			                CP      (HL) 
a8ff 20 af		                JR      NZ,SETCFRET 
a901 81			                ADD     A,C 
a902 4f			                LD      C,A 
a903 23			                INC     HL 
a904 3a 33 f2		                LD      A,(CHKBLKNO) 
a907 2f			                CPL 
a908 be			                CP      (HL) 
a909 20 a5		                JR      NZ,SETCFRET 
a90b 81			                ADD     A,C 
a90c 4f			                LD      C,A 
a90d 23			                INC     HL 
a90e 06 80		                LD      B,128 
a910			CHK_RCVDATA_L010: 
a910 7e			                LD      A,(HL) 
a911 81			                ADD     A,C 
a912 4f			                LD      C,A 
a913 23			                INC     HL 
a914 10 fa		                DJNZ    CHK_RCVDATA_L010 
a916 79			                LD      A,C 
a917 be			                CP      (HL) 
a918 c2 b0 a8		                JP      NZ,SETCFRET 
a91b c3 ad a8		                JP      CLRCFRET 
a91e			; 
a91e			; 
a91e			; 
a91e			DISP_PROGRESS: 
a91e c5			                PUSH    BC 
a91f d5			                PUSH    DE 
a920 e5			                PUSH    HL 
a921 3e 01		                LD      A,1 
a923 32 64 ea		                LD      (CURSOR_XPOS),A 
a926 3e 5b		                LD      A,'[' 
a928 cd 57 02		                CALL    ROM_DSPCHR 
a92b 2a 1c f2		                LD      HL,(LOADADRS) 
a92e cd c0 5e		                CALL    ROM_DSPHEX4 
a931 3e 2d		                LD      A,'-' 
a933 cd 57 02		                CALL    ROM_DSPCHR 
a936 eb			                EX      DE,HL 
a937 2b			                DEC     HL 
a938 cd c0 5e		                CALL    ROM_DSPHEX4 
a93b 3e 5d		                LD      A,']' 
a93d cd 57 02		                CALL    ROM_DSPCHR 
a940 e1			                POP     HL 
a941 d1			                POP     DE 
a942 c1			                POP     BC 
a943 c9			                RET 
a944			; 
a944			; 
a944			; 
a944			INIT_SIO: 
a944 cd 7f aa		                CALL    ENABLE_SIO 
a947 af			                XOR     A               ; DUMMY OUT 
a948 d3 21		                OUT     (USARTCW),A 
a94a d3 21		                OUT     (USARTCW),A 
a94c d3 21		                OUT     (USARTCW),A 
a94e 3e 40		                LD      A,01000000B     ; SOFT RESET 
a950 d3 21		                OUT     (USARTCW),A 
a952 3e 4e		                LD      A,01001110B     ; MODE SETUP                    : 8N11 
a954			                                        ; BAUD RATE FACTOR              : 16X 
a954			                                        ; CHARACTER LENGTH              : 8BITS 
a954			                                        ; PARITY ENABLE                 : DISABLE 
a954			                                        ; EVEN PARITY GENARATION/CHECK  : ODD 
a954			                                        ; NUMBER OF STOP BITS           : 1 BIT 
a954 d3 21		                OUT     (USARTCW),A 
a956 32 30 f2		                LD      (MODEWORD),A 
a959 3e 05		                LD      A,00000101B     ; COMMAND SETUP  TRANSMIT ENABLE 
a95b			                                        ;                DATA TERMINAL READY : FALSE 
a95b			                                        ;                RECEIVE ENABLE 
a95b			                                        ;                ERROR RESET         : FALSE 
a95b			                                        ;                REQUEST TO SEND     : FALSE 
a95b d3 21		                OUT     (USARTCW),A 
a95d 32 31 f2		                LD      (CTLWORD),A 
a960 cd 97 aa		                CALL    ENABLE_DTR 
a963 cd a7 aa		                CALL    ENABLE_RTS 
a966			INIT_SIO_000: 
a966 db 21		                IN      A,(USARTCW)     ; ESP32-WROOM-32 -> 8251 power-on receive dust removal support 
a968 57			                LD      D,A 
a969 e6 38		                AND     00111000B 
a96b 20 09		                JR      NZ,INIT_SIO_010 
a96d 7a			                LD      A,D 
a96e e6 02		                AND     00000010B 
a970 28 0d		                JR      Z,INIT_SIO_020 
a972 db 20		                IN      A,(USARTDW) 
a974 18 f0		                JR      INIT_SIO_000 
a976			INIT_SIO_010: 
a976 3a 31 f2		                LD      A,(CTLWORD) 
a979 f6 10		                OR      00010000B 
a97b d3 21		                OUT     (USARTCW),A 
a97d 18 e7		                JR      INIT_SIO_000 
a97f			INIT_SIO_020: 
a97f 3a ff f2		                LD      A,(FLGDATA) 
a982 e6 01		                AND     FLG_FIRSTSEND 
a984 20 18		                JR      NZ,INIT_SIO_030 
a986 11 ce ed		                LD      DE,SNDBUF_TOP   ; 8251 -> ESP32-WROOM-32 power-on send dust removal support 
a989 21 10 ad		                LD      HL,TBL_CRLF 
a98c 01 02 00		                LD      BC,2 
a98f ed b0		                LDIR 
a991 06 02		                LD      B,2 
a993 cd 53 ab		                CALL    SENDBUF_OUT 
a996 3a ff f2		                LD      A,(FLGDATA) 
a999 f6 01		                OR      FLG_FIRSTSEND 
a99b 32 ff f2		                LD      (FLGDATA),A 
a99e			INIT_SIO_030: 
a99e 21 00 ea		                LD      HL,NROM_WORKTOP 
a9a1 22 26 f2		                LD      (ROM_WORKTOP),HL 
a9a4 21 00 00		                LD      HL,0 
a9a7 22 24 f2		                LD      (SAVESIOIRQ),HL 
a9aa af			                XOR     A 
a9ab 32 35 f2		                LD      (RCVBUF_RPOS),A 
a9ae 32 36 f2		                LD      (RCVBUF_WPOS),A 
a9b1 3a ff f2		                LD      A,(FLGDATA) 
a9b4 e6 ef		                AND     ~FLG_ENABLESTOP 
a9b6 e6 df		                AND     ~FLG_EXECPC8001 
a9b8 32 ff f2		                LD      (FLGDATA),A 
a9bb 3a 5f 17		                LD      A,(ROM_PC8001CHK) 
a9be fe 80		                CP      80H             ; N-BASIC IMPLEMENTED IN PC-8001 
a9c0 28 07		                JR      Z,INIT_SIO_100 
a9c2 fe af		                CP      0AFH            ; N-BASIC IMPLEMENTED IN PC-8001mkII 
a9c4 28 0d		                JR      Z,INIT_SIO_200 
a9c6 c3 b0 a8		                JP      SETCFRET 
a9c9			INIT_SIO_100: 
a9c9 3a ff f2		                LD      A,(FLGDATA) 
a9cc f6 20		                OR      FLG_EXECPC8001 
a9ce 32 ff f2		                LD      (FLGDATA),A 
a9d1 18 29		                JR      INIT_SIO_900 
a9d3			INIT_SIO_200: 
a9d3 2a fd f0		                LD      HL,(CMD_ENTRY + 1) 
a9d6 11 30 e7		                LD      DE,PC8001MK2_N80MODE 
a9d9 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a9dc			                                        ; HL<DE : 0  1 
a9dc			                                        ; HL=DE : 1  0 
a9dc			                                        ; HL>DE : 0  0 
a9dc 28 02		                JR      Z,INIT_SIO_210 
a9de 18 06		                JR      INIT_SIO_220 
a9e0			INIT_SIO_210: 
a9e0 21 00 e6		                LD      HL,N80ROM_WORKTOP 
a9e3 22 26 f2		                LD      (ROM_WORKTOP),HL 
a9e6			INIT_SIO_220: 
a9e6 2a 00 80		                LD      HL,(VECTOR_TBL_SIO) 
a9e9 22 24 f2		                LD      (SAVESIOIRQ),HL 
a9ec f3			                DI 
a9ed 21 34 aa		                LD      HL,SIOIRQ_ENTRY 
a9f0 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
a9f3 3e 07		                LD      A,7 
a9f5 d3 e4		                OUT     (INTLEVEL),A 
a9f7 3e 04		                LD      A,00000100B     ; bit2 : /RxMF USART    IRQ ENABLE 
a9f9			                                        ; bit1 : /VRMF VRTC     IRQ DISABLE 
a9f9			                                        ; bit0 : /RTMF INTERVAL IRQ DISABLE 
a9f9 d3 e6		                OUT     (INTMASK),A 
a9fb fb			                EI 
a9fc			INIT_SIO_900: 
a9fc c3 ad a8		                JP      CLRCFRET 
a9ff			 
a9ff			; 
a9ff			; A :  0 no wait term sio 
a9ff			;   : !0 1sec wait term sio 
a9ff			; 
a9ff			TERM_SIO: 
a9ff d5			                PUSH    DE 
aa00 fe 00		                CP      0 
aa02 28 12		                JR      Z,TERM_SIO_020 
aa04 cd 02 16		                CALL    ROM_TIMEREAD 
aa07 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
aa0a 57			                LD      D,A 
aa0b			TERM_SIO_010: 
aa0b d5			                PUSH    DE 
aa0c cd 02 16		                CALL    ROM_TIMEREAD 
aa0f d1			                POP     DE 
aa10 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
aa13 ba			                CP      D 
aa14 28 f5		                JR      Z,TERM_SIO_010 
aa16			TERM_SIO_020: 
aa16 3a ff f2		                LD      A,(FLGDATA) 
aa19 e6 20		                AND     FLG_EXECPC8001 
aa1b 20 0c		                JR      NZ,TERM_SIO_030 
aa1d f3			                DI 
aa1e 2a 24 f2		                LD      HL,(SAVESIOIRQ) 
aa21 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
aa24 3e 00		                LD      A,00000000B     ; bit2 : /RxMF USART    IRQ DISABLE 
aa26			                                        ; bit1 : /VRMF VRTC     IRQ DISABLE 
aa26			                                        ; bit0 : /RTMF INTERVAL IRQ DISABLE 
aa26 d3 e6		                OUT     (INTMASK),A 
aa28 fb			                EI 
aa29			TERM_SIO_030: 
aa29 cd af aa		                CALL    DISABLE_RTS 
aa2c cd 9f aa		                CALL    DISABLE_DTR 
aa2f cd 8c aa		                CALL    DISABLE_SIO 
aa32 d1			                POP     DE 
aa33 c9			                RET 
aa34			; 
aa34			; 
aa34			; 
aa34			SIOIRQ_ENTRY: 
aa34 f3			                DI 
aa35 08			                EX      AF,AF' 
aa36 d9			                EXX 
aa37 3a 55 ea		                LD      A,(LAST_INTLEVEL) 
aa3a f5			                PUSH    AF 
aa3b			; 
aa3b 3e 07		                LD      A,7 
aa3d d3 e4		                OUT     (INTLEVEL),     A 
aa3f 32 55 ea		                LD      (LAST_INTLEVEL),A 
aa42 32 56 ea		                LD      (FLG_INTEXEC),  A 
aa45			; 
aa45			SIOIRQ_010: 
aa45 db 21		                IN      A,(USARTCW) 
aa47 57			                LD      D,A 
aa48 e6 38		                AND     00111000B 
aa4a 20 23		                JR      NZ,SIOIRQ_030 
aa4c 7a			                LD      A,D 
aa4d e6 02		                AND     00000010B 
aa4f 28 27		                JR      Z,SIOIRQ_EXIT 
aa51			; 
aa51 3a 36 f2		                LD      A,(RCVBUF_WPOS) 
aa54 21 ce ed		                LD      HL,RCVBUF_TOP 
aa57 06 00		                LD      B,0 
aa59 4f			                LD      C,A 
aa5a 09			                ADD     HL,BC 
aa5b db 20		                IN      A,(USARTDW) 
aa5d 77			                LD      (HL),A 
aa5e 0c			                INC     C 
aa5f 79			                LD      A,C 
aa60 06 84		                LD      B,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
aa62 b8			                CP      B 
aa63 20 04		                JR      NZ,SIOIRQ_020 
aa65 38 02		                JR      C,SIOIRQ_020 
aa67 0e 00		                LD      C,0 
aa69			SIOIRQ_020: 
aa69 79			                LD      A,C 
aa6a 32 36 f2		                LD      (RCVBUF_WPOS),A 
aa6d 18 09		                JR      SIOIRQ_EXIT 
aa6f			SIOIRQ_030: 
aa6f 3a 31 f2		                LD      A,(CTLWORD) 
aa72 f6 10		                OR      00010000B 
aa74 d3 21		                OUT     (USARTCW),A 
aa76 18 cd		                JR      SIOIRQ_010 
aa78			SIOIRQ_EXIT: 
aa78			; 
aa78 f1			                POP     AF 
aa79 d3 e4		                OUT     (INTLEVEL),A 
aa7b d9			                EXX 
aa7c 08			                EX      AF,AF' 
aa7d fb			                EI 
aa7e c9			                RET 
aa7f			; 
aa7f			; 
aa7f			; 
aa7f			ENABLE_SIO: 
aa7f 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
aa82 e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
aa84 f6 20		                OR      00100000B       ; BS2 ON 
aa86 d3 30		                OUT     (CONTROL1),A 
aa88 32 66 ea		                LD      (CTL1_OUTDATA),A 
aa8b c9			                RET 
aa8c			; 
aa8c			; 
aa8c			; 
aa8c			DISABLE_SIO: 
aa8c 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
aa8f e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
aa91 d3 30		                OUT     (CONTROL1),A 
aa93 32 66 ea		                LD      (CTL1_OUTDATA),A 
aa96 c9			                RET 
aa97			; 
aa97			; 
aa97			; 
aa97			ENABLE_DTR: 
aa97 3a 31 f2		                LD      A,(CTLWORD) 
aa9a f6 02		                OR      00000010B       ; DATA TERMINAL READY : TRUE 
aa9c d3 21		                OUT     (USARTCW),A 
aa9e c9			                RET 
aa9f			; 
aa9f			; 
aa9f			; 
aa9f			DISABLE_DTR: 
aa9f 3a 31 f2		                LD      A,(CTLWORD) 
aaa2 e6 fd		                AND     11111101B       ; DATA TERMINAL READY : FALSE 
aaa4 d3 21		                OUT     (USARTCW),A 
aaa6 c9			                RET 
aaa7			; 
aaa7			; 
aaa7			; 
aaa7			ENABLE_RTS: 
aaa7 3a 31 f2		                LD      A,(CTLWORD) 
aaaa f6 20		                OR      00100000B       ; REQUEST TO SEND : TRUE 
aaac d3 21		                OUT     (USARTCW),A 
aaae c9			                RET 
aaaf			; 
aaaf			; 
aaaf			; 
aaaf			DISABLE_RTS: 
aaaf 3a 31 f2		                LD      A,(CTLWORD) 
aab2 e6 df		                AND     11011111B       ; REQUEST TO SEND : FALSE 
aab4 d3 21		                OUT     (USARTCW),A 
aab6 c9			                RET 
aab7			; 
aab7			; 
aab7			; 
aab7			IN_SIO: 
aab7 3a ff f2		                LD      A,(FLGDATA) 
aaba e6 fb		                AND     ~FLG_RCVTIMEOUT 
aabc e6 f7		                AND     ~FLG_RCVCANCEL 
aabe 32 ff f2		                LD      (FLGDATA),A 
aac1 c5			                PUSH    BC 
aac2 d5			                PUSH    DE 
aac3 e5			                PUSH    HL 
aac4 21 03 00		                LD      HL,3            ; 5000msec Timer 
aac7 01 00 0a		                LD      BC,0A00H 
aaca			IN_SIO_010: 
aaca 3a ff f2		                LD      A,(FLGDATA) 
aacd e6 10		                AND     FLG_ENABLESTOP 
aacf 28 06		                JR      Z,IN_SIO_020 
aad1 db 09		                IN      A,(KEYBRD9) 
aad3 e6 01		                AND     00000001B 
aad5 28 60		                JR      Z,IN_SIO_080 
aad7			IN_SIO_020: 
aad7 3a ff f2		                LD      A,(FLGDATA) 
aada e6 20		                AND     FLG_EXECPC8001 
aadc 20 23		                JR      NZ,IN_SIO_040 
aade			; 
aade 3a 35 f2		                LD      A,(RCVBUF_RPOS) 
aae1 5f			                LD      E,A 
aae2 3a 36 f2		                LD      A,(RCVBUF_WPOS) 
aae5 bb			                CP      E 
aae6 ca 16 ab		                JP      Z,IN_SIO_060 
aae9 21 ce ed		                LD      HL,RCVBUF_TOP 
aaec 16 00		                LD      D,0 
aaee 19			                ADD     HL,DE 
aaef 1c			                INC     E 
aaf0 7b			                LD      A,E 
aaf1 16 84		                LD      D,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
aaf3 ba			                CP      D 
aaf4 20 04		                JR      NZ,IN_SIO_030 
aaf6 38 02		                JR      C,IN_SIO_030 
aaf8 1e 00		                LD      E,0 
aafa			IN_SIO_030: 
aafa 7b			                LD      A,E 
aafb 32 35 f2		                LD      (RCVBUF_RPOS),A 
aafe 7e			                LD      A,(HL) 
aaff 18 43		                JR      IN_SIO_100 
ab01			; 
ab01			IN_SIO_040: 
ab01 db 21		                IN      A,(USARTCW) 
ab03 57			                LD      D,A 
ab04 e6 38		                AND     00111000B 
ab06 20 07		                JR      NZ,IN_SIO_050 
ab08 7a			                LD      A,D 
ab09 e6 02		                AND     00000010B 
ab0b 20 35		                JR      NZ,IN_SIO_090 
ab0d 18 07		                JR      IN_SIO_060 
ab0f			IN_SIO_050: 
ab0f 3a 31 f2		                LD      A,(CTLWORD) 
ab12 f6 10		                OR      00010000B 
ab14 d3 21		                OUT     (USARTCW),A 
ab16			IN_SIO_060: 
ab16 0b			                DEC     BC 
ab17 79			                LD      A,C 
ab18 fe 00		                CP      0 
ab1a 20 ae		                JR      NZ,IN_SIO_010 
ab1c 78			                LD      A,B 
ab1d fe 00		                CP      0 
ab1f 20 a9		                JR      NZ,IN_SIO_010 
ab21 2b			                DEC     HL 
ab22 7d			                LD      A,L 
ab23 fe 00		                CP      0 
ab25 20 a3		                JR      NZ,IN_SIO_010 
ab27 7c			                LD      A,H 
ab28 fe 00		                CP      0 
ab2a 20 9e		                JR      NZ,IN_SIO_010 
ab2c			IN_SIO_070: 
ab2c 3a ff f2		                LD      A,(FLGDATA) 
ab2f f6 04		                OR      FLG_RCVTIMEOUT 
ab31 32 ff f2		                LD      (FLGDATA),A 
ab34 af			                XOR     A 
ab35 18 0d		                JR      IN_SIO_100 
ab37			IN_SIO_080: 
ab37 3a ff f2		                LD      A,(FLGDATA) 
ab3a f6 08		                OR      FLG_RCVCANCEL 
ab3c 32 ff f2		                LD      (FLGDATA),A 
ab3f af			                XOR     A 
ab40 18 02		                JR      IN_SIO_100 
ab42			IN_SIO_090: 
ab42 db 20		                IN      A,(USARTDW) 
ab44			IN_SIO_100: 
ab44 e1			                POP     HL 
ab45 d1			                POP     DE 
ab46 c1			                POP     BC 
ab47 c9			                RET 
ab48			; 
ab48			; 
ab48			; 
ab48			OUT_SIO: 
ab48 f5			                PUSH    AF 
ab49			OUT_SIO_000: 
ab49 db 21		                IN      A,(USARTCW) 
ab4b e6 01		                AND     00000001B 
ab4d 28 fa		                JR      Z,OUT_SIO_000 
ab4f f1			                POP     AF 
ab50 d3 20		                OUT     (USARTDW),A 
ab52 c9			                RET 
ab53			; 
ab53			; 
ab53			; 
ab53			SENDBUF_OUT: 
ab53 21 ce ed		                LD      HL,SNDBUF_TOP 
ab56			SENDBUF_OUT_000: 
ab56 7e			                LD      A,(HL) 
ab57 cd 48 ab		                CALL    OUT_SIO 
ab5a 23			                INC     HL 
ab5b 10 f9		                DJNZ    SENDBUF_OUT_000 
ab5d c9			                RET 
ab5e			; 
ab5e			; 
ab5e			; 
ab5e			RECVBUF_IN: 
ab5e 78			                LD      A,B 
ab5f 32 34 f2		                LD      (LFRECVCOUNT),A 
ab62 21 ce ed		                LD      HL,RCVBUF_TOP 
ab65			RECVBUF_IN_000: 
ab65 cd b7 aa		                CALL    IN_SIO 
ab68 c5			                PUSH    BC 
ab69 47			                LD      B,A 
ab6a 3a ff f2		                LD      A,(FLGDATA) 
ab6d e6 04		                AND     FLG_RCVTIMEOUT 
ab6f 78			                LD      A,B 
ab70 c1			                POP     BC 
ab71 20 08		                JR      NZ,RECVBUF_IN_020                 
ab73 77			                LD      (HL),A 
ab74 fe 0a		                CP      LF 
ab76 28 15		                JR      Z,RECVBUF_IN_030 
ab78			RECVBUF_IN_010: 
ab78 23			                INC     HL 
ab79 18 ea		                JR      RECVBUF_IN_000 
ab7b			RECVBUF_IN_020: 
ab7b 3a 34 f2		                LD      A,(LFRECVCOUNT) 
ab7e 4f			                LD      C,A 
ab7f 78			                LD      A,B 
ab80 b9			                CP      C 
ab81 28 11		                JR      Z,RECVBUF_IN_040 
ab83 3a ff f2		                LD      A,(FLGDATA) 
ab86 e6 fb		                AND     ~FLG_RCVTIMEOUT 
ab88 32 ff f2		                LD      (FLGDATA),A 
ab8b 18 07		                JR      RECVBUF_IN_040 
ab8d			RECVBUF_IN_030: 
ab8d 05			                DEC     B 
ab8e af			                XOR     A 
ab8f b8			                CP      B 
ab90 28 02		                JR      Z,RECVBUF_IN_040 
ab92 18 e4		                JR      RECVBUF_IN_010 
ab94			RECVBUF_IN_040: 
ab94 c9			                RET 
ab95			; 
ab95			; 
ab95			; 
ab95			RECVBUF_CHK: 
ab95 21 ce ed		                LD      HL,RCVBUF_TOP 
ab98			RECVBUF_CHK_000: 
ab98 1a			                LD      A,(DE) 
ab99 be			                CP      (HL) 
ab9a c2 b0 a8		                JP      NZ,SETCFRET 
ab9d 23			                INC     HL 
ab9e 13			                INC     DE 
ab9f 10 f7		                DJNZ    RECVBUF_CHK_000 
aba1 3e 3a		                LD      A,':' 
aba3 be			                CP      (HL) 
aba4 c2 b0 a8		                JP      NZ,SETCFRET 
aba7 23			                INC     HL 
aba8 c3 ad a8		                JP      CLRCFRET 
abab			; 
abab			; 
abab			; 
abab			MSG_DISP: 
abab af			                XOR     A 
abac 12			                LD      (DE),A 
abad 32 49 eb		                LD      (OUTPUT_DEVICE),A 
abb0 3c			                INC     A 
abb1 32 64 ea		                LD      (CURSOR_XPOS),A 
abb4 21 40 f2		                LD      HL,DISPBUF_TOP 
abb7 cd ed 52		                CALL    ROM_MSGOUT 
abba cd ca 5f		                CALL    ROM_DSPCRLF 
abbd c9			                RET 
abbe			; 
abbe			; D = 0 
abbe			; HL = E * A 
abbe			; 
abbe			MUL_88_2_16: 
abbe 16 00		                LD      D,0 
abc0 21 00 00		                LD      HL,0 
abc3 06 08		                LD      B,8 
abc5			MUL_L000: 
abc5 29			                ADD     HL,HL 
abc6 87			                ADD     A,A 
abc7 30 01		                JR      NC,MUL_000 
abc9 19			                ADD     HL,DE 
abca			MUL_000: 
abca 10 f9		                DJNZ    MUL_L000 
abcc c9			                RET 
abcd			; 
abcd			; 
abcd			; 
abcd .. 00		ERR_MSG_000:    DB      "abort receive", 0 
abdb .. 00		ERR_MSG_001:    DB      "receive time out", 0 
abec .. 00		ERR_MSG_002:    DB      "received command mismatch", 0 
ac06 .. 00		ERR_MSG_003:    DB      "ftp/spiffs get failed", 0 
ac1c .. 00		ERR_MSG_004:    DB      "load address not set", 0 
ac31 .. 00		ERR_MSG_005:    DB      "not support hardware", 0 
ac46			TBL_EXT: 
ac46 .. 00 01		TBL_EXT_BME:    DB      "BME",       0, 1 
ac4b 3b a8		                DW      PARSER_EXT_BME 
ac4d c9 a0		                DW      EXT_BME 
ac4f .. 93 00 02	TBL_EXT_FTPLIST:DB      "FTP", 93H,  0, 2       ; reserve code 93H : "LIST" 
ac55 3b a8		                DW      PARSER_EXT_FTPLIST 
ac57 70 a1		                DW      EXT_FTPLIST 
ac59 .. c7 00 03	TBL_EXT_FTPGET: DB      "FTP", 0C7H, 0, 3       ; reserve code C7H : "GET" 
ac5f 47 a8		                DW      PARSER_EXT_FTPGET 
ac61 ca a2		                DW      EXT_FTPGET 
ac63 .. 00 04		TBL_EXT_SNTP:   DB      "SNTP",      0, 4 
ac69 3b a8		                DW      PARSER_EXT_SNTP 
ac6b 21 a6		                DW      EXT_SNTP 
ac6d			TBL_EXT_SPIFFSLIST: 
ac6d .. 93 00 05	                DB      "SPI", 93H,  0, 5    ; reserve code 93H : "LIST" 
ac73 3b a8		                DW      PARSER_EXT_SPIFFSLIST 
ac75 a2 a6		                DW      EXT_SPIFFSLIST 
ac77			TBL_EXT_SPIFFSGET: 
ac77 .. c7 00 06	                DB      "SPI", 0C7H, 0, 6    ; reserve code C7H : "GET" 
ac7d 47 a8		                DW      PARSER_EXT_FTPGET 
ac7f dc a6		                DW      EXT_SPIFFSGET 
ac81 .. 00 07		TBL_EXT_VER:    DB      "VER",       0, 7 
ac86 3b a8		                DW      PARSER_EXT_VER 
ac88 2f a7		                DW      EXT_VER 
ac8a 00			                DB      0 
ac8b			TBL_EXT_FTPLIST2: 
ac8b ..			                DB      "FTPLIST" 
ac92 ..			TBL_EXT_FTPGET2:DB      "FTPGET:" 
ac99 ..			TBL_EXT_LIST:   DB      "LIST:" 
ac9e ..			TBL_EXT_GET:    DB      "GET:" 
aca2			TBL_EXT_SPIFFSLIST2: 
aca2 ..			                DB      "SPIFFSLIST" 
acac			TBL_EXT_SPIFFSGET2: 
acac ..			                DB      "SPIFFSGET:" 
acb6 .. 0d 00		TBL_RUN:        DB      "RUN", 0DH, 0 
acbb .. 00		TBL_COUNT_MSG0: DB      "file count: ", 0 
acc8 .. 00		TBL_TEMP_MSG0:  DB      "temp : ", 0 
acd0 df 43 00		TBL_TEMP_MSG1:  DB      0DFH, "C", 0 
acd3 .. 00		TBL_HUMI_MSG0:  DB      "humi : ", 0 
acdb .. 00		TBL_HUMI_MSG1:  DB      "%", 0 
acdd .. 00		TBL_PRESS_MSG0: DB      "press: ", 0 
ace5 .. 00		TBL_PRESS_MSG1: DB      "hPa", 0 
ace9 .. 00		TBL_ESP32_VER:  DB      "esp32 firmware v", 0 
acfa .. 31 2e 30 2e 32 00	TBL_SIO_VER:    DB      "sio   firmware v", 30H + VER_MAJOR, ".", 30H + VER_MINOR, ".", 30H + VER_REVISION, 0 
ad10 0d 0a		TBL_CRLF:       DB      CR, LF 
ad12			                ;END 
ad12			 
# End of file esp32pc8001sio.asm
ad12			_PROG_END: 
ad12			                END 
			

# End of file esp32pc8001sio_ram.asm
ad12
