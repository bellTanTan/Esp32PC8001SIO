# File esp32pc8001sio_ram.asm
0000			                ORG     0A000H 
a000			_PROG_TOP: 
a000			_MON_ENTRY: 
a000 cd 10 a0		                CALL    _ENTRY 
a003 c3 81 00		                JP      ROM_BASPROMPT 
a006 00			                NOP 
a007 00			                NOP 
a008 00			                NOP 
a009 00			                NOP 
a00a 00			                NOP 
a00b 00			                NOP 
a00c 00			                NOP 
a00d 01			                DB      VER_MAJOR 
a00e 00			                DB      VER_MINOR 
a00f 03			                DB      VER_REVISION 
a010			_ENTRY: 
a010 cd 55 a0		                CALL    ENTRY_SETUP 
a013 c9			                RET 
a014			NEWJPTBL: 
a014 c3 17 a0		                JP      NEW_CMD 
a017			NEW_CMD: 
a017			                INCLUDE "esp32pc8001sio.asm" 
a017			;******************************************************************************** 
a017			; 
a017			; Created by tan (trinity09181718@gmail.com) 
a017			; Copyright (c) 2022 tan 
a017			; All rights reserved. 
a017			; 
a017			; Please contact trinity09181718@gmail.com if you need a commercial license. 
a017			; This software is available under GPL v3. 
a017			; 
a017			;******************************************************************************** 
a017			; 
a017			; Implementation contents as N-BASIC command extension 
a017			; 
a017			; CMD BME 
a017			; CMD FTPLIST 
a017			; CMD FTPGET,nnn 
a017			; CMD FTPGET,nnn,&hXXXX 
a017			; CMD SNTP 
a017			; CMD SPILIST 
a017			; CMD SPIGET,nnn 
a017			; CMD SPIGET,nnn,&hXXXX 
a017			; CMD VER 
a017			; 
a017			; Implementation contents as N80-BASIC command extension 
a017			; 
a017			; MAT BME 
a017			; MAT FTPLIST 
a017			; MAT FTPGET,nnn 
a017			; MAT FTPGET,nnn,&hXXXX 
a017			; MAT SNTP 
a017			; MAT SPILIST 
a017			; MAT SPIGET,nnn 
a017			; MAT SPIGET,nnn,&hXXXX 
a017			; MAT VER 
a017			; 
a017			;******************************************************************************** 
a017			; 更新履歴 
a017			; 2022/12/10 v1.0.3 cmd sntp or mat sntp で月が10月と定義されてしまう不具合改修 
a017			; 2022/10/10 v1.0.2 PC-8001mkIIにてRS-232C受信割込テーブル位置(8000H,8001H)を書換え 
a017			;                   られるタイプのバイナリ受信処理対応(確認不足) 
a017			;                   (cmt Planet Taizer:8000H~E7FFHが顕著) 
a017			;                   多段ロード形式cmtファイル対応 
a017			; 2022/10/01 v1.0.1 spiffs関連実装 
a017			;                   PC-8001とPC-8001mkIIのboot判定とフックコマンドの切り替え 
a017			;                   PC-8001mkII RS-232C 受信割込9600bps実装 
a017			;                   cmd ftpget or mat ftpget or cmd spiget or mat spigetにて 
a017			;                   PC-8001時EA00H or PC-8001mkII E600H 以上に入りこむメモリー 
a017			;                   オーバー判定と受信不良の不具合改修 
a017			;                   (cmt Scramble:C010H~E9FFHが顕著) 
a017			;                   cmd sntp or mat sntp で月がBCDとして設定されてしまう不具合改修 
a017			; 2022/09/17 v1.0.0 リリース 
a017			; 2022/08/07 v1.0.0 GitHub 公開 
a017			;******************************************************************************** 
a017			; 
a017			; CONSTANT CONTROL CODE 
a017			; 
a017			NUL:            EQU     00H 
a017			SOH:            EQU     01H 
a017			STX:            EQU     02H 
a017			EOT:            EQU     04H 
a017			ACK:            EQU     06H 
a017			BS:             EQU     08H 
a017			LF:             EQU     0AH 
a017			CR:             EQU     0DH 
a017			NAK:            EQU     15H 
a017			CAN:            EQU     18H 
a017			ESC:            EQU     1BH 
a017			; 
a017			; CONSTANT I/O PORT 
a017			; 
a017			KEYBRD9:        EQU     09H 
a017			USARTDW:        EQU     20H 
a017			USARTCW:        EQU     21H             ; MODE SETUP 
a017			                                        ; 76543210 
a017			                                        ; ||||||++--- BAUD RATE FACTOR 
a017			                                        ; ||||||      00 : SYNC MODE 
a017			                                        ; ||||||      01 : 1X 
a017			                                        ; ||||||      10 : 16X 
a017			                                        ; ||||||      11 : 64X 
a017			                                        ; ||||++----- CHARACTER LENGTH 
a017			                                        ; ||||        00 : 5BITS 
a017			                                        ; ||||        01 : 6BITS 
a017			                                        ; ||||        10 : 7BITS 
a017			                                        ; ||||        11 : 8BITS 
a017			                                        ; |||+------- PARITY ENABLE 
a017			                                        ; |||         1 : ENABLE 
a017			                                        ; |||         0 : DISABLE 
a017			                                        ; ||+-------- EVEN PARITY GENARATION/CHECK 
a017			                                        ; ||          1 : EVEN 
a017			                                        ; ||          0 : ODD 
a017			                                        ; ++--------- NUMBER OF STOP BITS 
a017			                                        ;             00 : INVALID 
a017			                                        ;             01 : 1 BIT 
a017			                                        ;             10 : 1.5 BITS 
a017			                                        ;             11 : 2 BITS 
a017			                                        ; 
a017			                                        ; COMMAND SETUP 
a017			                                        ; 76543210 
a017			                                        ; |||||||+--- TRANSMIT ENABLE 
a017			                                        ; |||||||     1 : ENABLE 
a017			                                        ; |||||||     0 : DISABLE 
a017			                                        ; ||||||+---- DATA TERMINAL READY 
a017			                                        ; ||||||      "high" will force ~DTR output zero 
a017			                                        ; |||||+----- RECEIVE ENABLE 
a017			                                        ; |||||       1 : ENABLE 
a017			                                        ; |||||       0 : DISABLE 
a017			                                        ; ||||+------ SEND BREAK CHARACTER 
a017			                                        ; ||||        1 : forces TxD "low" 
a017			                                        ; ||||        0 : normal operation 
a017			                                        ; |||+------- ERROR RESET 
a017			                                        ; |||         1 : reset all error flags PE,OE,FE 
a017			                                        ; ||+-------- REQUEST TO SEND 
a017			                                        ; ||          "high" will force ~RTS output zero 
a017			                                        ; |+--------- INTERNAL RESET 
a017			                                        ; |           "high" returns USART to Mode Instruction Format 
a017			                                        ; +---------- ENTER HUNT MODE 
a017			                                        ;             1 = enable search for Sync Characters 
a017			                                        ; 
a017			                                        ; STATUS READ 
a017			                                        ; 76543210 
a017			                                        ; |||||||+--- TxRDY 
a017			                                        ; ||||||+---- RxRDY 
a017			                                        ; |||||+----- TxEMPTY 
a017			                                        ; ||||+------ PE(PARITY ERROR) 
a017			                                        ; |||+------- OE(OVERRUN ERROR) 
a017			                                        ; ||+-------- FE(FRAMING ERROR) 
a017			                                        ; |+--------- SYNDET 
a017			                                        ; +---------- DSR 
a017			CONTROL1:       EQU     30H 
a017			INTLEVEL:       EQU     0E4H 
a017			INTMASK:        EQU     0E6H 
a017			; 
a017			; CONSTANT PC-8001mkII ROM BASIC CMD ENTRY 
a017			; 
a017			PC8001MK2_NMODE:        EQU     1875H 
a017			PC8001MK2_N80MODE:      EQU     0E730H 
a017			; 
a017			; CONSTANT ROM BASIC ROUTINE 
a017			; 
a017			ROM_BASPROMPT:  EQU     0081H 
a017			ROM_DSPCHR:     EQU     0257H 
a017			ROM_MOVECURSOR: EQU     03A9H 
a017			ROM_DSPCURSOR:  EQU     0BE2H 
a017			ROM_BEEP:       EQU     0D43H 
a017			ROM_KEYWAIT:    EQU     0F75H 
a017			ROM_KEYSCAN:    EQU     0FACH 
a017			ROM_TIMEREAD:   EQU     1602H 
a017			ROM_TIMEWRITE:  EQU     1663H 
a017			ROM_PC8001CHK:  EQU     175FH 
a017			ROM_BIN2DECASC: EQU     309FH 
a017			ROM_SYNERR:     EQU     3BDFH 
a017			ROM_MSGOUT:     EQU     52EDH 
a017			ROM_MON_UNEXT:  EQU     5C35H 
a017			ROM_HEXASC2BIN: EQU     5E4BH 
a017			ROM_DSPHEX4:    EQU     5EC0H 
a017			ROM_CMPHLDE:    EQU     5ED3H 
a017			ROM_DSP1CHR:    EQU     5FB0H 
a017			ROM_DSPCRLF:    EQU     5FCAH 
a017			; 
a017			; CONSTANT ROM BASIC WORK AREA 
a017			; 
a017			PC8001RAM_TOP:  EQU     8000H 
a017			VECTOR_TBL_SIO: EQU     8000H 
a017			N80ROM_WORKTOP: EQU     0E600H 
a017			NROM_WORKTOP:   EQU     0EA00H 
a017			LAST_INTLEVEL:  EQU     0EA55H 
a017			FLG_INTEXEC:    EQU     0EA56H 
a017			FUNKEY_DISPSTS: EQU     0EA60H 
a017			CRT_TEXT_ROWS:  EQU     0EA62H 
a017			CURSOR_YPOS:    EQU     0EA63H 
a017			CURSOR_XPOS:    EQU     0EA64H 
a017			CRT_TEXT_COLS:  EQU     0EA65H 
a017			CTL1_OUTDATA:   EQU     0EA66H 
a017			FUNCKEY_FLAG:   EQU     0EA68H 
a017			BCD_TIME_SEC:   EQU     0EA76H 
a017			BCD_TIME_YEAR:  EQU     0EA7BH 
a017			FUNCKEY_DATA:   EQU     0EAC0H 
a017			OUTPUT_DEVICE:  EQU     0EB49H 
a017			BASAREA_TOP:    EQU     0EB54H 
a017			FUNCKEY_PTR:    EQU     0EDC0H 
a017			RS232C_CH1BUF:  EQU     0EDCEH                  ; AREA DS 128 
a017			RS232C_CH2BUF:  EQU     0EE4EH                  ; AREA DS 128 
a017			VARAREA_TOP:    EQU     0EFA0H 
a017			ARRAYAREA_TOP:  EQU     0EFA2H 
a017			FREEAREA_TOP:   EQU     0EFA4H 
a017			BIN_ACC:        EQU     0F0A8H 
a017			CMD_ENTRY:      EQU     0F0FCH 
a017			MAT_ENTRY:      EQU     0F111H 
a017			; 
a017			; N-BASIC ROM FREE AREA1 : F216~F2FF 
a017			; N-BASIC ROM FREE AREA2 : FF3D~FFFF 
a017			; CONSTANT ESP32PC8001SIO WORK AREA 
a017			; 
a017			SAVESP:         EQU     0F216H                  ; WORD DW 
a017			LISTCNT:        EQU     0F218H                  ; WORD DW 
a017			SELLISTNO:      EQU     0F21AH                  ; WORD DW 
a017			LOADADRS:       EQU     0F21CH                  ; WORD DW 
a017			EXECADRS:       EQU     0F21EH                  ; WORD DW 
a017			LOAD_ENDADRS:   EQU     0F220H                  ; WORD DW    
a017			LOADSIZE:       EQU     0F222H                  ; WORD DW 
a017			SAVESIOIRQ:     EQU     0F224H                  ; WORD DW 
a017			ROM_WORKTOP:    EQU     0F226H                  ; WORD DW 
a017			EXT_ENTRY:      EQU     0F228H                  ; WORD DW 
a017			DIVICOUNT:      EQU     0F22AH                  ; WORD DW 
a017			SELDIVINO:      EQU     0F22CH                  ; WORD DW 
a017			EXECADRS2:      EQU     0F22EH                  ; WORD DW 
a017			MODEWORD:       EQU     0F230H                  ; BYTE DB 
a017			CTLWORD:        EQU     0F231H                  ; BYTE DB 
a017			EXTNO:          EQU     0F232H                  ; BYTE DB 
a017			CHKBLKNO:       EQU     0F233H                  ; BYTE DB 
a017			LFRECVCOUNT:    EQU     0F234H                  ; BYTE DB 
a017			RCVBUF_RPOS:    EQU     0F235H                  ; BYTE DB 
a017			RCVBUF_WPOS:    EQU     0F236H                  ; BYTE DB 
a017			SAVE_ENTRY:     EQU     0F237H                  ; AREA DS 3 
a017			DISPBUF_TOP:    EQU     0F240H                  ; AREA DS 
a017			FLGDATA:        EQU     0F2FFH                  ; BYTE DB       76543210 
a017			                                                ;               |||||||+--- <CR><LF> first send 
a017			                                                ;               ||||||+---- load basic cmt type        
a017			                                                ;               |||||+----- sio recv time out (5sec) 
a017			                                                ;               ||||+------ sio recv cancel (keyboard STOP key) 
a017			                                                ;               |||+------- enable keyboard STOP key check 
a017			                                                ;               ||+-------- exec machine PC-8001 
a017			                                                ;               |+--------- reserve 
a017			                                                ;               +---------- reserve 
a017			FLG_FIRSTSEND:  EQU     00000001B 
a017			FLG_LOADBAS:    EQU     00000010B 
a017			FLG_RCVTIMEOUT: EQU     00000100B 
a017			FLG_RCVCANCEL:  EQU     00001000B 
a017			FLG_ENABLESTOP: EQU     00010000B 
a017			FLG_EXECPC8001: EQU     00100000B 
a017			; 
a017			SNDBUF_TOP:     EQU     RS232C_CH1BUF           ; AREA DS 
a017			RCVBUF_TOP:     EQU     RS232C_CH1BUF           ; AREA DS 
a017			RCVBUF_HEADER:  EQU     RS232C_CH1BUF           ; BYTE DB 
a017			RCVBUF_BLKNO:   EQU     RS232C_CH1BUF +1        ; BYTE DB 
a017			RCVBUF_CBLKNO:  EQU     RS232C_CH1BUF +2        ; BYTE DB 
a017			RCVBUF_DATA:    EQU     RS232C_CH1BUF +3        ; AREA DS 
a017			RCVBUF_CHKSUM:  EQU     RCVBUF_DATA +128        ; BYTE DB 
a017			RCVBUF_BOTTOM:  EQU     RCVBUF_CHKSUM           ; BYTE DB 
a017			; 
a017			; CONSTANT ESP32PC8001SIO VERSION DATA 
a017			; 
a017			VER_MAJOR:      EQU     1 
a017			VER_MINOR:      EQU     0 
a017			VER_REVISION:   EQU     3 
a017			; 
a017			                ;ORG    0H 
a017			; 
a017			; 
a017			; 
a017			EXT_START:                                      ; SP RETURN ADRS 
a017 c5			                PUSH    BC 
a018 d5			                PUSH    DE 
a019 cd dc a7		                CALL    PARSER_EXTPARAM 
a01c d1			                POP     DE 
a01d c1			                POP     BC 
a01e 38 0e		                JR      C,EXT_NON 
a020 f3			                DI 
a021 ed 73 16 f2	                LD      (SAVESP),SP 
a025 eb			                EX      DE,HL 
a026 21 ff ff		                LD      HL,0FFFFH 
a029 f9			                LD      SP,HL 
a02a eb			                EX      DE,HL 
a02b fb			                EI 
a02c fd e9		                JP      (IY) 
a02e			EXT_NON: 
a02e dd 2a 38 f2	                LD      IX,(SAVE_ENTRY + 1)     ; IX -> ORIGINAL ENTRY 
a032			                                                ; STACK DATA RETURN ADRS HOLD 
a032 dd e9		                JP      (IX)                    ; JUMP ORIGINAL ENTRY 
a034			EXT_EXIT: 
a034 af			                XOR     A 
a035 18 0e		                JR      EXT_010 
a037			EXT_MYERR_EXIT: 
a037 3e 01		                LD      A,1 
a039 dd 21 81 00	                LD      IX,ROM_BASPROMPT        ; IX -> (SP) RETURN ADRS 
a03d 18 06		                JR      EXT_010 
a03f			EXT_DLEXEC_EXIT: 
a03f 3e 02		                LD      A,2 
a041 dd 2a 1e f2	                LD      IX,(EXECADRS)           ; IX -> (SP) RETURN ADRS 
a045			EXT_010: 
a045 f3			                DI 
a046 eb			                EX      DE,HL 
a047 2a 16 f2		                LD      HL,(SAVESP) 
a04a f9			                LD      SP,HL 
a04b eb			                EX      DE,HL 
a04c fb			                EI 
a04d fe 00		                CP      0 
a04f c8			                RET     Z 
a050 f3			                DI 
a051 dd e3		                EX      (SP),IX                 ; STACK DATA RETURN ADRS CHANGE         
a053 fb			                EI 
a054 c9			                RET 
a055			; 
a055			; 
a055			; 
a055			ENTRY_SETUP: 
a055 c5			                PUSH    BC 
a056 d5			                PUSH    DE 
a057 e5			                PUSH    HL 
a058 af			                XOR     A 
a059 32 ff f2		                LD      (FLGDATA),A 
a05c 21 00 00		                LD      HL,0 
a05f 22 28 f2		                LD      (EXT_ENTRY),HL 
a062 3a 5f 17		                LD      A,(ROM_PC8001CHK) 
a065 fe 80		                CP      80H             ; N-BASIC IMPLEMENTED IN PC-8001 
a067 28 11		                JR      Z,ENTRY_SETUP_020 
a069 fe af		                CP      0AFH            ; N-BASIC IMPLEMENTED IN PC-8001mkII 
a06b 28 02		                JR      Z,ENTRY_SETUP_010 
a06d 18 56		                JR      ENTRY_SETUP_080 
a06f			ENTRY_SETUP_010: 
a06f 2a fd f0		                LD      HL,(CMD_ENTRY + 1) 
a072 11 30 e7		                LD      DE,PC8001MK2_N80MODE 
a075 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a078			                                        ; HL<DE : 0  1 
a078			                                        ; HL=DE : 1  0 
a078			                                        ; HL>DE : 0  0 
a078 28 08		                JR      Z,ENTRY_SETUP_030 
a07a			ENTRY_SETUP_020: 
a07a 21 fc f0		                LD      HL,CMD_ENTRY 
a07d 22 28 f2		                LD      (EXT_ENTRY),HL 
a080 18 06		                JR      ENTRY_SETUP_040 
a082			ENTRY_SETUP_030: 
a082 21 11 f1		                LD      HL,MAT_ENTRY 
a085 22 28 f2		                LD      (EXT_ENTRY),HL 
a088			ENTRY_SETUP_040: 
a088 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a08b 11 14 a0		                LD      DE,NEWJPTBL 
a08e 06 03		                LD      B,3 
a090			ENTRY_SETUP_L010: 
a090 4e			                LD      C,(HL) 
a091 1a			                LD      A,(DE) 
a092 b9			                CP      C 
a093 20 06		                JR      NZ,ENTRY_SETUP_050 
a095 23			                INC     HL 
a096 13			                INC     DE 
a097 10 f7		                DJNZ    ENTRY_SETUP_L010 
a099 18 2a		                JR      ENTRY_SETUP_080 
a09b			ENTRY_SETUP_050: 
a09b 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a09e 11 37 f2		                LD      DE,SAVE_ENTRY 
a0a1 06 03		                LD      B,3 
a0a3			ENTRY_SETUP_L020: 
a0a3 4e			                LD      C,(HL) 
a0a4 1a			                LD      A,(DE) 
a0a5 b9			                CP      C 
a0a6 20 06		                JR      NZ,ENTRY_SETUP_060 
a0a8 23			                INC     HL 
a0a9 13			                INC     DE 
a0aa 10 f7		                DJNZ    ENTRY_SETUP_L020 
a0ac 18 0b		                JR      ENTRY_SETUP_070 
a0ae			ENTRY_SETUP_060: 
a0ae 2a 28 f2		                LD      HL,(EXT_ENTRY) 
a0b1 11 37 f2		                LD      DE,SAVE_ENTRY 
a0b4 01 03 00		                LD      BC,3 
a0b7 ed b0		                LDIR 
a0b9			ENTRY_SETUP_070: 
a0b9 21 14 a0		                LD      HL,NEWJPTBL 
a0bc ed 5b 28 f2	                LD      DE,(EXT_ENTRY) 
a0c0 01 03 00		                LD      BC,3 
a0c3 ed b0		                LDIR 
a0c5			ENTRY_SETUP_080: 
a0c5 e1			                POP     HL 
a0c6 d1			                POP     DE 
a0c7 c1			                POP     BC 
a0c8 c9			                RET 
a0c9			; 
a0c9			; 
a0c9			; 
a0c9			EXT_BME: 
a0c9 e5			                PUSH    HL 
a0ca cd 46 a9		                CALL    INIT_SIO 
a0cd da b8 a7		                JP      C,EXT_ERR5 
a0d0 21 48 ac		                LD      HL,TBL_EXT_BME 
a0d3 11 ce ed		                LD      DE,SNDBUF_TOP 
a0d6 01 03 00		                LD      BC,3 
a0d9 ed b0		                LDIR 
a0db 21 12 ad		                LD      HL,TBL_CRLF 
a0de 01 02 00		                LD      BC,2 
a0e1 ed b0		                LDIR 
a0e3 06 05		                LD      B,5 
a0e5 cd 55 ab		                CALL    SENDBUF_OUT 
a0e8 06 01		                LD      B,1 
a0ea cd 60 ab		                CALL    RECVBUF_IN 
a0ed 3a ff f2		                LD      A,(FLGDATA) 
a0f0 e6 04		                AND     FLG_RCVTIMEOUT 
a0f2 c2 a4 a7		                JP      NZ,EXT_ERR1 
a0f5 11 48 ac		                LD      DE,TBL_EXT_BME 
a0f8 06 03		                LD      B,3 
a0fa cd 97 ab		                CALL    RECVBUF_CHK 
a0fd da a9 a7		                JP      C,EXT_ERR2 
a100 06 00		                LD      B,0 
a102 cd 12 a1		                CALL    EXT_BME_MSG 
a105 06 01		                LD      B,1 
a107 cd 12 a1		                CALL    EXT_BME_MSG 
a10a 06 02		                LD      B,2 
a10c cd 12 a1		                CALL    EXT_BME_MSG 
a10f c3 d4 a7		                JP      EXT_END 
a112			EXT_BME_MSG: 
a112 e5			                PUSH    HL 
a113 78			                LD      A,B 
a114 fe 01		                CP      1 
a116 28 09		                JR      Z,EXT_BME_000 
a118 fe 02		                CP      2 
a11a 28 0a		                JR      Z,EXT_BME_010 
a11c 21 ca ac		                LD      HL,TBL_TEMP_MSG0 
a11f 18 08		                JR      EXT_BME_020 
a121			EXT_BME_000: 
a121 21 d5 ac		                LD      HL,TBL_HUMI_MSG0 
a124 18 03		                JR      EXT_BME_020 
a126			EXT_BME_010: 
a126 21 df ac		                LD      HL,TBL_PRESS_MSG0 
a129			EXT_BME_020: 
a129 11 40 f2		                LD      DE,DISPBUF_TOP 
a12c			EXT_BME_L010: 
a12c 7e			                LD      A,(HL) 
a12d 12			                LD      (DE),A 
a12e 23			                INC     HL 
a12f 13			                INC     DE 
a130 fe 00		                CP      0 
a132 20 f8		                JR      NZ,EXT_BME_L010 
a134 e1			                POP     HL 
a135 1b			                DEC     DE 
a136			EXT_BME_L020: 
a136 7e			                LD      A,(HL) 
a137 fe 2c		                CP      ',' 
a139 28 09		                JR      Z,EXT_BME_050 
a13b fe 0d		                CP      CR 
a13d 28 05		                JR      Z,EXT_BME_050 
a13f 12			                LD      (DE),A 
a140 23			                INC     HL 
a141 13			                INC     DE 
a142 18 f2		                JR      EXT_BME_L020 
a144			EXT_BME_050: 
a144 23			                INC     HL 
a145 e5			                PUSH    HL 
a146 78			                LD      A,B 
a147 fe 01		                CP      1 
a149 28 09		                JR      Z,EXT_BME_060 
a14b fe 02		                CP      2 
a14d 28 0a		                JR      Z,EXT_BME_070 
a14f 21 d2 ac		                LD      HL,TBL_TEMP_MSG1 
a152 18 08		                JR      EXT_BME_L030 
a154			EXT_BME_060: 
a154 21 dd ac		                LD      HL,TBL_HUMI_MSG1 
a157 18 03		                JR      EXT_BME_L030 
a159			EXT_BME_070: 
a159 21 e7 ac		                LD      HL,TBL_PRESS_MSG1 
a15c			EXT_BME_L030: 
a15c 7e			                LD      A,(HL) 
a15d 12			                LD      (DE),A 
a15e 23			                INC     HL 
a15f 13			                INC     DE 
a160 fe 00		                CP      0 
a162 20 f8		                JR      NZ,EXT_BME_L030 
a164 e1			                POP     HL 
a165 1b			                DEC     DE 
a166 c5			                PUSH    BC 
a167 d5			                PUSH    DE 
a168 e5			                PUSH    HL 
a169 cd ad ab		                CALL    MSG_DISP 
a16c e1			                POP     HL 
a16d d1			                POP     DE 
a16e c1			                POP     BC 
a16f c9			                RET 
a170			; 
a170			; 
a170			; 
a170			EXT_FTPLIST: 
a170 e5			                PUSH    HL 
a171 cd 46 a9		                CALL    INIT_SIO 
a174 da b8 a7		                JP      C,EXT_ERR5 
a177 21 8d ac		                LD      HL,TBL_EXT_FTPLIST2 
a17a 11 ce ed		                LD      DE,SNDBUF_TOP 
a17d 01 07 00		                LD      BC,7 
a180 ed b0		                LDIR 
a182 21 12 ad		                LD      HL,TBL_CRLF 
a185 01 02 00		                LD      BC,2 
a188 ed b0		                LDIR 
a18a 06 09		                LD      B,9 
a18c cd 55 ab		                CALL    SENDBUF_OUT 
a18f 06 01		                LD      B,1 
a191 cd 60 ab		                CALL    RECVBUF_IN 
a194 3a ff f2		                LD      A,(FLGDATA) 
a197 e6 04		                AND     FLG_RCVTIMEOUT 
a199 c2 a4 a7		                JP      NZ,EXT_ERR1 
a19c 11 8d ac		                LD      DE,TBL_EXT_FTPLIST2 
a19f 06 07		                LD      B,7 
a1a1 cd 97 ab		                CALL    RECVBUF_CHK 
a1a4 da a9 a7		                JP      C,EXT_ERR2 
a1a7			EXT_FTPLIST_000: 
a1a7 e5			                PUSH    HL 
a1a8 21 bd ac		                LD      HL,TBL_COUNT_MSG0 
a1ab 11 40 f2		                LD      DE,DISPBUF_TOP 
a1ae			EXT_FTPLIST_L000: 
a1ae 7e			                LD      A,(HL) 
a1af 12			                LD      (DE),A 
a1b0 23			                INC     HL 
a1b1 13			                INC     DE 
a1b2 fe 00		                CP      0 
a1b4 20 f8		                JR      NZ,EXT_FTPLIST_L000 
a1b6 1b			                DEC     DE 
a1b7 e1			                POP     HL 
a1b8 e5			                PUSH    HL 
a1b9 01 03 00		                LD      BC,3 
a1bc ed b0		                LDIR 
a1be cd ad ab		                CALL    MSG_DISP 
a1c1 e1			                POP     HL 
a1c2			; 
a1c2 7e			                LD      A,(HL) 
a1c3 e6 0f		                AND     0FH 
a1c5 5f			                LD      E,A 
a1c6 3e 64		                LD      A,100 
a1c8 e5			                PUSH    HL 
a1c9 cd c0 ab		                CALL    MUL_88_2_16 
a1cc 22 18 f2		                LD      (LISTCNT),HL 
a1cf e1			                POP     HL 
a1d0 23			                INC     HL 
a1d1 7e			                LD      A,(HL) 
a1d2 e6 0f		                AND     0FH 
a1d4 5f			                LD      E,A 
a1d5 3e 0a		                LD      A,10 
a1d7 e5			                PUSH    HL 
a1d8 cd c0 ab		                CALL    MUL_88_2_16 
a1db eb			                EX      DE,HL 
a1dc 2a 18 f2		                LD      HL,(LISTCNT) 
a1df 19			                ADD     HL,DE 
a1e0 22 18 f2		                LD      (LISTCNT),HL 
a1e3 e1			                POP     HL 
a1e4 23			                INC     HL 
a1e5 7e			                LD      A,(HL) 
a1e6 e6 0f		                AND     0FH 
a1e8 5f			                LD      E,A 
a1e9 3e 01		                LD      A,1 
a1eb e5			                PUSH    HL 
a1ec cd c0 ab		                CALL    MUL_88_2_16 
a1ef eb			                EX      DE,HL 
a1f0 2a 18 f2		                LD      HL,(LISTCNT) 
a1f3 19			                ADD     HL,DE 
a1f4 22 18 f2		                LD      (LISTCNT),HL 
a1f7 e1			                POP     HL 
a1f8 2a 18 f2		                LD      HL,(LISTCNT) 
a1fb 11 00 00		                LD      DE,0 
a1fe cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a201			                                        ; HL<DE : 0  1 
a201			                                        ; HL=DE : 1  0 
a201			                                        ; HL>DE : 0  0 
a201 ca d4 a7		                JP      Z,EXT_END 
a204 ed 53 1a f2	                LD      (SELLISTNO),DE 
a208			EXT_FTPLIST_L010: 
a208 af			                XOR     A 
a209 32 35 f2		                LD      (RCVBUF_RPOS),A 
a20c 32 36 f2		                LD      (RCVBUF_WPOS),A 
a20f 21 40 f2		                LD      HL,DISPBUF_TOP 
a212 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a216 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a21a 01 00 00		                LD      BC,0 
a21d cd 9f 30		                CALL    ROM_BIN2DECASC 
a220 21 9b ac		                LD      HL,TBL_EXT_LIST 
a223 11 ce ed		                LD      DE,SNDBUF_TOP 
a226 01 05 00		                LD      BC,5 
a229 ed b0		                LDIR 
a22b 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a22e 01 03 00		                LD      BC,3 
a231 ed b0		                LDIR 
a233 21 12 ad		                LD      HL,TBL_CRLF 
a236 01 02 00		                LD      BC,2 
a239 ed b0		                LDIR 
a23b 06 0a		                LD      B,10 
a23d cd 55 ab		                CALL    SENDBUF_OUT 
a240 06 01		                LD      B,1 
a242 cd 60 ab		                CALL    RECVBUF_IN 
a245 3a ff f2		                LD      A,(FLGDATA) 
a248 e6 04		                AND     FLG_RCVTIMEOUT 
a24a c2 a4 a7		                JP      NZ,EXT_ERR1 
a24d 11 9b ac		                LD      DE,TBL_EXT_LIST 
a250 06 04		                LD      B,4 
a252 cd 97 ab		                CALL    RECVBUF_CHK 
a255 da a9 a7		                JP      C,EXT_ERR2 
a258 11 40 f2		                LD      DE,DISPBUF_TOP 
a25b 01 03 00		                LD      BC,3 
a25e ed b0		                LDIR 
a260 3e 3a		                LD      A,':' 
a262 12			                LD      (DE),A 
a263 13			                INC     DE 
a264 3a 65 ea		                LD      A,(CRT_TEXT_COLS) 
a267 fe 48		                CP      72 
a269 28 1a		                JR      Z,EXT_FTPLIST_040 
a26b fe 50		                CP      80 
a26d 28 16		                JR      Z,EXT_FTPLIST_040 
a26f 06 04		                LD      B,4 
a271			EXT_FTPLIST_010: 
a271 7e			                LD      A,(HL) 
a272 23			                INC     HL 
a273 fe 2c		                CP      ',' 
a275 28 02		                JR      Z,EXT_FTPLIST_020 
a277 18 f8		                JR      EXT_FTPLIST_010 
a279			EXT_FTPLIST_020: 
a279 10 f6		                DJNZ    EXT_FTPLIST_010 
a27b			EXT_FTPLIST_030: 
a27b 7e			                LD      A,(HL) 
a27c 12			                LD      (DE),A 
a27d 23			                INC     HL 
a27e 13			                INC     DE 
a27f fe 0d		                CP      CR 
a281 28 15		                JR      Z,EXT_FTPLIST_070 
a283 18 f6		                JR      EXT_FTPLIST_030 
a285			EXT_FTPLIST_040: 
a285 23			                INC     HL 
a286			EXT_FTPLIST_L020: 
a286 7e			                LD      A,(HL) 
a287 fe 2c		                CP      ',' 
a289 28 06		                JR      Z,EXT_FTPLIST_050 
a28b fe 0d		                CP      CR 
a28d 28 09		                JR      Z,EXT_FTPLIST_070 
a28f 18 02		                JR      EXT_FTPLIST_060 
a291			EXT_FTPLIST_050: 
a291 3e 20		                LD      A,' ' 
a293			EXT_FTPLIST_060: 
a293 12			                LD      (DE),A 
a294 23			                INC     HL 
a295 13			                INC     DE 
a296 18 ee		                JR      EXT_FTPLIST_L020 
a298			EXT_FTPLIST_070: 
a298 cd ad ab		                CALL    MSG_DISP 
a29b db 09		                IN      A,(KEYBRD9) 
a29d 57			                LD      D,A 
a29e e6 01		                AND     00000001B 
a2a0 ca d4 a7		                JP      Z,EXT_END 
a2a3 7a			                LD      A,D 
a2a4 e6 80		                AND     10000000B 
a2a6 20 0d		                JR      NZ,EXT_FTPLIST_090 
a2a8			EXT_FTPLIST_080: 
a2a8 db 09		                IN      A,(KEYBRD9) 
a2aa 57			                LD      D,A 
a2ab e6 01		                AND     00000001B 
a2ad ca d4 a7		                JP      Z,EXT_END 
a2b0 7a			                LD      A,D 
a2b1 e6 80		                AND     10000000B 
a2b3 28 f3		                JR      Z,EXT_FTPLIST_080 
a2b5			EXT_FTPLIST_090: 
a2b5 2a 18 f2		                LD      HL,(LISTCNT) 
a2b8 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a2bc 13			                INC     DE 
a2bd ed 53 1a f2	                LD      (SELLISTNO),DE 
a2c1 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a2c4			                                        ; HL<DE : 0  1 
a2c4			                                        ; HL=DE : 1  0 
a2c4			                                        ; HL>DE : 0  0 
a2c4 c2 08 a2		                JP      NZ,EXT_FTPLIST_L010 
a2c7 c3 d4 a7		                JP      EXT_END 
a2ca			; 
a2ca			; 
a2ca			; 
a2ca			EXT_FTPGET: 
a2ca e5			                PUSH    HL 
a2cb cd 46 a9		                CALL    INIT_SIO 
a2ce da b8 a7		                JP      C,EXT_ERR5 
a2d1 21 40 f2		                LD      HL,DISPBUF_TOP 
a2d4 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a2d8 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a2dc 01 00 00		                LD      BC,0 
a2df cd 9f 30		                CALL    ROM_BIN2DECASC 
a2e2 21 94 ac		                LD      HL,TBL_EXT_FTPGET2 
a2e5 11 ce ed		                LD      DE,SNDBUF_TOP 
a2e8 01 07 00		                LD      BC,7 
a2eb ed b0		                LDIR 
a2ed 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a2f0 01 03 00		                LD      BC,3 
a2f3 ed b0		                LDIR 
a2f5 21 12 ad		                LD      HL,TBL_CRLF 
a2f8 01 02 00		                LD      BC,2 
a2fb ed b0		                LDIR 
a2fd 06 0c		                LD      B,12 
a2ff cd 55 ab		                CALL    SENDBUF_OUT 
a302 06 01		                LD      B,1 
a304 cd 60 ab		                CALL    RECVBUF_IN 
a307 3a ff f2		                LD      A,(FLGDATA) 
a30a e6 04		                AND     FLG_RCVTIMEOUT 
a30c c2 a4 a7		                JP      NZ,EXT_ERR1 
a30f 11 94 ac		                LD      DE,TBL_EXT_FTPGET2 
a312 06 06		                LD      B,6 
a314 cd 97 ab		                CALL    RECVBUF_CHK 
a317 da a9 a7		                JP      C,EXT_ERR2 
a31a			EXT_FTPGET_000: 
a31a 23			                INC     HL 
a31b 23			                INC     HL 
a31c 23			                INC     HL 
a31d 23			                INC     HL 
a31e 7e			                LD      A,(HL) 
a31f e6 0f		                AND     0FH 
a321 fe 00		                CP      0               ; ERROR 
a323 ca ae a7		                JP      Z,EXT_ERR3 
a326 fe 01		                CP      1               ; OK 
a328 ca 2e a3		                JP      Z,EXT_FTPGET_010 
a32b c3 a9 a7		                JP      EXT_ERR2 
a32e			EXT_FTPGET_010: 
a32e 23			                INC     HL 
a32f 23			                INC     HL 
a330 06 03		                LD      B,3 
a332 11 00 00		                LD      DE,0 
a335			EXT_FTPGET_020: 
a335 7e			                LD      A,(HL) 
a336 e5			                PUSH    HL 
a337 eb			                EX      DE,HL 
a338 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a33b eb			                EX      DE,HL 
a33c e1			                POP     HL 
a33d 23			                INC     HL 
a33e 10 f5		                DJNZ    EXT_FTPGET_020 
a340 ed 53 2a f2	                LD      (DIVICOUNT),DE 
a344 21 00 00		                LD      HL,0 
a347 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a34a			                                        ; HL<DE : 0  1 
a34a			                                        ; HL=DE : 1  0 
a34a			                                        ; HL>DE : 0  0 
a34a ca a9 a7		                JP      Z,EXT_ERR2 
a34d 23			                INC     HL 
a34e cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a351			                                        ; HL<DE : 0  1 
a351			                                        ; HL=DE : 1  0 
a351			                                        ; HL>DE : 0  0 
a351 28 05		                JR      Z,EXT_FTPGET_030 
a353 11 01 00		                LD      DE,1 
a356 18 03		                JR      EXT_FTPGET_040 
a358			EXT_FTPGET_030: 
a358 11 00 00		                LD      DE,0 
a35b			EXT_FTPGET_040: 
a35b ed 53 2c f2	                LD      (SELDIVINO),DE 
a35f			EXT_FTPGET_050: 
a35f 21 40 f2		                LD      HL,DISPBUF_TOP 
a362 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a366 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a36a 01 00 00		                LD      BC,0 
a36d cd 9f 30		                CALL    ROM_BIN2DECASC 
a370 21 45 f2		                LD      HL,DISPBUF_TOP + 5 
a373 ed 5b 2c f2	                LD      DE,(SELDIVINO) 
a377 ed 53 a8 f0	                LD      (BIN_ACC),DE 
a37b 01 00 00		                LD      BC,0 
a37e cd 9f 30		                CALL    ROM_BIN2DECASC 
a381 21 a0 ac		                LD      HL,TBL_EXT_GET 
a384 11 ce ed		                LD      DE,SNDBUF_TOP 
a387 01 04 00		                LD      BC,4 
a38a ed b0		                LDIR 
a38c 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a38f 01 03 00		                LD      BC,3 
a392 ed b0		                LDIR 
a394 3e 2c		                LD      A,',' 
a396 12			                LD      (DE),A 
a397 13			                INC     DE 
a398 21 47 f2		                LD      HL,DISPBUF_TOP + 7 
a39b 01 03 00		                LD      BC,3 
a39e ed b0		                LDIR 
a3a0 21 12 ad		                LD      HL,TBL_CRLF 
a3a3 01 02 00		                LD      BC,2 
a3a6 ed b0		                LDIR 
a3a8 06 0d		                LD      B,13 
a3aa cd 55 ab		                CALL    SENDBUF_OUT 
a3ad 06 01		                LD      B,1 
a3af cd 60 ab		                CALL    RECVBUF_IN 
a3b2 3a ff f2		                LD      A,(FLGDATA) 
a3b5 e6 04		                AND     FLG_RCVTIMEOUT 
a3b7 c2 a4 a7		                JP      NZ,EXT_ERR1 
a3ba 11 a0 ac		                LD      DE,TBL_EXT_GET 
a3bd 06 03		                LD      B,3 
a3bf cd 97 ab		                CALL    RECVBUF_CHK 
a3c2 da a9 a7		                JP      C,EXT_ERR2 
a3c5 23			                INC     HL 
a3c6 23			                INC     HL 
a3c7 23			                INC     HL 
a3c8 23			                INC     HL 
a3c9 23			                INC     HL 
a3ca 23			                INC     HL 
a3cb 23			                INC     HL 
a3cc 23			                INC     HL 
a3cd 7e			                LD      A,(HL)          ; RESULT 
a3ce e6 0f		                AND     0FH 
a3d0 fe 00		                CP      0               ; ERROR 
a3d2 ca ae a7		                JP      Z,EXT_ERR3 
a3d5 fe 01		                CP      1               ; OK 
a3d7 ca dd a3		                JP      Z,EXT_FTPGET_060 
a3da c3 a9 a7		                JP      EXT_ERR2 
a3dd			EXT_FTPGET_060: 
a3dd 23			                INC     HL 
a3de 23			                INC     HL 
a3df 7e			                LD      A,(HL)          ; DATA TYPE 
a3e0			; 
a3e0 f5			                PUSH    AF 
a3e1 23			                INC     HL 
a3e2 23			                INC     HL 
a3e3 06 04		                LD      B,4 
a3e5 11 00 00		                LD      DE,0 
a3e8			EXT_FTPGET_L010: 
a3e8 7e			                LD      A,(HL) 
a3e9 e5			                PUSH    HL 
a3ea eb			                EX      DE,HL 
a3eb cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a3ee eb			                EX      DE,HL 
a3ef e1			                POP     HL 
a3f0 23			                INC     HL 
a3f1 10 f5		                DJNZ    EXT_FTPGET_L010 
a3f3 ed 53 1c f2	                LD      (LOADADRS),DE 
a3f7 23			                INC     HL 
a3f8 06 04		                LD      B,4 
a3fa 11 00 00		                LD      DE,0 
a3fd			EXT_FTPGET_L020: 
a3fd 7e			                LD      A,(HL) 
a3fe e5			                PUSH    HL 
a3ff eb			                EX      DE,HL 
a400 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a403 eb			                EX      DE,HL 
a404 e1			                POP     HL 
a405 23			                INC     HL 
a406 10 f5		                DJNZ    EXT_FTPGET_L020 
a408 ed 53 20 f2	                LD      (LOAD_ENDADRS),DE 
a40c 23			                INC     HL 
a40d 06 04		                LD      B,4 
a40f 11 00 00		                LD      DE,0 
a412			EXT_FTPGET_L030: 
a412 7e			                LD      A,(HL) 
a413 e5			                PUSH    HL 
a414 eb			                EX      DE,HL 
a415 cd 4b 5e		                CALL    ROM_HEXASC2BIN 
a418 eb			                EX      DE,HL 
a419 e1			                POP     HL 
a41a 23			                INC     HL 
a41b 10 f5		                DJNZ    EXT_FTPGET_L030 
a41d ed 53 2e f2	                LD      (EXECADRS2),DE 
a421 e5			                PUSH    HL 
a422 2a 20 f2		                LD      HL,(LOAD_ENDADRS) 
a425 ed 5b 1c f2	                LD      DE,(LOADADRS) 
a429 cd af a8		                CALL    CLRCFRET 
a42c ed 52		                SBC     HL,DE 
a42e 23			                INC     HL         
a42f 22 22 f2		                LD      (LOADSIZE),HL 
a432 e1			                POP     HL 
a433 f1			                POP     AF 
a434			; 
a434 e6 0f		                AND     0FH 
a436 fe 00		                CP      0               ; ERROR 
a438 ca ae a7		                JP      Z,EXT_ERR3 
a43b fe 01		                CP      1               ; ANY BIN 
a43d ca 4b a4		                JP      Z,EXT_FTPGET_100 
a440 fe 02		                CP      2               ; BASIC BIN 
a442 28 25		                JR      Z,EXT_FTPGET_110 
a444 fe 03		                CP      3               ; Z80 BIN 
a446 28 31		                JR      Z,EXT_FTPGET_200 
a448 c3 a9 a7		                JP      EXT_ERR2 
a44b			EXT_FTPGET_100: 
a44b ed 5b 1e f2	                LD      DE,(EXECADRS) 
a44f e5			                PUSH    HL 
a450 21 00 00		                LD      HL,0 
a453 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a456			                                        ; HL<DE : 0  1 
a456			                                        ; HL=DE : 1  0 
a456			                                        ; HL>DE : 0  0 
a456 e1			                POP     HL 
a457 ca b3 a7		                JP      Z,EXT_ERR4 
a45a ed 53 1c f2	                LD      (LOADADRS),DE 
a45e d5			                PUSH    DE 
a45f 11 00 00		                LD      DE,0 
a462 ed 53 1e f2	                LD      (EXECADRS),DE 
a466 d1			                POP     DE 
a467 18 10		                JR      EXT_FTPGET_200 
a469			EXT_FTPGET_110: 
a469 3a ff f2		                LD      A,(FLGDATA) 
a46c f6 02		                OR      FLG_LOADBAS 
a46e 32 ff f2		                LD      (FLGDATA),A 
a471 ed 5b 54 eb	                LD      DE,(BASAREA_TOP) 
a475 ed 53 1c f2	                LD      (LOADADRS),DE 
a479			EXT_FTPGET_200: 
a479 3a ff f2		                LD      A,(FLGDATA) 
a47c f6 10		                OR      FLG_ENABLESTOP 
a47e 32 ff f2		                LD      (FLGDATA),A 
a481 3e 01		                LD      A,1 
a483 32 33 f2		                LD      (CHKBLKNO),A 
a486			EXT_FTPGET_L040: 
a486 af			                XOR     A 
a487 32 35 f2		                LD      (RCVBUF_RPOS),A 
a48a 32 36 f2		                LD      (RCVBUF_WPOS),A 
a48d 3e 15		                LD      A,NAK 
a48f cd 4a ab		                CALL    OUT_SIO 
a492			EXT_FTPGET_L050: 
a492 cd b9 aa		                CALL    IN_SIO 
a495 fe 04		                CP      EOT 
a497 ca 5f a5		                JP      Z,EXT_FTPGET_310 
a49a fe 01		                CP      SOH 
a49c 28 2f		                JR      Z,EXT_FTPGET_210 
a49e 3a ff f2		                LD      A,(FLGDATA) 
a4a1 e6 04		                AND     FLG_RCVTIMEOUT 
a4a3 20 e1		                JR      NZ,EXT_FTPGET_L040 
a4a5 3a ff f2		                LD      A,(FLGDATA) 
a4a8 e6 08		                AND     FLG_RCVCANCEL 
a4aa c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4ad 18 e3		                JR      EXT_FTPGET_L050 
a4af			EXT_FTPGET_L060: 
a4af cd b9 aa		                CALL    IN_SIO 
a4b2 fe 04		                CP      EOT 
a4b4 ca 5f a5		                JP      Z,EXT_FTPGET_310 
a4b7 fe 01		                CP      SOH 
a4b9 28 12		                JR      Z,EXT_FTPGET_210 
a4bb 3a ff f2		                LD      A,(FLGDATA) 
a4be e6 04		                AND     FLG_RCVTIMEOUT 
a4c0 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4c3 3a ff f2		                LD      A,(FLGDATA) 
a4c6 e6 08		                AND     FLG_RCVCANCEL 
a4c8 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4cb 18 e2		                JR      EXT_FTPGET_L060 
a4cd			EXT_FTPGET_210: 
a4cd cd b4 a8		                CALL    CLR_RCVBUF 
a4d0 77			                LD      (HL),A 
a4d1 23			                INC     HL 
a4d2 06 83		                LD      B,131 
a4d4			EXT_FTPGET_L070: 
a4d4 cd b9 aa		                CALL    IN_SIO 
a4d7 4f			                LD      C,A 
a4d8 3a ff f2		                LD      A,(FLGDATA) 
a4db e6 04		                AND     FLG_RCVTIMEOUT 
a4dd c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4e0 3a ff f2		                LD      A,(FLGDATA) 
a4e3 e6 08		                AND     FLG_RCVCANCEL 
a4e5 c2 fd a5		                JP      NZ,EXT_FTPGET_CANCEL 
a4e8 79			                LD      A,C 
a4e9 77			                LD      (HL),A 
a4ea 23			                INC     HL 
a4eb 10 e7		                DJNZ    EXT_FTPGET_L070 
a4ed			; 
a4ed af			                XOR     A 
a4ee 32 35 f2		                LD      (RCVBUF_RPOS),A 
a4f1 32 36 f2		                LD      (RCVBUF_WPOS),A 
a4f4 cd b1 aa		                CALL    DISABLE_RTS 
a4f7 cd f3 a8		                CALL    CHK_RCVDATA 
a4fa 38 58		                JR      C,EXT_FTPGET_300 
a4fc d5			                PUSH    DE 
a4fd 2a 22 f2		                LD      HL,(LOADSIZE) 
a500 11 80 00		                LD      DE,128 
a503 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a506			                                        ; HL<DE : 0  1 
a506			                                        ; HL=DE : 1  0 
a506			                                        ; HL>DE : 0  0 
a506 38 02		                JR      C,EXT_FTPGET_220 
a508 d5			                PUSH    DE 
a509 e1			                POP     HL 
a50a			EXT_FTPGET_220: 
a50a e5			                PUSH    HL 
a50b c1			                POP     BC 
a50c d1			                POP     DE 
a50d cd c3 a8		                CALL    CHK_MEMOVER 
a510 da fd a5		                JP      C,EXT_FTPGET_CANCEL 
a513 c5			                PUSH    BC 
a514 21 d1 ed		                LD      HL,RCVBUF_DATA 
a517 f3			                DI 
a518 ed b0		                LDIR 
a51a 3a ff f2		                LD      A,(FLGDATA) 
a51d e6 20		                AND     FLG_EXECPC8001 
a51f 20 17		                JR      NZ,EXT_FTPGET_240 
a521 d5			                PUSH    DE 
a522 e5			                PUSH    HL 
a523 21 36 aa		                LD      HL,SIOIRQ_ENTRY 
a526 ed 5b 00 80	                LD      DE,(VECTOR_TBL_SIO) 
a52a cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a52d			                                        ; HL<DE : 0  1 
a52d			                                        ; HL=DE : 1  0 
a52d			                                        ; HL>DE : 0  0 
a52d 28 07		                JR      Z,EXT_FTPGET_230 
a52f ed 53 24 f2	                LD      (SAVESIOIRQ),DE 
a533 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
a536			EXT_FTPGET_230: 
a536 e1			                POP     HL 
a537 d1			                POP     DE 
a538			EXT_FTPGET_240: 
a538 fb			                EI 
a539 c1			                POP     BC 
a53a cd 20 a9		                CALL    DISP_PROGRESS 
a53d 2a 22 f2		                LD      HL,(LOADSIZE) 
a540 ed 42		                SBC     HL,BC 
a542 22 22 f2		                LD      (LOADSIZE),HL 
a545 cd a9 aa		                CALL    ENABLE_RTS 
a548			; 
a548 3e 06		                LD      A,ACK 
a54a cd 4a ab		                CALL    OUT_SIO         
a54d 21 33 f2		                LD      HL,CHKBLKNO 
a550 34			                INC     (HL) 
a551 c3 af a4		                JP      EXT_FTPGET_L060 
a554			EXT_FTPGET_300: 
a554 cd a9 aa		                CALL    ENABLE_RTS 
a557 3e 15		                LD      A,NAK 
a559 cd 4a ab		                CALL    OUT_SIO         
a55c c3 af a4		                JP      EXT_FTPGET_L060 
a55f			EXT_FTPGET_310: 
a55f 3e 06		                LD      A,ACK 
a561 cd 4a ab		                CALL    OUT_SIO 
a564 3a ff f2		                LD      A,(FLGDATA) 
a567 e6 02		                AND     FLG_LOADBAS 
a569 28 1a		                JR      Z,EXT_FTPGET_320 
a56b			EXT_FTPGET_FIXBAS: 
a56b d5			                PUSH    DE 
a56c 2a 1c f2		                LD      HL,(LOADADRS) 
a56f eb			                EX      DE,HL 
a570 ed 52		                SBC     HL,DE 
a572 e5			                PUSH    HL 
a573 c1			                POP     BC 
a574 e1			                POP     HL 
a575 af			                XOR     A 
a576 ed b9		                CPDR 
a578 23			                INC     HL 
a579 77			                LD      (HL),A 
a57a 23			                INC     HL 
a57b 77			                LD      (HL),A 
a57c 22 a0 ef		                LD      (VARAREA_TOP),  HL 
a57f 22 a2 ef		                LD      (ARRAYAREA_TOP),HL 
a582 22 a4 ef		                LD      (FREEAREA_TOP), HL 
a585			EXT_FTPGET_320: 
a585 2a 2c f2		                LD      HL,(SELDIVINO) 
a588 23			                INC     HL 
a589 22 2c f2		                LD      (SELDIVINO),HL 
a58c ed 5b 2a f2	                LD      DE,(DIVICOUNT) 
a590 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a593			                                        ; HL<DE : 0  1 
a593			                                        ; HL=DE : 1  0 
a593			                                        ; HL>DE : 0  0 
a593 28 18		                JR      Z,EXT_FTPGET_340 
a595 cd ca 5f		                CALL    ROM_DSPCRLF 
a598 cd 02 16		                CALL    ROM_TIMEREAD 
a59b 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
a59e 57			                LD      D,A 
a59f			EXT_FTPGET_330: 
a59f d5			                PUSH    DE 
a5a0 cd 02 16		                CALL    ROM_TIMEREAD 
a5a3 d1			                POP     DE 
a5a4 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
a5a7 ba			                CP      D 
a5a8 28 f5		                JR      Z,EXT_FTPGET_330 
a5aa c3 5f a3		                JP      EXT_FTPGET_050 
a5ad			EXT_FTPGET_340: 
a5ad 3e 01		                LD      A,1 
a5af cd 01 aa		                CALL    TERM_SIO 
a5b2 e1			                POP     HL 
a5b3 e5			                PUSH    HL 
a5b4 21 00 00		                LD      HL,0 
a5b7 ed 5b 1e f2	                LD      DE,(EXECADRS) 
a5bb cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a5be			                                        ; HL<DE : 0  1 
a5be			                                        ; HL=DE : 1  0 
a5be			                                        ; HL>DE : 0  0 
a5be e1			                POP     HL 
a5bf 28 03		                JR      Z,EXT_FTPGET_350 
a5c1 c3 3f a0		                JP      EXT_DLEXEC_EXIT 
a5c4			EXT_FTPGET_350: 
a5c4 e5			                PUSH    HL 
a5c5 21 00 00		                LD      HL,0 
a5c8 ed 5b 2e f2	                LD      DE,(EXECADRS2) 
a5cc cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a5cf			                                        ; HL<DE : 0  1 
a5cf			                                        ; HL=DE : 1  0 
a5cf			                                        ; HL>DE : 0  0 
a5cf e1			                POP     HL 
a5d0 ca 34 a0		                JP      Z,EXT_EXIT 
a5d3 3a ff f2		                LD      A,(FLGDATA) 
a5d6 e6 02		                AND     FLG_LOADBAS 
a5d8 c2 e2 a5		                JP      NZ,EXT_FTPGET_360 
a5db ed 53 1e f2	                LD      (EXECADRS),DE 
a5df c3 3f a0		                JP      EXT_DLEXEC_EXIT 
a5e2			EXT_FTPGET_360: 
a5e2 e5			                PUSH    HL 
a5e3 21 b8 ac		                LD      HL,TBL_RUN 
a5e6 11 c0 ea		                LD      DE,FUNCKEY_DATA 
a5e9 01 05 00		                LD      BC,5 
a5ec ed b0		                LDIR 
a5ee 21 c0 ea		                LD      HL,FUNCKEY_DATA 
a5f1 22 c0 ed		                LD      (FUNCKEY_PTR),HL 
a5f4 21 68 ea		                LD      HL,FUNCKEY_FLAG 
a5f7 36 01		                LD      (HL),1 
a5f9 e1			                POP     HL 
a5fa c3 34 a0		                JP      EXT_EXIT 
a5fd			EXT_FTPGET_CANCEL: 
a5fd cd a9 aa		                CALL    ENABLE_RTS 
a600 3e 18		                LD      A,CAN 
a602 cd 4a ab		                CALL    OUT_SIO 
a605 cd ca 5f		                CALL    ROM_DSPCRLF 
a608 af			                XOR     A 
a609 32 49 eb		                LD      (OUTPUT_DEVICE),A 
a60c 3c			                INC     A 
a60d 32 64 ea		                LD      (CURSOR_XPOS),A 
a610 21 cf ab		                LD      HL,ERR_MSG_000 
a613 cd ed 52		                CALL    ROM_MSGOUT 
a616 cd 43 0d		                CALL    ROM_BEEP 
a619 af			                XOR     A 
a61a cd 01 aa		                CALL    TERM_SIO 
a61d e1			                POP     HL 
a61e c3 37 a0		                JP      EXT_MYERR_EXIT 
a621			; 
a621			; 
a621			; 
a621			EXT_SNTP: 
a621 e5			                PUSH    HL 
a622 cd 46 a9		                CALL    INIT_SIO 
a625 da b8 a7		                JP      C,EXT_ERR5 
a628 21 65 ac		                LD      HL,TBL_EXT_SNTP 
a62b 11 ce ed		                LD      DE,SNDBUF_TOP 
a62e 01 04 00		                LD      BC,4 
a631 ed b0		                LDIR 
a633 21 12 ad		                LD      HL,TBL_CRLF 
a636 01 02 00		                LD      BC,2 
a639 ed b0		                LDIR 
a63b 06 06		                LD      B,6 
a63d cd 55 ab		                CALL    SENDBUF_OUT 
a640 06 01		                LD      B,1 
a642 cd 60 ab		                CALL    RECVBUF_IN 
a645 3a ff f2		                LD      A,(FLGDATA) 
a648 e6 04		                AND     FLG_RCVTIMEOUT 
a64a c2 a4 a7		                JP      NZ,EXT_ERR1 
a64d 11 65 ac		                LD      DE,TBL_EXT_SNTP 
a650 06 04		                LD      B,4 
a652 cd 97 ab		                CALL    RECVBUF_CHK 
a655 da a9 a7		                JP      C,EXT_ERR2 
a658 11 7b ea		                LD      DE,BCD_TIME_YEAR 
a65b 0e 00		                LD      C,0 
a65d 23			                INC     HL 
a65e 23			                INC     HL 
a65f			EXT_SNTP_L000: 
a65f 7e			                LD      A,(HL)          ; ASCII DECIMAL -> BCD 
a660 e6 0f		                AND     0FH 
a662 cb 27		                SLA     A 
a664 cb 27		                SLA     A 
a666 cb 27		                SLA     A 
a668 cb 27		                SLA     A 
a66a 47			                LD      B,A 
a66b 23			                INC     HL 
a66c 7e			                LD      A,(HL) 
a66d e6 0f		                AND     0FH 
a66f b0			                OR      B 
a670 47			                LD      B,A 
a671 79			                LD      A,C 
a672 fe 01		                CP      1               ; MONTH NOT BCD         
a674 20 1b		                JR      NZ,EXT_SNTP_000 
a676 d5			                PUSH    DE              ; BCD -> BIN 
a677 e5			                PUSH    HL 
a678 78			                LD      A,B 
a679 e6 f0		                AND     0F0H 
a67b cb 2f		                SRA     A 
a67d cb 2f		                SRA     A 
a67f cb 2f		                SRA     A 
a681 cb 2f		                SRA     A 
a683 1e 0a		                LD      E,10 
a685 c5			                PUSH    BC 
a686 cd c0 ab		                CALL    MUL_88_2_16 
a689 c1			                POP     BC 
a68a 78			                LD      A,B 
a68b e6 0f		                AND     0FH 
a68d 85			                ADD     A,L 
a68e 47			                LD      B,A 
a68f e1			                POP     HL 
a690 d1			                POP     DE 
a691			EXT_SNTP_000: 
a691 78			                LD      A,B 
a692 12			                LD      (DE),A 
a693 23			                INC     HL 
a694 1b			                DEC     DE 
a695 7e			                LD      A,(HL) 
a696 fe 0d		                CP      CR 
a698 28 04		                JR      Z,EXT_SNTP_010 
a69a 23			                INC     HL 
a69b 0c			                INC     C 
a69c 18 c1		                JR      EXT_SNTP_L000 
a69e			EXT_SNTP_010: 
a69e cd 63 16		                CALL    ROM_TIMEWRITE 
a6a1 c3 d4 a7		                JP      EXT_END 
a6a4			; 
a6a4			; 
a6a4			; 
a6a4			EXT_SPIFFSLIST: 
a6a4 e5			                PUSH    HL 
a6a5 cd 46 a9		                CALL    INIT_SIO 
a6a8 da b8 a7		                JP      C,EXT_ERR5 
a6ab 21 a4 ac		                LD      HL,TBL_EXT_SPIFFSLIST2 
a6ae 11 ce ed		                LD      DE,SNDBUF_TOP 
a6b1 01 0a 00		                LD      BC,10 
a6b4 ed b0		                LDIR 
a6b6 21 12 ad		                LD      HL,TBL_CRLF 
a6b9 01 02 00		                LD      BC,2 
a6bc ed b0		                LDIR 
a6be 06 0c		                LD      B,12 
a6c0 cd 55 ab		                CALL    SENDBUF_OUT 
a6c3 06 01		                LD      B,1 
a6c5 cd 60 ab		                CALL    RECVBUF_IN 
a6c8 3a ff f2		                LD      A,(FLGDATA) 
a6cb e6 04		                AND     FLG_RCVTIMEOUT 
a6cd c2 a4 a7		                JP      NZ,EXT_ERR1 
a6d0 11 a4 ac		                LD      DE,TBL_EXT_SPIFFSLIST2 
a6d3 06 0a		                LD      B,10 
a6d5 cd 97 ab		                CALL    RECVBUF_CHK 
a6d8 da a9 a7		                JP      C,EXT_ERR2 
a6db c3 a7 a1		                JP      EXT_FTPLIST_000 
a6de			; 
a6de			; 
a6de			; 
a6de			EXT_SPIFFSGET: 
a6de e5			                PUSH    HL 
a6df cd 46 a9		                CALL    INIT_SIO 
a6e2 da b8 a7		                JP      C,EXT_ERR5 
a6e5 21 40 f2		                LD      HL,DISPBUF_TOP 
a6e8 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
a6ec ed 53 a8 f0	                LD      (BIN_ACC),DE 
a6f0 01 00 00		                LD      BC,0 
a6f3 cd 9f 30		                CALL    ROM_BIN2DECASC 
a6f6 21 ae ac		                LD      HL,TBL_EXT_SPIFFSGET2 
a6f9 11 ce ed		                LD      DE,SNDBUF_TOP 
a6fc 01 0a 00		                LD      BC,10 
a6ff ed b0		                LDIR 
a701 21 42 f2		                LD      HL,DISPBUF_TOP + 2 
a704 01 03 00		                LD      BC,3 
a707 ed b0		                LDIR 
a709 21 12 ad		                LD      HL,TBL_CRLF 
a70c 01 02 00		                LD      BC,2 
a70f ed b0		                LDIR 
a711 06 0f		                LD      B,15 
a713 cd 55 ab		                CALL    SENDBUF_OUT 
a716 06 01		                LD      B,1 
a718 cd 60 ab		                CALL    RECVBUF_IN 
a71b 3a ff f2		                LD      A,(FLGDATA) 
a71e e6 04		                AND     FLG_RCVTIMEOUT 
a720 c2 a4 a7		                JP      NZ,EXT_ERR1 
a723 11 ae ac		                LD      DE,TBL_EXT_SPIFFSGET2 
a726 06 09		                LD      B,9 
a728 cd 97 ab		                CALL    RECVBUF_CHK 
a72b da a9 a7		                JP      C,EXT_ERR2 
a72e c3 1a a3		                JP      EXT_FTPGET_000 
a731			; 
a731			; 
a731			; 
a731			EXT_VER: 
a731 e5			                PUSH    HL 
a732 cd 46 a9		                CALL    INIT_SIO 
a735 da b8 a7		                JP      C,EXT_ERR5 
a738 21 83 ac		                LD      HL,TBL_EXT_VER 
a73b 11 ce ed		                LD      DE,SNDBUF_TOP 
a73e 01 03 00		                LD      BC,3 
a741 ed b0		                LDIR 
a743 21 12 ad		                LD      HL,TBL_CRLF 
a746 01 02 00		                LD      BC,2 
a749 ed b0		                LDIR 
a74b 06 05		                LD      B,5 
a74d cd 55 ab		                CALL    SENDBUF_OUT 
a750 06 01		                LD      B,1 
a752 cd 60 ab		                CALL    RECVBUF_IN 
a755 3a ff f2		                LD      A,(FLGDATA) 
a758 e6 04		                AND     FLG_RCVTIMEOUT 
a75a 20 48		                JR      NZ,EXT_ERR1 
a75c 11 83 ac		                LD      DE,TBL_EXT_VER 
a75f 06 03		                LD      B,3 
a761 cd 97 ab		                CALL    RECVBUF_CHK 
a764 38 43		                JR      C,EXT_ERR2 
a766 e5			                PUSH    HL 
a767 21 eb ac		                LD      HL,TBL_ESP32_VER 
a76a 11 40 f2		                LD      DE,DISPBUF_TOP 
a76d			EXT_VER_L010: 
a76d 7e			                LD      A,(HL) 
a76e 12			                LD      (DE),A 
a76f 23			                INC     HL 
a770 13			                INC     DE 
a771 fe 00		                CP      0 
a773 20 f8		                JR      NZ,EXT_VER_L010 
a775 e1			                POP     HL 
a776 1b			                DEC     DE 
a777			EXT_VER_L020: 
a777 7e			                LD      A,(HL) 
a778 fe 2c		                CP      ',' 
a77a 28 06		                JR      Z,EXT_VER_010 
a77c fe 0d		                CP      CR 
a77e 28 09		                JR      Z,EXT_VER_030 
a780 18 02		                JR      EXT_VER_020 
a782			EXT_VER_010: 
a782 3e 2e		                LD      A,'.' 
a784			EXT_VER_020: 
a784 12			                LD      (DE),A 
a785 23			                INC     HL 
a786 13			                INC     DE 
a787 18 ee		                JR      EXT_VER_L020 
a789			EXT_VER_030: 
a789 cd ad ab		                CALL    MSG_DISP 
a78c 21 fc ac		                LD      HL,TBL_SIO_VER 
a78f 11 40 f2		                LD      DE,DISPBUF_TOP 
a792			EXT_VER_L030: 
a792 7e			                LD      A,(HL) 
a793 12			                LD      (DE),A 
a794 23			                INC     HL 
a795 13			                INC     DE 
a796 fe 00		                CP      0 
a798 20 f8		                JR      NZ,EXT_VER_L030 
a79a cd ad ab		                CALL    MSG_DISP 
a79d 18 35		                JR      EXT_END 
a79f			; 
a79f			; 
a79f			; 
a79f			EXT_ERR0: 
a79f 21 cf ab		                LD      HL,ERR_MSG_000 
a7a2 18 17		                JR      EXT_ERR 
a7a4			EXT_ERR1: 
a7a4 21 dd ab		                LD      HL,ERR_MSG_001 
a7a7 18 12		                JR      EXT_ERR 
a7a9			EXT_ERR2: 
a7a9 21 ee ab		                LD      HL,ERR_MSG_002 
a7ac 18 0d		                JR      EXT_ERR 
a7ae			EXT_ERR3: 
a7ae 21 08 ac		                LD      HL,ERR_MSG_003 
a7b1 18 08		                JR      EXT_ERR 
a7b3			EXT_ERR4: 
a7b3 21 1e ac		                LD      HL,ERR_MSG_004 
a7b6 18 03		                JR      EXT_ERR 
a7b8			EXT_ERR5: 
a7b8 21 33 ac		                LD      HL,ERR_MSG_005 
a7bb			EXT_ERR: 
a7bb af			                XOR     A 
a7bc 32 49 eb		                LD      (OUTPUT_DEVICE),A 
a7bf 3c			                INC     A 
a7c0 32 64 ea		                LD      (CURSOR_XPOS),A 
a7c3 cd ed 52		                CALL    ROM_MSGOUT 
a7c6 cd ca 5f		                CALL    ROM_DSPCRLF 
a7c9 cd 43 0d		                CALL    ROM_BEEP 
a7cc af			                XOR     A 
a7cd cd 01 aa		                CALL    TERM_SIO 
a7d0 e1			                POP     HL 
a7d1 c3 37 a0		                JP      EXT_MYERR_EXIT 
a7d4			EXT_END: 
a7d4 af			                XOR     A 
a7d5 cd 01 aa		                CALL    TERM_SIO 
a7d8 e1			                POP     HL 
a7d9 c3 34 a0		                JP      EXT_EXIT 
a7dc			; 
a7dc			; 
a7dc			; 
a7dc			PARSER_EXTPARAM: 
a7dc e5			                PUSH    HL 
a7dd 21 00 00		                LD      HL,0 
a7e0 22 1c f2		                LD      (LOADADRS),    HL 
a7e3 22 1e f2		                LD      (EXECADRS),    HL 
a7e6 22 20 f2		                LD      (LOAD_ENDADRS),HL 
a7e9 22 22 f2		                LD      (LOADSIZE),    HL 
a7ec af			                XOR     A 
a7ed 32 32 f2		                LD      (EXTNO),A 
a7f0 3a ff f2		                LD      A,(FLGDATA) 
a7f3 e6 fd		                AND     ~FLG_LOADBAS 
a7f5 e6 fb		                AND     ~FLG_RCVTIMEOUT 
a7f7 32 ff f2		                LD      (FLGDATA),A 
a7fa e1			                POP     HL 
a7fb 11 48 ac		                LD      DE,TBL_EXT 
a7fe			PARSER_EXTPARAM_000: 
a7fe 1a			                LD      A,(DE) 
a7ff fe 00		                CP      0 
a801 ca b2 a8		                JP      Z,SETCFRET 
a804 e5			                PUSH    HL 
a805			PARSER_EXTPARAM_010: 
a805 be			                CP      (HL) 
a806 20 09		                JR      NZ,PARSER_EXTPARAM_020 
a808 23			                INC     HL 
a809 13			                INC     DE 
a80a 1a			                LD      A,(DE) 
a80b fe 00		                CP      0 
a80d 28 11		                JR      Z,PARSER_EXTPARAM_040 
a80f 18 f4		                JR      PARSER_EXTPARAM_010 
a811			PARSER_EXTPARAM_020: 
a811 e1			                POP     HL 
a812			PARSER_EXTPARAM_030: 
a812 13			                INC     DE 
a813 1a			                LD      A,(DE) 
a814 fe 00		                CP      0 
a816 20 fa		                JR      NZ,PARSER_EXTPARAM_030 
a818 13			                INC     DE 
a819 13			                INC     DE 
a81a 13			                INC     DE 
a81b 13			                INC     DE 
a81c 13			                INC     DE 
a81d 13			                INC     DE 
a81e 18 de		                JR      PARSER_EXTPARAM_000 
a820			PARSER_EXTPARAM_040: 
a820 2b			                DEC     HL 
a821 13			                INC     DE 
a822 1a			                LD      A,(DE) 
a823 32 32 f2		                LD      (EXTNO),A 
a826 13			                INC     DE 
a827 e5			                PUSH    HL 
a828 1a			                LD      A,(DE) 
a829 6f			                LD      L,A 
a82a 13			                INC     DE 
a82b 1a			                LD      A,(DE) 
a82c 67			                LD      H,A 
a82d e5			                PUSH    HL 
a82e dd e1		                POP     IX 
a830 13			                INC     DE 
a831 1a			                LD      A,(DE) 
a832 6f			                LD      L,A 
a833 13			                INC     DE 
a834 1a			                LD      A,(DE) 
a835 67			                LD      H,A 
a836 e5			                PUSH    HL 
a837 fd e1		                POP     IY 
a839 e1			                POP     HL 
a83a d1			                POP     DE 
a83b dd e9		                JP      (IX) 
a83d			PARSER_EXT_BME: 
a83d			PARSER_EXT_FTPLIST: 
a83d			PARSER_EXT_SNTP: 
a83d			PARSER_EXT_SPIFFSLIST: 
a83d			PARSER_EXT_VER: 
a83d 23			                INC     HL 
a83e 7e			                LD      A,(HL) 
a83f fe 00		                CP      0 
a841 28 6c		                JR      Z,CLRCFRET 
a843 fe 3a		                CP      ':' 
a845 28 68		                JR      Z,CLRCFRET 
a847 18 69		                JR      SETCFRET 
a849			PARSER_EXT_FTPGET: 
a849			PARSER_EXT_SPIFFSGET: 
a849 cd 9b a8		                CALL    PARSER_SKIP 
a84c fe 0f		                CP      0FH             ; ID CODE 0FH : 1 byte hex 
a84e 28 17		                JR      Z,PARSER_EXT_FTPGET_210 
a850 fe 11		                CP      11H             ; ID CODE 11H -> 0, 12H -> 1, ... 19H -> 8, 1AH -> 9 
a852 28 0c		                JR      Z,PARSER_EXT_FTPGET_000 
a854 fe 1a		                CP      1AH 
a856 38 08		                JR      C,PARSER_EXT_FTPGET_000 
a858 28 06		                JR      Z,PARSER_EXT_FTPGET_000 
a85a fe 1c		                CP      1CH             ; ID CODE 0CH : 2 byte hex 
a85c 28 0f		                JR      Z,PARSER_EXT_FTPGET_300 
a85e 18 52		                JR      SETCFRET 
a860			PARSER_EXT_FTPGET_000: 
a860 d6 11		                SUB     A,11H 
a862 5f			                LD      E,A 
a863 af			                XOR     A 
a864 57			                LD      D,A 
a865 18 0a		                JR      PARSER_EXT_FTPGET_310 
a867			PARSER_EXT_FTPGET_210: 
a867 23			                INC     HL 
a868 5e			                LD      E,(HL) 
a869 af			                XOR     A 
a86a 57			                LD      D,A 
a86b 18 04		                JR      PARSER_EXT_FTPGET_310 
a86d			PARSER_EXT_FTPGET_300: 
a86d 23			                INC     HL 
a86e 5e			                LD      E,(HL) 
a86f 23			                INC     HL 
a870 56			                LD      D,(HL) 
a871			PARSER_EXT_FTPGET_310: 
a871 ed 53 1a f2	                LD      (SELLISTNO),DE 
a875 23			                INC     HL 
a876 7e			                LD      A,(HL) 
a877 fe 00		                CP      0 
a879 28 34		                JR      Z,CLRCFRET 
a87b fe 3a		                CP      ':' 
a87d 28 30		                JR      Z,CLRCFRET 
a87f 2b			                DEC     HL 
a880 cd 9b a8		                CALL    PARSER_SKIP 
a883 fe 0c		                CP      0CH             ; ID CODE "&H" 
a885 20 2b		                JR      NZ,SETCFRET 
a887 23			                INC     HL 
a888 5e			                LD      E,(HL) 
a889 23			                INC     HL 
a88a 56			                LD      D,(HL) 
a88b ed 53 1e f2	                LD      (EXECADRS),DE 
a88f 23			                INC     HL 
a890 7e			                LD      A,(HL) 
a891 fe 00		                CP      0 
a893 28 1a		                JR      Z,CLRCFRET 
a895 fe 3a		                CP      ':' 
a897 28 16		                JR      Z,CLRCFRET 
a899 18 17		                JR      SETCFRET 
a89b			PARSER_SKIP: 
a89b 23			                INC     HL 
a89c 7e			                LD      A,(HL) 
a89d fe 20		                CP      ' ' 
a89f 28 fa		                JR      Z,PARSER_SKIP 
a8a1 fe 2c		                CP      ',' 
a8a3 28 03		                JR      Z,PARSER_SKIP_010 
a8a5 d1			                POP     DE 
a8a6 18 0a		                JR      SETCFRET 
a8a8			PARSER_SKIP_010: 
a8a8 23			                INC     HL 
a8a9 7e			                LD      A,(HL) 
a8aa fe 20		                CP      ' ' 
a8ac 28 fa		                JR      Z,PARSER_SKIP_010 
a8ae c9			                RET 
a8af			CLRCFRET: 
a8af 37			                SCF 
a8b0 3f			                CCF 
a8b1 c9			                RET 
a8b2			SETCFRET: 
a8b2 37			                SCF 
a8b3 c9			                RET 
a8b4			; 
a8b4			; 
a8b4			; 
a8b4			CLR_RCVBUF: 
a8b4 21 ce ed		                LD      HL,RCVBUF_TOP 
a8b7 f5			                PUSH    AF 
a8b8 e5			                PUSH    HL 
a8b9 06 84		                LD      B,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
a8bb af			                XOR     A 
a8bc			CLR_RCVBUF_L010: 
a8bc 77			                LD      (HL),A 
a8bd 23			                INC     HL 
a8be 10 fc		                DJNZ    CLR_RCVBUF_L010 
a8c0 e1			                POP     HL 
a8c1 f1			                POP     AF 
a8c2 c9			                RET 
a8c3			; 
a8c3			; 
a8c3			; 
a8c3			CHK_MEMOVER: 
a8c3 d5			                PUSH    DE 
a8c4 21 00 a0		                LD      HL,_PROG_TOP 
a8c7 11 00 80		                LD      DE,PC8001RAM_TOP 
a8ca cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8cd			                                        ; HL<DE : 0  1 
a8cd			                                        ; HL=DE : 1  0 
a8cd			                                        ; HL>DE : 0  0 
a8cd d1			                POP     DE 
a8ce 38 17		                JR      C,CHK_MEMOVER_010 
a8d0 d5			                PUSH    DE 
a8d1 eb			                EX      DE,HL 
a8d2 09			                ADD     HL,BC 
a8d3 11 00 a0		                LD      DE,_PROG_TOP 
a8d6 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8d9			                                        ; HL<DE : 0  1 
a8d9			                                        ; HL=DE : 1  0 
a8d9			                                        ; HL>DE : 0  0 
a8d9 d1			                POP     DE 
a8da 38 0b		                JR      C,CHK_MEMOVER_010 
a8dc d5			                PUSH    DE 
a8dd eb			                EX      DE,HL 
a8de 09			                ADD     HL,BC 
a8df 11 14 ad		                LD      DE,_PROG_END 
a8e2 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8e5			                                        ; HL<DE : 0  1 
a8e5			                                        ; HL=DE : 1  0 
a8e5			                                        ; HL>DE : 0  0 
a8e5 d1			                POP     DE 
a8e6 d8			                RET     C 
a8e7			CHK_MEMOVER_010: 
a8e7 d5			                PUSH    DE 
a8e8 eb			                EX      DE,HL 
a8e9 09			                ADD     HL,BC 
a8ea eb			                EX      DE,HL 
a8eb 2a 26 f2		                LD      HL,(ROM_WORKTOP) 
a8ee cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a8f1			                                        ; HL<DE : 0  1 
a8f1			                                        ; HL=DE : 1  0 
a8f1			                                        ; HL>DE : 0  0 
a8f1 d1			                POP     DE 
a8f2 c9			                RET 
a8f3			; 
a8f3			; 
a8f3			; 
a8f3			CHK_RCVDATA: 
a8f3 21 ce ed		                LD      HL,RCVBUF_TOP 
a8f6 7e			                LD      A,(HL) 
a8f7 fe 01		                CP      SOH 
a8f9 20 b7		                JR      NZ,SETCFRET 
a8fb 4f			                LD      C,A 
a8fc 23			                INC     HL 
a8fd 3a 33 f2		                LD      A,(CHKBLKNO) 
a900 be			                CP      (HL) 
a901 20 af		                JR      NZ,SETCFRET 
a903 81			                ADD     A,C 
a904 4f			                LD      C,A 
a905 23			                INC     HL 
a906 3a 33 f2		                LD      A,(CHKBLKNO) 
a909 2f			                CPL 
a90a be			                CP      (HL) 
a90b 20 a5		                JR      NZ,SETCFRET 
a90d 81			                ADD     A,C 
a90e 4f			                LD      C,A 
a90f 23			                INC     HL 
a910 06 80		                LD      B,128 
a912			CHK_RCVDATA_L010: 
a912 7e			                LD      A,(HL) 
a913 81			                ADD     A,C 
a914 4f			                LD      C,A 
a915 23			                INC     HL 
a916 10 fa		                DJNZ    CHK_RCVDATA_L010 
a918 79			                LD      A,C 
a919 be			                CP      (HL) 
a91a c2 b2 a8		                JP      NZ,SETCFRET 
a91d c3 af a8		                JP      CLRCFRET 
a920			; 
a920			; 
a920			; 
a920			DISP_PROGRESS: 
a920 c5			                PUSH    BC 
a921 d5			                PUSH    DE 
a922 e5			                PUSH    HL 
a923 3e 01		                LD      A,1 
a925 32 64 ea		                LD      (CURSOR_XPOS),A 
a928 3e 5b		                LD      A,'[' 
a92a cd 57 02		                CALL    ROM_DSPCHR 
a92d 2a 1c f2		                LD      HL,(LOADADRS) 
a930 cd c0 5e		                CALL    ROM_DSPHEX4 
a933 3e 2d		                LD      A,'-' 
a935 cd 57 02		                CALL    ROM_DSPCHR 
a938 eb			                EX      DE,HL 
a939 2b			                DEC     HL 
a93a cd c0 5e		                CALL    ROM_DSPHEX4 
a93d 3e 5d		                LD      A,']' 
a93f cd 57 02		                CALL    ROM_DSPCHR 
a942 e1			                POP     HL 
a943 d1			                POP     DE 
a944 c1			                POP     BC 
a945 c9			                RET 
a946			; 
a946			; 
a946			; 
a946			INIT_SIO: 
a946 cd 81 aa		                CALL    ENABLE_SIO 
a949 af			                XOR     A               ; DUMMY OUT 
a94a d3 21		                OUT     (USARTCW),A 
a94c d3 21		                OUT     (USARTCW),A 
a94e d3 21		                OUT     (USARTCW),A 
a950 3e 40		                LD      A,01000000B     ; SOFT RESET 
a952 d3 21		                OUT     (USARTCW),A 
a954 3e 4e		                LD      A,01001110B     ; MODE SETUP                    : 8N11 
a956			                                        ; BAUD RATE FACTOR              : 16X 
a956			                                        ; CHARACTER LENGTH              : 8BITS 
a956			                                        ; PARITY ENABLE                 : DISABLE 
a956			                                        ; EVEN PARITY GENARATION/CHECK  : ODD 
a956			                                        ; NUMBER OF STOP BITS           : 1 BIT 
a956 d3 21		                OUT     (USARTCW),A 
a958 32 30 f2		                LD      (MODEWORD),A 
a95b 3e 05		                LD      A,00000101B     ; COMMAND SETUP  TRANSMIT ENABLE 
a95d			                                        ;                DATA TERMINAL READY : FALSE 
a95d			                                        ;                RECEIVE ENABLE 
a95d			                                        ;                ERROR RESET         : FALSE 
a95d			                                        ;                REQUEST TO SEND     : FALSE 
a95d d3 21		                OUT     (USARTCW),A 
a95f 32 31 f2		                LD      (CTLWORD),A 
a962 cd 99 aa		                CALL    ENABLE_DTR 
a965 cd a9 aa		                CALL    ENABLE_RTS 
a968			INIT_SIO_000: 
a968 db 21		                IN      A,(USARTCW)     ; ESP32-WROOM-32 -> 8251 power-on receive dust removal support 
a96a 57			                LD      D,A 
a96b e6 38		                AND     00111000B 
a96d 20 09		                JR      NZ,INIT_SIO_010 
a96f 7a			                LD      A,D 
a970 e6 02		                AND     00000010B 
a972 28 0d		                JR      Z,INIT_SIO_020 
a974 db 20		                IN      A,(USARTDW) 
a976 18 f0		                JR      INIT_SIO_000 
a978			INIT_SIO_010: 
a978 3a 31 f2		                LD      A,(CTLWORD) 
a97b f6 10		                OR      00010000B 
a97d d3 21		                OUT     (USARTCW),A 
a97f 18 e7		                JR      INIT_SIO_000 
a981			INIT_SIO_020: 
a981 3a ff f2		                LD      A,(FLGDATA) 
a984 e6 01		                AND     FLG_FIRSTSEND 
a986 20 18		                JR      NZ,INIT_SIO_030 
a988 11 ce ed		                LD      DE,SNDBUF_TOP   ; 8251 -> ESP32-WROOM-32 power-on send dust removal support 
a98b 21 12 ad		                LD      HL,TBL_CRLF 
a98e 01 02 00		                LD      BC,2 
a991 ed b0		                LDIR 
a993 06 02		                LD      B,2 
a995 cd 55 ab		                CALL    SENDBUF_OUT 
a998 3a ff f2		                LD      A,(FLGDATA) 
a99b f6 01		                OR      FLG_FIRSTSEND 
a99d 32 ff f2		                LD      (FLGDATA),A 
a9a0			INIT_SIO_030: 
a9a0 21 00 ea		                LD      HL,NROM_WORKTOP 
a9a3 22 26 f2		                LD      (ROM_WORKTOP),HL 
a9a6 21 00 00		                LD      HL,0 
a9a9 22 24 f2		                LD      (SAVESIOIRQ),HL 
a9ac af			                XOR     A 
a9ad 32 35 f2		                LD      (RCVBUF_RPOS),A 
a9b0 32 36 f2		                LD      (RCVBUF_WPOS),A 
a9b3 3a ff f2		                LD      A,(FLGDATA) 
a9b6 e6 ef		                AND     ~FLG_ENABLESTOP 
a9b8 e6 df		                AND     ~FLG_EXECPC8001 
a9ba 32 ff f2		                LD      (FLGDATA),A 
a9bd 3a 5f 17		                LD      A,(ROM_PC8001CHK) 
a9c0 fe 80		                CP      80H             ; N-BASIC IMPLEMENTED IN PC-8001 
a9c2 28 07		                JR      Z,INIT_SIO_100 
a9c4 fe af		                CP      0AFH            ; N-BASIC IMPLEMENTED IN PC-8001mkII 
a9c6 28 0d		                JR      Z,INIT_SIO_200 
a9c8 c3 b2 a8		                JP      SETCFRET 
a9cb			INIT_SIO_100: 
a9cb 3a ff f2		                LD      A,(FLGDATA) 
a9ce f6 20		                OR      FLG_EXECPC8001 
a9d0 32 ff f2		                LD      (FLGDATA),A 
a9d3 18 29		                JR      INIT_SIO_900 
a9d5			INIT_SIO_200: 
a9d5 2a fd f0		                LD      HL,(CMD_ENTRY + 1) 
a9d8 11 30 e7		                LD      DE,PC8001MK2_N80MODE 
a9db cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
a9de			                                        ; HL<DE : 0  1 
a9de			                                        ; HL=DE : 1  0 
a9de			                                        ; HL>DE : 0  0 
a9de 28 02		                JR      Z,INIT_SIO_210 
a9e0 18 06		                JR      INIT_SIO_220 
a9e2			INIT_SIO_210: 
a9e2 21 00 e6		                LD      HL,N80ROM_WORKTOP 
a9e5 22 26 f2		                LD      (ROM_WORKTOP),HL 
a9e8			INIT_SIO_220: 
a9e8 2a 00 80		                LD      HL,(VECTOR_TBL_SIO) 
a9eb 22 24 f2		                LD      (SAVESIOIRQ),HL 
a9ee f3			                DI 
a9ef 21 36 aa		                LD      HL,SIOIRQ_ENTRY 
a9f2 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
a9f5 3e 07		                LD      A,7 
a9f7 d3 e4		                OUT     (INTLEVEL),A 
a9f9 3e 04		                LD      A,00000100B     ; bit2 : /RxMF USART    IRQ ENABLE 
a9fb			                                        ; bit1 : /VRMF VRTC     IRQ DISABLE 
a9fb			                                        ; bit0 : /RTMF INTERVAL IRQ DISABLE 
a9fb d3 e6		                OUT     (INTMASK),A 
a9fd fb			                EI 
a9fe			INIT_SIO_900: 
a9fe c3 af a8		                JP      CLRCFRET 
aa01			 
aa01			; 
aa01			; A :  0 no wait term sio 
aa01			;   : !0 1sec wait term sio 
aa01			; 
aa01			TERM_SIO: 
aa01 d5			                PUSH    DE 
aa02 fe 00		                CP      0 
aa04 28 12		                JR      Z,TERM_SIO_020 
aa06 cd 02 16		                CALL    ROM_TIMEREAD 
aa09 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
aa0c 57			                LD      D,A 
aa0d			TERM_SIO_010: 
aa0d d5			                PUSH    DE 
aa0e cd 02 16		                CALL    ROM_TIMEREAD 
aa11 d1			                POP     DE 
aa12 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
aa15 ba			                CP      D 
aa16 28 f5		                JR      Z,TERM_SIO_010 
aa18			TERM_SIO_020: 
aa18 3a ff f2		                LD      A,(FLGDATA) 
aa1b e6 20		                AND     FLG_EXECPC8001 
aa1d 20 0c		                JR      NZ,TERM_SIO_030 
aa1f f3			                DI 
aa20 2a 24 f2		                LD      HL,(SAVESIOIRQ) 
aa23 22 00 80		                LD      (VECTOR_TBL_SIO),HL 
aa26 3e 00		                LD      A,00000000B     ; bit2 : /RxMF USART    IRQ DISABLE 
aa28			                                        ; bit1 : /VRMF VRTC     IRQ DISABLE 
aa28			                                        ; bit0 : /RTMF INTERVAL IRQ DISABLE 
aa28 d3 e6		                OUT     (INTMASK),A 
aa2a fb			                EI 
aa2b			TERM_SIO_030: 
aa2b cd b1 aa		                CALL    DISABLE_RTS 
aa2e cd a1 aa		                CALL    DISABLE_DTR 
aa31 cd 8e aa		                CALL    DISABLE_SIO 
aa34 d1			                POP     DE 
aa35 c9			                RET 
aa36			; 
aa36			; 
aa36			; 
aa36			SIOIRQ_ENTRY: 
aa36 f3			                DI 
aa37 08			                EX      AF,AF' 
aa38 d9			                EXX 
aa39 3a 55 ea		                LD      A,(LAST_INTLEVEL) 
aa3c f5			                PUSH    AF 
aa3d			; 
aa3d 3e 07		                LD      A,7 
aa3f d3 e4		                OUT     (INTLEVEL),     A 
aa41 32 55 ea		                LD      (LAST_INTLEVEL),A 
aa44 32 56 ea		                LD      (FLG_INTEXEC),  A 
aa47			; 
aa47			SIOIRQ_010: 
aa47 db 21		                IN      A,(USARTCW) 
aa49 57			                LD      D,A 
aa4a e6 38		                AND     00111000B 
aa4c 20 23		                JR      NZ,SIOIRQ_030 
aa4e 7a			                LD      A,D 
aa4f e6 02		                AND     00000010B 
aa51 28 27		                JR      Z,SIOIRQ_EXIT 
aa53			; 
aa53 3a 36 f2		                LD      A,(RCVBUF_WPOS) 
aa56 21 ce ed		                LD      HL,RCVBUF_TOP 
aa59 06 00		                LD      B,0 
aa5b 4f			                LD      C,A 
aa5c 09			                ADD     HL,BC 
aa5d db 20		                IN      A,(USARTDW) 
aa5f 77			                LD      (HL),A 
aa60 0c			                INC     C 
aa61 79			                LD      A,C 
aa62 06 84		                LD      B,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
aa64 b8			                CP      B 
aa65 20 04		                JR      NZ,SIOIRQ_020 
aa67 38 02		                JR      C,SIOIRQ_020 
aa69 0e 00		                LD      C,0 
aa6b			SIOIRQ_020: 
aa6b 79			                LD      A,C 
aa6c 32 36 f2		                LD      (RCVBUF_WPOS),A 
aa6f 18 09		                JR      SIOIRQ_EXIT 
aa71			SIOIRQ_030: 
aa71 3a 31 f2		                LD      A,(CTLWORD) 
aa74 f6 10		                OR      00010000B 
aa76 d3 21		                OUT     (USARTCW),A 
aa78 18 cd		                JR      SIOIRQ_010 
aa7a			SIOIRQ_EXIT: 
aa7a			; 
aa7a f1			                POP     AF 
aa7b d3 e4		                OUT     (INTLEVEL),A 
aa7d d9			                EXX 
aa7e 08			                EX      AF,AF' 
aa7f fb			                EI 
aa80 c9			                RET 
aa81			; 
aa81			; 
aa81			; 
aa81			ENABLE_SIO: 
aa81 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
aa84 e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
aa86 f6 20		                OR      00100000B       ; BS2 ON 
aa88 d3 30		                OUT     (CONTROL1),A 
aa8a 32 66 ea		                LD      (CTL1_OUTDATA),A 
aa8d c9			                RET 
aa8e			; 
aa8e			; 
aa8e			; 
aa8e			DISABLE_SIO: 
aa8e 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
aa91 e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
aa93 d3 30		                OUT     (CONTROL1),A 
aa95 32 66 ea		                LD      (CTL1_OUTDATA),A 
aa98 c9			                RET 
aa99			; 
aa99			; 
aa99			; 
aa99			ENABLE_DTR: 
aa99 3a 31 f2		                LD      A,(CTLWORD) 
aa9c f6 02		                OR      00000010B       ; DATA TERMINAL READY : TRUE 
aa9e d3 21		                OUT     (USARTCW),A 
aaa0 c9			                RET 
aaa1			; 
aaa1			; 
aaa1			; 
aaa1			DISABLE_DTR: 
aaa1 3a 31 f2		                LD      A,(CTLWORD) 
aaa4 e6 fd		                AND     11111101B       ; DATA TERMINAL READY : FALSE 
aaa6 d3 21		                OUT     (USARTCW),A 
aaa8 c9			                RET 
aaa9			; 
aaa9			; 
aaa9			; 
aaa9			ENABLE_RTS: 
aaa9 3a 31 f2		                LD      A,(CTLWORD) 
aaac f6 20		                OR      00100000B       ; REQUEST TO SEND : TRUE 
aaae d3 21		                OUT     (USARTCW),A 
aab0 c9			                RET 
aab1			; 
aab1			; 
aab1			; 
aab1			DISABLE_RTS: 
aab1 3a 31 f2		                LD      A,(CTLWORD) 
aab4 e6 df		                AND     11011111B       ; REQUEST TO SEND : FALSE 
aab6 d3 21		                OUT     (USARTCW),A 
aab8 c9			                RET 
aab9			; 
aab9			; 
aab9			; 
aab9			IN_SIO: 
aab9 3a ff f2		                LD      A,(FLGDATA) 
aabc e6 fb		                AND     ~FLG_RCVTIMEOUT 
aabe e6 f7		                AND     ~FLG_RCVCANCEL 
aac0 32 ff f2		                LD      (FLGDATA),A 
aac3 c5			                PUSH    BC 
aac4 d5			                PUSH    DE 
aac5 e5			                PUSH    HL 
aac6 21 03 00		                LD      HL,3            ; 5000msec Timer 
aac9 01 00 0a		                LD      BC,0A00H 
aacc			IN_SIO_010: 
aacc 3a ff f2		                LD      A,(FLGDATA) 
aacf e6 10		                AND     FLG_ENABLESTOP 
aad1 28 06		                JR      Z,IN_SIO_020 
aad3 db 09		                IN      A,(KEYBRD9) 
aad5 e6 01		                AND     00000001B 
aad7 28 60		                JR      Z,IN_SIO_080 
aad9			IN_SIO_020: 
aad9 3a ff f2		                LD      A,(FLGDATA) 
aadc e6 20		                AND     FLG_EXECPC8001 
aade 20 23		                JR      NZ,IN_SIO_040 
aae0			; 
aae0 3a 35 f2		                LD      A,(RCVBUF_RPOS) 
aae3 5f			                LD      E,A 
aae4 3a 36 f2		                LD      A,(RCVBUF_WPOS) 
aae7 bb			                CP      E 
aae8 ca 18 ab		                JP      Z,IN_SIO_060 
aaeb 21 ce ed		                LD      HL,RCVBUF_TOP 
aaee 16 00		                LD      D,0 
aaf0 19			                ADD     HL,DE 
aaf1 1c			                INC     E 
aaf2 7b			                LD      A,E 
aaf3 16 84		                LD      D,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
aaf5 ba			                CP      D 
aaf6 20 04		                JR      NZ,IN_SIO_030 
aaf8 38 02		                JR      C,IN_SIO_030 
aafa 1e 00		                LD      E,0 
aafc			IN_SIO_030: 
aafc 7b			                LD      A,E 
aafd 32 35 f2		                LD      (RCVBUF_RPOS),A 
ab00 7e			                LD      A,(HL) 
ab01 18 43		                JR      IN_SIO_100 
ab03			; 
ab03			IN_SIO_040: 
ab03 db 21		                IN      A,(USARTCW) 
ab05 57			                LD      D,A 
ab06 e6 38		                AND     00111000B 
ab08 20 07		                JR      NZ,IN_SIO_050 
ab0a 7a			                LD      A,D 
ab0b e6 02		                AND     00000010B 
ab0d 20 35		                JR      NZ,IN_SIO_090 
ab0f 18 07		                JR      IN_SIO_060 
ab11			IN_SIO_050: 
ab11 3a 31 f2		                LD      A,(CTLWORD) 
ab14 f6 10		                OR      00010000B 
ab16 d3 21		                OUT     (USARTCW),A 
ab18			IN_SIO_060: 
ab18 0b			                DEC     BC 
ab19 79			                LD      A,C 
ab1a fe 00		                CP      0 
ab1c 20 ae		                JR      NZ,IN_SIO_010 
ab1e 78			                LD      A,B 
ab1f fe 00		                CP      0 
ab21 20 a9		                JR      NZ,IN_SIO_010 
ab23 2b			                DEC     HL 
ab24 7d			                LD      A,L 
ab25 fe 00		                CP      0 
ab27 20 a3		                JR      NZ,IN_SIO_010 
ab29 7c			                LD      A,H 
ab2a fe 00		                CP      0 
ab2c 20 9e		                JR      NZ,IN_SIO_010 
ab2e			IN_SIO_070: 
ab2e 3a ff f2		                LD      A,(FLGDATA) 
ab31 f6 04		                OR      FLG_RCVTIMEOUT 
ab33 32 ff f2		                LD      (FLGDATA),A 
ab36 af			                XOR     A 
ab37 18 0d		                JR      IN_SIO_100 
ab39			IN_SIO_080: 
ab39 3a ff f2		                LD      A,(FLGDATA) 
ab3c f6 08		                OR      FLG_RCVCANCEL 
ab3e 32 ff f2		                LD      (FLGDATA),A 
ab41 af			                XOR     A 
ab42 18 02		                JR      IN_SIO_100 
ab44			IN_SIO_090: 
ab44 db 20		                IN      A,(USARTDW) 
ab46			IN_SIO_100: 
ab46 e1			                POP     HL 
ab47 d1			                POP     DE 
ab48 c1			                POP     BC 
ab49 c9			                RET 
ab4a			; 
ab4a			; 
ab4a			; 
ab4a			OUT_SIO: 
ab4a f5			                PUSH    AF 
ab4b			OUT_SIO_000: 
ab4b db 21		                IN      A,(USARTCW) 
ab4d e6 01		                AND     00000001B 
ab4f 28 fa		                JR      Z,OUT_SIO_000 
ab51 f1			                POP     AF 
ab52 d3 20		                OUT     (USARTDW),A 
ab54 c9			                RET 
ab55			; 
ab55			; 
ab55			; 
ab55			SENDBUF_OUT: 
ab55 21 ce ed		                LD      HL,SNDBUF_TOP 
ab58			SENDBUF_OUT_000: 
ab58 7e			                LD      A,(HL) 
ab59 cd 4a ab		                CALL    OUT_SIO 
ab5c 23			                INC     HL 
ab5d 10 f9		                DJNZ    SENDBUF_OUT_000 
ab5f c9			                RET 
ab60			; 
ab60			; 
ab60			; 
ab60			RECVBUF_IN: 
ab60 78			                LD      A,B 
ab61 32 34 f2		                LD      (LFRECVCOUNT),A 
ab64 21 ce ed		                LD      HL,RCVBUF_TOP 
ab67			RECVBUF_IN_000: 
ab67 cd b9 aa		                CALL    IN_SIO 
ab6a c5			                PUSH    BC 
ab6b 47			                LD      B,A 
ab6c 3a ff f2		                LD      A,(FLGDATA) 
ab6f e6 04		                AND     FLG_RCVTIMEOUT 
ab71 78			                LD      A,B 
ab72 c1			                POP     BC 
ab73 20 08		                JR      NZ,RECVBUF_IN_020                 
ab75 77			                LD      (HL),A 
ab76 fe 0a		                CP      LF 
ab78 28 15		                JR      Z,RECVBUF_IN_030 
ab7a			RECVBUF_IN_010: 
ab7a 23			                INC     HL 
ab7b 18 ea		                JR      RECVBUF_IN_000 
ab7d			RECVBUF_IN_020: 
ab7d 3a 34 f2		                LD      A,(LFRECVCOUNT) 
ab80 4f			                LD      C,A 
ab81 78			                LD      A,B 
ab82 b9			                CP      C 
ab83 28 11		                JR      Z,RECVBUF_IN_040 
ab85 3a ff f2		                LD      A,(FLGDATA) 
ab88 e6 fb		                AND     ~FLG_RCVTIMEOUT 
ab8a 32 ff f2		                LD      (FLGDATA),A 
ab8d 18 07		                JR      RECVBUF_IN_040 
ab8f			RECVBUF_IN_030: 
ab8f 05			                DEC     B 
ab90 af			                XOR     A 
ab91 b8			                CP      B 
ab92 28 02		                JR      Z,RECVBUF_IN_040 
ab94 18 e4		                JR      RECVBUF_IN_010 
ab96			RECVBUF_IN_040: 
ab96 c9			                RET 
ab97			; 
ab97			; 
ab97			; 
ab97			RECVBUF_CHK: 
ab97 21 ce ed		                LD      HL,RCVBUF_TOP 
ab9a			RECVBUF_CHK_000: 
ab9a 1a			                LD      A,(DE) 
ab9b be			                CP      (HL) 
ab9c c2 b2 a8		                JP      NZ,SETCFRET 
ab9f 23			                INC     HL 
aba0 13			                INC     DE 
aba1 10 f7		                DJNZ    RECVBUF_CHK_000 
aba3 3e 3a		                LD      A,':' 
aba5 be			                CP      (HL) 
aba6 c2 b2 a8		                JP      NZ,SETCFRET 
aba9 23			                INC     HL 
abaa c3 af a8		                JP      CLRCFRET 
abad			; 
abad			; 
abad			; 
abad			MSG_DISP: 
abad af			                XOR     A 
abae 12			                LD      (DE),A 
abaf 32 49 eb		                LD      (OUTPUT_DEVICE),A 
abb2 3c			                INC     A 
abb3 32 64 ea		                LD      (CURSOR_XPOS),A 
abb6 21 40 f2		                LD      HL,DISPBUF_TOP 
abb9 cd ed 52		                CALL    ROM_MSGOUT 
abbc cd ca 5f		                CALL    ROM_DSPCRLF 
abbf c9			                RET 
abc0			; 
abc0			; D = 0 
abc0			; HL = E * A 
abc0			; 
abc0			MUL_88_2_16: 
abc0 16 00		                LD      D,0 
abc2 21 00 00		                LD      HL,0 
abc5 06 08		                LD      B,8 
abc7			MUL_L000: 
abc7 29			                ADD     HL,HL 
abc8 87			                ADD     A,A 
abc9 30 01		                JR      NC,MUL_000 
abcb 19			                ADD     HL,DE 
abcc			MUL_000: 
abcc 10 f9		                DJNZ    MUL_L000 
abce c9			                RET 
abcf			; 
abcf			; 
abcf			; 
abcf .. 00		ERR_MSG_000:    DB      "abort receive", 0 
abdd .. 00		ERR_MSG_001:    DB      "receive time out", 0 
abee .. 00		ERR_MSG_002:    DB      "received command mismatch", 0 
ac08 .. 00		ERR_MSG_003:    DB      "ftp/spiffs get failed", 0 
ac1e .. 00		ERR_MSG_004:    DB      "load address not set", 0 
ac33 .. 00		ERR_MSG_005:    DB      "not support hardware", 0 
ac48			TBL_EXT: 
ac48 .. 00 01		TBL_EXT_BME:    DB      "BME",       0, 1 
ac4d 3d a8		                DW      PARSER_EXT_BME 
ac4f c9 a0		                DW      EXT_BME 
ac51 .. 93 00 02	TBL_EXT_FTPLIST:DB      "FTP", 93H,  0, 2       ; reserve code 93H : "LIST" 
ac57 3d a8		                DW      PARSER_EXT_FTPLIST 
ac59 70 a1		                DW      EXT_FTPLIST 
ac5b .. c7 00 03	TBL_EXT_FTPGET: DB      "FTP", 0C7H, 0, 3       ; reserve code C7H : "GET" 
ac61 49 a8		                DW      PARSER_EXT_FTPGET 
ac63 ca a2		                DW      EXT_FTPGET 
ac65 .. 00 04		TBL_EXT_SNTP:   DB      "SNTP",      0, 4 
ac6b 3d a8		                DW      PARSER_EXT_SNTP 
ac6d 21 a6		                DW      EXT_SNTP 
ac6f			TBL_EXT_SPIFFSLIST: 
ac6f .. 93 00 05	                DB      "SPI", 93H,  0, 5    ; reserve code 93H : "LIST" 
ac75 3d a8		                DW      PARSER_EXT_SPIFFSLIST 
ac77 a4 a6		                DW      EXT_SPIFFSLIST 
ac79			TBL_EXT_SPIFFSGET: 
ac79 .. c7 00 06	                DB      "SPI", 0C7H, 0, 6    ; reserve code C7H : "GET" 
ac7f 49 a8		                DW      PARSER_EXT_FTPGET 
ac81 de a6		                DW      EXT_SPIFFSGET 
ac83 .. 00 07		TBL_EXT_VER:    DB      "VER",       0, 7 
ac88 3d a8		                DW      PARSER_EXT_VER 
ac8a 31 a7		                DW      EXT_VER 
ac8c 00			                DB      0 
ac8d			TBL_EXT_FTPLIST2: 
ac8d ..			                DB      "FTPLIST" 
ac94 ..			TBL_EXT_FTPGET2:DB      "FTPGET:" 
ac9b ..			TBL_EXT_LIST:   DB      "LIST:" 
aca0 ..			TBL_EXT_GET:    DB      "GET:" 
aca4			TBL_EXT_SPIFFSLIST2: 
aca4 ..			                DB      "SPIFFSLIST" 
acae			TBL_EXT_SPIFFSGET2: 
acae ..			                DB      "SPIFFSGET:" 
acb8 .. 0d 00		TBL_RUN:        DB      "RUN", 0DH, 0 
acbd .. 00		TBL_COUNT_MSG0: DB      "file count: ", 0 
acca .. 00		TBL_TEMP_MSG0:  DB      "temp : ", 0 
acd2 df 43 00		TBL_TEMP_MSG1:  DB      0DFH, "C", 0 
acd5 .. 00		TBL_HUMI_MSG0:  DB      "humi : ", 0 
acdd .. 00		TBL_HUMI_MSG1:  DB      "%", 0 
acdf .. 00		TBL_PRESS_MSG0: DB      "press: ", 0 
ace7 .. 00		TBL_PRESS_MSG1: DB      "hPa", 0 
aceb .. 00		TBL_ESP32_VER:  DB      "esp32 firmware v", 0 
acfc .. 31 2e 30 2e 33 00	TBL_SIO_VER:    DB      "sio   firmware v", 30H + VER_MAJOR, ".", 30H + VER_MINOR, ".", 30H + VER_REVISION, 0 
ad12 0d 0a		TBL_CRLF:       DB      CR, LF 
ad14			                ;END 
ad14			 
# End of file esp32pc8001sio.asm
ad14			_PROG_END: 
ad14			                END 
			

# End of file esp32pc8001sio_ram.asm
ad14
