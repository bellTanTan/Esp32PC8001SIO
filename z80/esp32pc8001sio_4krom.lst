# File esp32pc8001sio_4krom.asm
0000			                ORG     06000H 
6000			_USER_ROM_START: 
6000			_PROG_TOP: 
6000 ..			                DB      "AB" 
6002 c3 10 60		                JP      _ENTRY 
6005			_MON_ENTRY: 
6005 cd 10 60		                CALL    _ENTRY 
6008 c3 81 00		                JP      ROM_BASPROMPT 
600b 00			                NOP 
600c 00			                NOP 
600d 01			                DB      VER_MAJOR 
600e 00			                DB      VER_MINOR 
600f 00			                DB      VER_REVISION 
6010			_ENTRY: 
6010 21 1c 60		                LD      HL,NEWJPTBL 
6013 11 fc f0		                LD      DE,CMD_ENTRY 
6016 01 03 00		                LD      BC,3 
6019 ed b0		                LDIR 
601b c9			                RET 
601c			NEWJPTBL: 
601c c3 1f 60		                JP      NEW_CMD 
601f			NEW_CMD: 
601f			                INCLUDE "esp32pc8001sio.asm" 
601f			; 
601f			; CMD BME 
601f			; CMD FTPLIST 
601f			; CMD FTPGET,nnn 
601f			; CMD FTPGET,nnn,&HXXXX 
601f			; CMD SNTP 
601f			; CMD VER 
601f			; 
601f			; 
601f			; CONSTANT CONTROL CODE 
601f			; 
601f			NUL:            EQU     00H 
601f			SOH:            EQU     01H 
601f			STX:            EQU     02H 
601f			EOT:            EQU     04H 
601f			ACK:            EQU     06H 
601f			BS:             EQU     08H 
601f			LF:             EQU     0AH 
601f			CR:             EQU     0DH 
601f			NAK:            EQU     15H 
601f			CAN:            EQU     18H 
601f			ESC:            EQU     1BH 
601f			; 
601f			; CONSTANT I/O PORT 
601f			; 
601f			KEYBRD9:        EQU     09H 
601f			USARTDW:        EQU     20H 
601f			USARTCW:        EQU     21H             ; MODE SETUP 
601f			                                        ; 76543210 
601f			                                        ; ||||||++--- BAUD RATE FACTOR 
601f			                                        ; ||||||      00 : SYNC MODE 
601f			                                        ; ||||||      01 : 1X 
601f			                                        ; ||||||      10 : 16X 
601f			                                        ; ||||||      11 : 64X 
601f			                                        ; ||||++----- CHARACTER LENGTH 
601f			                                        ; ||||        00 : 5BITS 
601f			                                        ; ||||        01 : 6BITS 
601f			                                        ; ||||        10 : 7BITS 
601f			                                        ; ||||        11 : 8BITS 
601f			                                        ; |||+------- PARITY ENABLE 
601f			                                        ; |||         1 : ENABLE 
601f			                                        ; |||         0 : DISABLE 
601f			                                        ; ||+-------- EVEN PARITY GENARATION/CHECK 
601f			                                        ; ||          1 : EVEN 
601f			                                        ; ||          0 : ODD 
601f			                                        ; ++--------- NUMBER OF STOP BITS 
601f			                                        ;             00 : INVALID 
601f			                                        ;             01 : 1 BIT 
601f			                                        ;             10 : 1.5 BITS 
601f			                                        ;             11 : 2 BITS 
601f			                                        ; 
601f			                                        ; COMMAND SETUP 
601f			                                        ; 76543210 
601f			                                        ; |||||||+--- TRANSMIT ENABLE 
601f			                                        ; |||||||     1 : ENABLE 
601f			                                        ; |||||||     0 : DISABLE 
601f			                                        ; ||||||+---- DATA TERMINAL READY 
601f			                                        ; ||||||      "high" will force ~DTR output zero 
601f			                                        ; |||||+----- RECEIVE ENABLE 
601f			                                        ; |||||       1 : ENABLE 
601f			                                        ; |||||       0 : DISABLE 
601f			                                        ; ||||+------ SEND BREAK CHARACTER 
601f			                                        ; ||||        1 : forces TxD "low" 
601f			                                        ; ||||        0 : normal operation 
601f			                                        ; |||+------- ERROR RESET 
601f			                                        ; |||         1 : reset all error flags PE,OE,FE 
601f			                                        ; ||+-------- REQUEST TO SEND 
601f			                                        ; ||          "high" will force ~RTS output zero 
601f			                                        ; |+--------- INTERNAL RESET 
601f			                                        ; |           "high" returns USART to Mode Instruction Format 
601f			                                        ; +---------- ENTER HUNT MODE 
601f			                                        ;             1 = enable search for Sync Characters 
601f			                                        ; 
601f			                                        ; STATUS READ 
601f			                                        ; 76543210 
601f			                                        ; |||||||+--- TxRDY 
601f			                                        ; ||||||+---- RxRDY 
601f			                                        ; |||||+----- TxEMPTY 
601f			                                        ; ||||+------ PE(PARITY ERROR) 
601f			                                        ; |||+------- OE(OVERRUN ERROR) 
601f			                                        ; ||+-------- FE(FRAMING ERROR) 
601f			                                        ; |+--------- SYNDET 
601f			                                        ; +---------- DSR 
601f			CONTROL1:       EQU     30H 
601f			; 
601f			; CONSTANT ROM BASIC ROUTINE 
601f			; 
601f			ROM_BASPROMPT:  EQU     0081H 
601f			ROM_DSPCHR:     EQU     0257H 
601f			ROM_MOVECURSOR: EQU     03A9H 
601f			ROM_DSPCURSOR:  EQU     0BE2H 
601f			ROM_BEEP:       EQU     0D43H 
601f			ROM_KEYWAIT:    EQU     0F75H 
601f			ROM_KEYSCAN:    EQU     0FACH 
601f			ROM_TIMEREAD:   EQU     1602H 
601f			ROM_TIMEWRITE:  EQU     1663H 
601f			ROM_BIN2DECASC: EQU     309FH 
601f			ROM_SYNERR:     EQU     3BDFH 
601f			ROM_MSGOUT:     EQU     52EDH 
601f			ROM_MON_UNEXT:  EQU     5C35H 
601f			ROM_HEXASC2BIN: EQU     5E4BH 
601f			ROM_DSPHEX4:    EQU     5EC0H 
601f			ROM_CMPHLDE:    EQU     5ED3H 
601f			ROM_DSP1CHR:    EQU     5FB0H 
601f			ROM_DSPCRLF:    EQU     5FCAH 
601f			; 
601f			; CONSTANT ROM BASIC WORD AREA 
601f			; 
601f			PC8001RAM_TOP:  EQU     8000H 
601f			ROMBAS_WORKTOP: EQU     0EA00H 
601f			FUNKEY_DISPSTS: EQU     0EA60H 
601f			CRT_TEXT_ROWS:  EQU     0EA62H 
601f			CURSOR_YPOS:    EQU     0EA63H 
601f			CURSOR_XPOS:    EQU     0EA64H 
601f			CRT_TEXT_COLS:  EQU     0EA65H 
601f			CTL1_OUTDATA:   EQU     0EA66H 
601f			BCD_TIME_SEC:   EQU     0EA76H 
601f			BCD_TIME_YEAR:  EQU     0EA7BH      
601f			OUTPUT_DEVICE:  EQU     0EB49H 
601f			BASAREA_TOP:    EQU     0EB54H 
601f			VARAREA_TOP:    EQU     0EFA0H 
601f			ARRAYAREA_TOP:  EQU     0EFA2H 
601f			FREEAREA_TOP:   EQU     0EFA4H 
601f			BIN_ACC:        EQU     0F0A8H 
601f			CMD_ENTRY:      EQU     0F0FCH 
601f			; 
601f			; N-BASIC ROM FREE AREA1 : F216~F2FF 
601f			; N-BASIC ROM FREE AREA2 : FF3D~FFFF 
601f			; CONSTANT ESP32PC8001SIO WORK AREA 
601f			; 
601f			SAVESP:         EQU     0F216H 
601f			LISTCNT:        EQU     0F218H 
601f			SELLISTNO:      EQU     0F21AH 
601f			LOADADRS:       EQU     0F21CH 
601f			EXECADRS:       EQU     0F21EH 
601f			MODEWORD:       EQU     0F220H 
601f			CTLWORD:        EQU     0F221H 
601f			CMDNO:          EQU     0F222H 
601f			CHKBLKNO:       EQU     0F223H 
601f			LFRECVCOUNT:    EQU     0F224H 
601f			DISPBUF_TOP:    EQU     0F230H 
601f			SNDBUF_TOP:     EQU     0F270H 
601f			RCVBUF_TOP:     EQU     0F270H 
601f			RCVBUF_HEADER:  EQU     RCVBUF_TOP 
601f			RCVBUF_BLKNO:   EQU     RCVBUF_TOP +1 
601f			RCVBUF_CBLKNO:  EQU     RCVBUF_TOP +2 
601f			RCVBUF_DATA:    EQU     RCVBUF_TOP +3 
601f			RCVBUF_CHKSUM:  EQU     RCVBUF_DATA +128 
601f			RCVBUF_BOTTOM:  EQU     RCVBUF_CHKSUM 
601f			FLGDATA:        EQU     0F2FFH          ; 76543210 
601f			                                        ; |||||||+--- <CR><LF> first send 
601f			                                        ; ||||||+---- load basic cmt type        
601f			                                        ; |||||+----- sio recv time out (5sec) 
601f			                                        ; ||||+------ reserve 
601f			                                        ; |||+------- reserve 
601f			                                        ; ||+-------- reserve 
601f			                                        ; |+--------- reserve 
601f			                                        ; +---------- reserve 
601f			FLG_FIRSTSEND:  EQU     00000001B 
601f			FLG_LOADBAS:    EQU     00000010B 
601f			FLG_RCVTIMEOUT: EQU     00000100B 
601f			 
601f			; 
601f			; CONSTANT ESP32PC8001SIO VERSION DATA 
601f			; 
601f			VER_MAJOR:      EQU     1 
601f			VER_MINOR:      EQU     0 
601f			VER_REVISION:   EQU     0 
601f			; 
601f			                ;ORG    0H 
601f			CMD_START: 
601f ed 73 16 f2	                LD      (SAVESP),SP 
6023 eb			                EX      DE,HL 
6024 21 ff ff		                LD      HL,0FFFFH 
6027 f9			                LD      SP,HL 
6028 eb			                EX      DE,HL 
6029 cd d7 64		                CALL    PARSER_CMDPARAM 
602c da 40 60		                JP      C,CMD_SYNERR_EXIT 
602f fd e9		                JP      (IY) 
6031			CMD_EXIT: 
6031 af			                XOR     A 
6032			CMD_EXIT000: 
6032 eb			                EX      DE,HL 
6033 2a 16 f2		                LD      HL,(SAVESP) 
6036 f9			                LD      SP,HL 
6037 eb			                EX      DE,HL 
6038 fe 00		                CP      0 
603a 20 01		                JR      NZ,CMD_EXIT010 
603c c9			                RET 
603d			CMD_EXIT010: 
603d d1			                POP     DE 
603e dd e9		                JP      (IX) 
6040			CMD_SYNERR_EXIT: 
6040 3e 01		                LD      A,1 
6042 dd 21 df 3b	                LD      IX,ROM_SYNERR 
6046 18 ea		                JR      CMD_EXIT000 
6048			CMD_MYERR_EXIT: 
6048 3e 02		                LD      A,2 
604a dd 21 81 00	                LD      IX,ROM_BASPROMPT 
604e 18 e2		                JR      CMD_EXIT000 
6050			; 
6050			; 
6050			; 
6050			CMD_BME: 
6050 e5			                PUSH    HL 
6051 cd 31 66		                CALL    INIT_SIO 
6054 21 20 68		                LD      HL,TBL_CMD_BME 
6057 11 70 f2		                LD      DE,SNDBUF_TOP 
605a 01 03 00		                LD      BC,3 
605d ed b0		                LDIR 
605f 21 b9 68		                LD      HL,TBL_CRLF 
6062 01 02 00		                LD      BC,2 
6065 ed b0		                LDIR 
6067 06 05		                LD      B,5 
6069 cd 4a 67		                CALL    SENDBUF_OUT 
606c 06 01		                LD      B,1 
606e cd 55 67		                CALL    RECVBUF_IN 
6071 3a ff f2		                LD      A,(FLGDATA) 
6074 e6 04		                AND     FLG_RCVTIMEOUT 
6076 c2 a4 64		                JP      NZ,CMD_ERR1 
6079 11 20 68		                LD      DE,TBL_CMD_BME 
607c 06 03		                LD      B,3 
607e cd 8c 67		                CALL    RECVBUF_CHK 
6081 da a9 64		                JP      C,CMD_ERR2 
6084 06 00		                LD      B,0 
6086 cd 96 60		                CALL    CMD_BME_MSG 
6089 06 01		                LD      B,1 
608b cd 96 60		                CALL    CMD_BME_MSG 
608e 06 02		                LD      B,2 
6090 cd 96 60		                CALL    CMD_BME_MSG 
6093 c3 cf 64		                JP      CMD_END 
6096			CMD_BME_MSG: 
6096 e5			                PUSH    HL 
6097 78			                LD      A,B 
6098 fe 01		                CP      1 
609a 28 09		                JR      Z,CMD_BME_000 
609c fe 02		                CP      2 
609e 28 0a		                JR      Z,CMD_BME_010 
60a0 21 71 68		                LD      HL,TBL_TEMP_MSG0 
60a3 18 08		                JR      CMD_BME_020 
60a5			CMD_BME_000: 
60a5 21 7c 68		                LD      HL,TBL_HUMI_MSG0 
60a8 18 03		                JR      CMD_BME_020 
60aa			CMD_BME_010: 
60aa 21 86 68		                LD      HL,TBL_PRESS_MSG0 
60ad			CMD_BME_020: 
60ad 11 30 f2		                LD      DE,DISPBUF_TOP 
60b0			CMD_BME_L010: 
60b0 7e			                LD      A,(HL) 
60b1 12			                LD      (DE),A 
60b2 23			                INC     HL 
60b3 13			                INC     DE 
60b4 fe 00		                CP      0 
60b6 20 f8		                JR      NZ,CMD_BME_L010 
60b8 e1			                POP     HL 
60b9 1b			                DEC     DE 
60ba			CMD_BME_L020: 
60ba 7e			                LD      A,(HL) 
60bb fe 2c		                CP      ',' 
60bd 28 09		                JR      Z,CMD_BME_050 
60bf fe 0d		                CP      CR 
60c1 28 05		                JR      Z,CMD_BME_050 
60c3 12			                LD      (DE),A 
60c4 23			                INC     HL 
60c5 13			                INC     DE 
60c6 18 f2		                JR      CMD_BME_L020 
60c8			CMD_BME_050: 
60c8 23			                INC     HL 
60c9 e5			                PUSH    HL 
60ca 78			                LD      A,B 
60cb fe 01		                CP      1 
60cd 28 09		                JR      Z,CMD_BME_060 
60cf fe 02		                CP      2 
60d1 28 0a		                JR      Z,CMD_BME_070 
60d3 21 79 68		                LD      HL,TBL_TEMP_MSG1 
60d6 18 08		                JR      CMD_BME_L030 
60d8			CMD_BME_060: 
60d8 21 84 68		                LD      HL,TBL_HUMI_MSG1 
60db 18 03		                JR      CMD_BME_L030 
60dd			CMD_BME_070: 
60dd 21 8e 68		                LD      HL,TBL_PRESS_MSG1 
60e0			CMD_BME_L030: 
60e0 7e			                LD      A,(HL) 
60e1 12			                LD      (DE),A 
60e2 23			                INC     HL 
60e3 13			                INC     DE 
60e4 fe 00		                CP      0 
60e6 20 f8		                JR      NZ,CMD_BME_L030 
60e8 e1			                POP     HL 
60e9 1b			                DEC     DE 
60ea c5			                PUSH    BC 
60eb d5			                PUSH    DE 
60ec e5			                PUSH    HL 
60ed cd a2 67		                CALL    MSG_DISP 
60f0 e1			                POP     HL 
60f1 d1			                POP     DE 
60f2 c1			                POP     BC 
60f3 c9			                RET 
60f4			; 
60f4			; 
60f4			; 
60f4			CMD_FTPLIST: 
60f4 e5			                PUSH    HL 
60f5 cd 31 66		                CALL    INIT_SIO 
60f8 21 51 68		                LD      HL,TBL_CMD_FTPLIST2 
60fb 11 70 f2		                LD      DE,SNDBUF_TOP 
60fe 01 07 00		                LD      BC,7 
6101 ed b0		                LDIR 
6103 21 b9 68		                LD      HL,TBL_CRLF 
6106 01 02 00		                LD      BC,2 
6109 ed b0		                LDIR 
610b 06 09		                LD      B,9 
610d cd 4a 67		                CALL    SENDBUF_OUT 
6110 06 01		                LD      B,1 
6112 cd 55 67		                CALL    RECVBUF_IN 
6115 3a ff f2		                LD      A,(FLGDATA) 
6118 e6 04		                AND     FLG_RCVTIMEOUT 
611a c2 a4 64		                JP      NZ,CMD_ERR1 
611d 11 51 68		                LD      DE,TBL_CMD_FTPLIST2 
6120 06 07		                LD      B,7 
6122 cd 8c 67		                CALL    RECVBUF_CHK 
6125 da a9 64		                JP      C,CMD_ERR2 
6128 e5			                PUSH    HL 
6129 21 64 68		                LD      HL,TBL_COUNT_MSG0 
612c 11 30 f2		                LD      DE,DISPBUF_TOP 
612f			CMD_FTPLIST_L000: 
612f 7e			                LD      A,(HL) 
6130 12			                LD      (DE),A 
6131 23			                INC     HL 
6132 13			                INC     DE 
6133 fe 00		                CP      0 
6135 20 f8		                JR      NZ,CMD_FTPLIST_L000 
6137 1b			                DEC     DE 
6138 e1			                POP     HL 
6139 e5			                PUSH    HL 
613a 01 03 00		                LD      BC,3 
613d ed b0		                LDIR 
613f cd a2 67		                CALL    MSG_DISP 
6142 e1			                POP     HL 
6143			; 
6143 7e			                LD      A,(HL) 
6144 e6 0f		                AND     0FH 
6146 5f			                LD      E,A 
6147 3e 64		                LD      A,100 
6149 e5			                PUSH    HL 
614a cd b5 67		                CALL    MUL_88_2_16 
614d 22 18 f2		                LD      (LISTCNT),HL 
6150 e1			                POP     HL 
6151 23			                INC     HL 
6152 7e			                LD      A,(HL) 
6153 e6 0f		                AND     0FH 
6155 5f			                LD      E,A 
6156 3e 0a		                LD      A,10 
6158 e5			                PUSH    HL 
6159 cd b5 67		                CALL    MUL_88_2_16 
615c eb			                EX      DE,HL 
615d 2a 18 f2		                LD      HL,(LISTCNT) 
6160 19			                ADD     HL,DE 
6161 22 18 f2		                LD      (LISTCNT),HL 
6164 e1			                POP     HL 
6165 23			                INC     HL 
6166 7e			                LD      A,(HL) 
6167 e6 0f		                AND     0FH 
6169 5f			                LD      E,A 
616a 3e 01		                LD      A,1 
616c e5			                PUSH    HL 
616d cd b5 67		                CALL    MUL_88_2_16 
6170 eb			                EX      DE,HL 
6171 2a 18 f2		                LD      HL,(LISTCNT) 
6174 19			                ADD     HL,DE 
6175 22 18 f2		                LD      (LISTCNT),HL 
6178 e1			                POP     HL 
6179 2a 18 f2		                LD      HL,(LISTCNT) 
617c 11 00 00		                LD      DE,0 
617f cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
6182			                                        ; HL<DE : 0  1 
6182			                                        ; HL=DE : 1  0 
6182			                                        ; HL>DE : 0  0 
6182 ca cf 64		                JP      Z,CMD_END 
6185 ed 53 1a f2	                LD      (SELLISTNO),DE 
6189			CMD_FTPLIST_L010: 
6189 21 30 f2		                LD      HL,DISPBUF_TOP 
618c ed 5b 1a f2	                LD      DE,(SELLISTNO) 
6190 ed 53 a8 f0	                LD      (BIN_ACC),DE 
6194 01 00 00		                LD      BC,0 
6197 cd 9f 30		                CALL    ROM_BIN2DECASC 
619a 21 5f 68		                LD      HL,TBL_CMD_LIST 
619d 11 70 f2		                LD      DE,SNDBUF_TOP 
61a0 01 05 00		                LD      BC,5 
61a3 ed b0		                LDIR 
61a5 21 32 f2		                LD      HL,DISPBUF_TOP + 2 
61a8 01 03 00		                LD      BC,3 
61ab ed b0		                LDIR 
61ad 21 b9 68		                LD      HL,TBL_CRLF 
61b0 01 02 00		                LD      BC,2 
61b3 ed b0		                LDIR 
61b5 06 0a		                LD      B,10 
61b7 cd 4a 67		                CALL    SENDBUF_OUT 
61ba 06 01		                LD      B,1 
61bc cd 55 67		                CALL    RECVBUF_IN 
61bf 3a ff f2		                LD      A,(FLGDATA) 
61c2 e6 04		                AND     FLG_RCVTIMEOUT 
61c4 c2 a4 64		                JP      NZ,CMD_ERR1 
61c7 11 5f 68		                LD      DE,TBL_CMD_LIST 
61ca 06 04		                LD      B,4 
61cc cd 8c 67		                CALL    RECVBUF_CHK 
61cf da a9 64		                JP      C,CMD_ERR2 
61d2 11 30 f2		                LD      DE,DISPBUF_TOP 
61d5 01 03 00		                LD      BC,3 
61d8 ed b0		                LDIR 
61da 3e 3a		                LD      A,':' 
61dc 12			                LD      (DE),A 
61dd 13			                INC     DE 
61de 3a 65 ea		                LD      A,(CRT_TEXT_COLS) 
61e1 fe 48		                CP      72 
61e3 28 1a		                JR      Z,CMD_FTPLIST_040 
61e5 fe 50		                CP      80 
61e7 28 16		                JR      Z,CMD_FTPLIST_040 
61e9 06 04		                LD      B,4 
61eb			CMD_FTPLIST_010: 
61eb 7e			                LD      A,(HL) 
61ec 23			                INC     HL 
61ed fe 2c		                CP      ',' 
61ef 28 02		                JR      Z,CMD_FTPLIST_020 
61f1 18 f8		                JR      CMD_FTPLIST_010 
61f3			CMD_FTPLIST_020: 
61f3 10 f6		                DJNZ    CMD_FTPLIST_010 
61f5			CMD_FTPLIST_030: 
61f5 7e			                LD      A,(HL) 
61f6 12			                LD      (DE),A 
61f7 23			                INC     HL 
61f8 13			                INC     DE 
61f9 fe 0d		                CP      CR 
61fb 28 15		                JR      Z,CMD_FTPLIST_070 
61fd 18 f6		                JR      CMD_FTPLIST_030 
61ff			CMD_FTPLIST_040: 
61ff 23			                INC     HL 
6200			CMD_FTPLIST_L020: 
6200 7e			                LD      A,(HL) 
6201 fe 2c		                CP      ',' 
6203 28 06		                JR      Z,CMD_FTPLIST_050 
6205 fe 0d		                CP      CR 
6207 28 09		                JR      Z,CMD_FTPLIST_070 
6209 18 02		                JR      CMD_FTPLIST_060 
620b			CMD_FTPLIST_050: 
620b 3e 20		                LD      A,' ' 
620d			CMD_FTPLIST_060: 
620d 12			                LD      (DE),A 
620e 23			                INC     HL 
620f 13			                INC     DE 
6210 18 ee		                JR      CMD_FTPLIST_L020 
6212			CMD_FTPLIST_070: 
6212 cd a2 67		                CALL    MSG_DISP 
6215 db 09		                IN      A,(KEYBRD9) 
6217 57			                LD      D,A 
6218 e6 01		                AND     00000001B 
621a ca cf 64		                JP      Z,CMD_END 
621d 7a			                LD      A,D 
621e e6 80		                AND     10000000B 
6220 20 0d		                JR      NZ,CMD_FTPLIST_090 
6222			CMD_FTPLIST_080: 
6222 db 09		                IN      A,(KEYBRD9) 
6224 57			                LD      D,A 
6225 e6 01		                AND     00000001B 
6227 ca cf 64		                JP      Z,CMD_END 
622a 7a			                LD      A,D 
622b e6 80		                AND     10000000B 
622d 28 f3		                JR      Z,CMD_FTPLIST_080 
622f			CMD_FTPLIST_090: 
622f 2a 18 f2		                LD      HL,(LISTCNT) 
6232 ed 5b 1a f2	                LD      DE,(SELLISTNO) 
6236 13			                INC     DE 
6237 ed 53 1a f2	                LD      (SELLISTNO),DE 
623b cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
623e			                                        ; HL<DE : 0  1 
623e			                                        ; HL=DE : 1  0 
623e			                                        ; HL>DE : 0  0 
623e c2 89 61		                JP      NZ,CMD_FTPLIST_L010 
6241 c3 cf 64		                JP      CMD_END 
6244			; 
6244			; 
6244			; 
6244			CMD_FTPGET: 
6244 e5			                PUSH    HL 
6245 cd 31 66		                CALL    INIT_SIO 
6248 21 30 f2		                LD      HL,DISPBUF_TOP 
624b ed 5b 1a f2	                LD      DE,(SELLISTNO) 
624f ed 53 a8 f0	                LD      (BIN_ACC),DE 
6253 01 00 00		                LD      BC,0 
6256 cd 9f 30		                CALL    ROM_BIN2DECASC 
6259 21 58 68		                LD      HL,TBL_CMD_FTPGET2 
625c 11 70 f2		                LD      DE,SNDBUF_TOP 
625f 01 07 00		                LD      BC,7 
6262 ed b0		                LDIR 
6264 21 32 f2		                LD      HL,DISPBUF_TOP + 2 
6267 01 03 00		                LD      BC,3 
626a ed b0		                LDIR 
626c 21 b9 68		                LD      HL,TBL_CRLF 
626f 01 02 00		                LD      BC,2 
6272 ed b0		                LDIR 
6274 06 0c		                LD      B,12 
6276 cd 4a 67		                CALL    SENDBUF_OUT 
6279 06 01		                LD      B,1 
627b cd 55 67		                CALL    RECVBUF_IN 
627e 3a ff f2		                LD      A,(FLGDATA) 
6281 e6 04		                AND     FLG_RCVTIMEOUT 
6283 c2 a4 64		                JP      NZ,CMD_ERR1 
6286 11 58 68		                LD      DE,TBL_CMD_FTPGET2 
6289 06 06		                LD      B,6 
628b cd 8c 67		                CALL    RECVBUF_CHK 
628e da a9 64		                JP      C,CMD_ERR2 
6291 23			                INC     HL 
6292 23			                INC     HL 
6293 23			                INC     HL 
6294 23			                INC     HL 
6295 7e			                LD      A,(HL) 
6296 e6 0f		                AND     0FH 
6298 fe 00		                CP      0 
629a ca ae 64		                JP      Z,CMD_ERR3 
629d fe 01		                CP      1 
629f ca ad 62		                JP      Z,CMD_FTPGET_100 
62a2 fe 02		                CP      2 
62a4 28 1c		                JR      Z,CMD_FTPGET_110 
62a6 fe 03		                CP      3 
62a8 28 2a		                JR      Z,CMD_FTPGET_120 
62aa c3 a9 64		                JP      CMD_ERR2 
62ad			CMD_FTPGET_100: 
62ad ed 5b 1e f2	                LD      DE,(EXECADRS) 
62b1 e5			                PUSH    HL 
62b2 21 00 00		                LD      HL,0 
62b5 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
62b8			                                        ; HL<DE : 0  1 
62b8			                                        ; HL=DE : 1  0 
62b8			                                        ; HL>DE : 0  0 
62b8 e1			                POP     HL 
62b9 ca b3 64		                JP      Z,CMD_ERR4 
62bc ed 53 1c f2	                LD      (LOADADRS),DE 
62c0 18 28		                JR      CMD_FTPGET_200 
62c2			CMD_FTPGET_110: 
62c2 3a ff f2		                LD      A,(FLGDATA) 
62c5 f6 02		                OR      FLG_LOADBAS 
62c7 32 ff f2		                LD      (FLGDATA),A 
62ca ed 5b 54 eb	                LD      DE,(BASAREA_TOP) 
62ce ed 53 1c f2	                LD      (LOADADRS),DE 
62d2 18 16		                JR      CMD_FTPGET_200 
62d4			CMD_FTPGET_120: 
62d4 23			                INC     HL 
62d5 23			                INC     HL 
62d6 06 04		                LD      B,4 
62d8 11 00 00		                LD      DE,0 
62db			CMD_FTPGET_130: 
62db 7e			                LD      A,(HL) 
62dc e5			                PUSH    HL 
62dd eb			                EX      DE,HL 
62de cd 4b 5e		                CALL    ROM_HEXASC2BIN 
62e1 eb			                EX      DE,HL 
62e2 e1			                POP     HL 
62e3 23			                INC     HL 
62e4 10 f5		                DJNZ    CMD_FTPGET_130 
62e6 ed 53 1c f2	                LD      (LOADADRS),DE 
62ea			CMD_FTPGET_200: 
62ea 3e 01		                LD      A,1 
62ec 32 23 f2		                LD      (CHKBLKNO),A 
62ef			CMD_FTPGET_L010: 
62ef 3e 15		                LD      A,NAK 
62f1 cd 3f 67		                CALL    OUT_SIO 
62f4			CMD_FTPGET_L020: 
62f4 cd e6 66		                CALL    IN_SIO 
62f7 fe 04		                CP      EOT 
62f9 28 77		                JR      Z,CMD_FTPGET_030 
62fb fe 01		                CP      SOH 
62fd 28 2c		                JR      Z,CMD_FTPGET_010 
62ff 3a ff f2		                LD      A,(FLGDATA) 
6302 e6 04		                AND     FLG_RCVTIMEOUT 
6304 20 e9		                JR      NZ,CMD_FTPGET_L010 
6306 db 09		                IN      A,(KEYBRD9) 
6308 e6 01		                AND     00000001B 
630a ca cb 63		                JP      Z,CMD_FTPGET_CANCEL 
630d 18 e5		                JR      CMD_FTPGET_L020 
630f			CMD_FTPGET_L030: 
630f cd e6 66		                CALL    IN_SIO 
6312 fe 04		                CP      EOT 
6314 28 5c		                JR      Z,CMD_FTPGET_030 
6316 fe 01		                CP      SOH 
6318 28 11		                JR      Z,CMD_FTPGET_010 
631a 3a ff f2		                LD      A,(FLGDATA) 
631d e6 04		                AND     FLG_RCVTIMEOUT 
631f c2 b7 63		                JP      NZ,CMD_FTPGET_CANCEL2 
6322 db 09		                IN      A,(KEYBRD9) 
6324 e6 01		                AND     00000001B 
6326 ca cb 63		                JP      Z,CMD_FTPGET_CANCEL 
6329 18 e4		                JR      CMD_FTPGET_L030 
632b			CMD_FTPGET_010: 
632b cd a9 65		                CALL    CLR_RCVBUF 
632e 77			                LD      (HL),A 
632f 23			                INC     HL 
6330 06 83		                LD      B,131 
6332			CMD_FTPGET_L040: 
6332 cd e6 66		                CALL    IN_SIO 
6335 f5			                PUSH    AF 
6336 3a ff f2		                LD      A,(FLGDATA) 
6339 e6 04		                AND     FLG_RCVTIMEOUT 
633b 20 79		                JR      NZ,CMD_FTPGET_CANCEL3 
633d f1			                POP     AF 
633e 77			                LD      (HL),A 
633f 23			                INC     HL 
6340 10 f0		                DJNZ    CMD_FTPGET_L040 
6342			; 
6342 cd de 66		                CALL    DISABLE_RTS 
6345 cd e0 65		                CALL    CHKDATA 
6348 38 1e		                JR      C,CMD_FTPGET_020 
634a cd b8 65		                CALL    CHK_MEMOVER 
634d 38 68		                JR      C,CMD_FTPGET_CANCEL2 
634f 21 73 f2		                LD      HL,RCVBUF_DATA 
6352 01 80 00		                LD      BC,128 
6355 ed b0		                LDIR 
6357 cd 0d 66		                CALL    DISP_PROGRESS 
635a cd d6 66		                CALL    ENABLE_RTS 
635d			; 
635d 3e 06		                LD      A,ACK 
635f cd 3f 67		                CALL    OUT_SIO         
6362 21 23 f2		                LD      HL,CHKBLKNO 
6365 34			                INC     (HL) 
6366 18 a7		                JR      CMD_FTPGET_L030 
6368			CMD_FTPGET_020: 
6368 cd d6 66		                CALL    ENABLE_RTS 
636b 3e 15		                LD      A,NAK 
636d cd 3f 67		                CALL    OUT_SIO         
6370 18 9d		                JR      CMD_FTPGET_L030 
6372			CMD_FTPGET_030: 
6372 3e 06		                LD      A,ACK 
6374 cd 3f 67		                CALL    OUT_SIO 
6377 3e 01		                LD      A,1 
6379 cd 8c 66		                CALL    TERM_SIO 
637c e1			                POP     HL 
637d 3a ff f2		                LD      A,(FLGDATA) 
6380 e6 02		                AND     FLG_LOADBAS 
6382 20 15		                JR      NZ,CMD_FTPGET_FIXBAS 
6384 e5			                PUSH    HL 
6385 21 00 00		                LD      HL,0 
6388 ed 5b 1e f2	                LD      DE,(EXECADRS) 
638c cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
638f			                                        ; HL<DE : 0  1 
638f			                                        ; HL=DE : 1  0 
638f			                                        ; HL>DE : 0  0 
638f e1			                POP     HL 
6390 ca 31 60		                JP      Z,CMD_EXIT 
6393 2a 16 f2		                LD      HL,(SAVESP) 
6396 f9			                LD      SP,HL 
6397 eb			                EX      DE,HL 
6398 e9			                JP      (HL) 
6399			CMD_FTPGET_FIXBAS: 
6399 e5			                PUSH    HL 
639a d5			                PUSH    DE 
639b 2a 1c f2		                LD      HL,(LOADADRS) 
639e eb			                EX      DE,HL 
639f ed 52		                SBC     HL,DE 
63a1 e5			                PUSH    HL 
63a2 c1			                POP     BC 
63a3 e1			                POP     HL 
63a4 af			                XOR     A 
63a5 ed b9		                CPDR 
63a7 23			                INC     HL 
63a8 23			                INC     HL 
63a9 22 a0 ef		                LD      (VARAREA_TOP),  HL 
63ac 22 a2 ef		                LD      (ARRAYAREA_TOP),HL 
63af 22 a4 ef		                LD      (FREEAREA_TOP), HL 
63b2 e1			                POP     HL 
63b3 c3 31 60		                JP      CMD_EXIT 
63b6			CMD_FTPGET_CANCEL3: 
63b6 f1			                POP     AF 
63b7			CMD_FTPGET_CANCEL2: 
63b7 cd ca 5f		                CALL    ROM_DSPCRLF 
63ba af			                XOR     A 
63bb 32 49 eb		                LD      (OUTPUT_DEVICE),A 
63be 3c			                INC     A 
63bf 32 64 ea		                LD      (CURSOR_XPOS),A 
63c2 21 c4 67		                LD      HL,ERR_MSG_000 
63c5 cd ed 52		                CALL    ROM_MSGOUT 
63c8 cd 43 0d		                CALL    ROM_BEEP 
63cb			CMD_FTPGET_CANCEL: 
63cb 3e 18		                LD      A,CAN 
63cd cd 3f 67		                CALL    OUT_SIO 
63d0 3e 01		                LD      A,1 
63d2 cd 8c 66		                CALL    TERM_SIO 
63d5 e1			                POP     HL 
63d6 c3 31 60		                JP      CMD_EXIT 
63d9			; 
63d9			; 
63d9			; 
63d9			CMD_SNTP: 
63d9 e5			                PUSH    HL 
63da cd 31 66		                CALL    INIT_SIO 
63dd 21 3d 68		                LD      HL,TBL_CMD_SNTP 
63e0 11 70 f2		                LD      DE,SNDBUF_TOP 
63e3 01 04 00		                LD      BC,4 
63e6 ed b0		                LDIR 
63e8 21 b9 68		                LD      HL,TBL_CRLF 
63eb 01 02 00		                LD      BC,2 
63ee ed b0		                LDIR 
63f0 06 06		                LD      B,6 
63f2 cd 4a 67		                CALL    SENDBUF_OUT 
63f5 06 01		                LD      B,1 
63f7 cd 55 67		                CALL    RECVBUF_IN 
63fa 3a ff f2		                LD      A,(FLGDATA) 
63fd e6 04		                AND     FLG_RCVTIMEOUT 
63ff c2 a4 64		                JP      NZ,CMD_ERR1 
6402 11 3d 68		                LD      DE,TBL_CMD_SNTP 
6405 06 04		                LD      B,4 
6407 cd 8c 67		                CALL    RECVBUF_CHK 
640a da a9 64		                JP      C,CMD_ERR2 
640d 11 7b ea		                LD      DE,BCD_TIME_YEAR 
6410 23			                INC     HL 
6411 23			                INC     HL 
6412			CMD_SNTP_L000: 
6412 7e			                LD      A,(HL) 
6413 e6 0f		                AND     0FH 
6415 cb 27		                SLA     A 
6417 cb 27		                SLA     A 
6419 cb 27		                SLA     A 
641b cb 27		                SLA     A 
641d 47			                LD      B,A 
641e 23			                INC     HL 
641f 7e			                LD      A,(HL) 
6420 e6 0f		                AND     0FH 
6422 b0			                OR      B 
6423 12			                LD      (DE),A 
6424 23			                INC     HL 
6425 1b			                DEC     DE 
6426 7e			                LD      A,(HL) 
6427 fe 0d		                CP      CR 
6429 28 03		                JR      Z,CMD_SNTP_000 
642b 23			                INC     HL 
642c 18 e4		                JR      CMD_SNTP_L000 
642e			CMD_SNTP_000: 
642e cd 63 16		                CALL    ROM_TIMEWRITE 
6431 c3 cf 64		                JP      CMD_END 
6434			; 
6434			; 
6434			; 
6434			CMD_VER: 
6434 e5			                PUSH    HL 
6435 cd 31 66		                CALL    INIT_SIO 
6438 21 47 68		                LD      HL,TBL_CMD_VER 
643b 11 70 f2		                LD      DE,SNDBUF_TOP 
643e 01 03 00		                LD      BC,3 
6441 ed b0		                LDIR 
6443 21 b9 68		                LD      HL,TBL_CRLF 
6446 01 02 00		                LD      BC,2 
6449 ed b0		                LDIR 
644b 06 05		                LD      B,5 
644d cd 4a 67		                CALL    SENDBUF_OUT 
6450 06 01		                LD      B,1 
6452 cd 55 67		                CALL    RECVBUF_IN 
6455 3a ff f2		                LD      A,(FLGDATA) 
6458 e6 04		                AND     FLG_RCVTIMEOUT 
645a 20 48		                JR      NZ,CMD_ERR1 
645c 11 47 68		                LD      DE,TBL_CMD_VER 
645f 06 03		                LD      B,3 
6461 cd 8c 67		                CALL    RECVBUF_CHK 
6464 38 43		                JR      C,CMD_ERR2 
6466 e5			                PUSH    HL 
6467 21 92 68		                LD      HL,TBL_ESP32_VER 
646a 11 30 f2		                LD      DE,DISPBUF_TOP 
646d			CMD_VER_L010: 
646d 7e			                LD      A,(HL) 
646e 12			                LD      (DE),A 
646f 23			                INC     HL 
6470 13			                INC     DE 
6471 fe 00		                CP      0 
6473 20 f8		                JR      NZ,CMD_VER_L010 
6475 e1			                POP     HL 
6476 1b			                DEC     DE 
6477			CMD_VER_L020: 
6477 7e			                LD      A,(HL) 
6478 fe 2c		                CP      ',' 
647a 28 06		                JR      Z,CMD_VER_010 
647c fe 0d		                CP      CR 
647e 28 09		                JR      Z,CMD_VER_030 
6480 18 02		                JR      CMD_VER_020 
6482			CMD_VER_010: 
6482 3e 2e		                LD      A,'.' 
6484			CMD_VER_020: 
6484 12			                LD      (DE),A 
6485 23			                INC     HL 
6486 13			                INC     DE 
6487 18 ee		                JR      CMD_VER_L020 
6489			CMD_VER_030: 
6489 cd a2 67		                CALL    MSG_DISP 
648c 21 a3 68		                LD      HL,TBL_SIO_VER 
648f 11 30 f2		                LD      DE,DISPBUF_TOP 
6492			CMD_VER_L030: 
6492 7e			                LD      A,(HL) 
6493 12			                LD      (DE),A 
6494 23			                INC     HL 
6495 13			                INC     DE 
6496 fe 00		                CP      0 
6498 20 f8		                JR      NZ,CMD_VER_L030 
649a cd a2 67		                CALL    MSG_DISP 
649d 18 30		                JR      CMD_END 
649f			; 
649f			; 
649f			; 
649f			CMD_ERR0: 
649f 21 c4 67		                LD      HL,ERR_MSG_000 
64a2 18 12		                JR      CMD_ERR 
64a4			CMD_ERR1: 
64a4 21 d2 67		                LD      HL,ERR_MSG_001 
64a7 18 0d		                JR      CMD_ERR 
64a9			CMD_ERR2: 
64a9 21 e3 67		                LD      HL,ERR_MSG_002 
64ac 18 08		                JR      CMD_ERR 
64ae			CMD_ERR3: 
64ae 21 fd 67		                LD      HL,ERR_MSG_003 
64b1 18 03		                JR      CMD_ERR 
64b3			CMD_ERR4: 
64b3 21 0b 68		                LD      HL,ERR_MSG_004 
64b6			CMD_ERR: 
64b6 af			                XOR     A 
64b7 32 49 eb		                LD      (OUTPUT_DEVICE),A 
64ba 3c			                INC     A 
64bb 32 64 ea		                LD      (CURSOR_XPOS),A 
64be cd ed 52		                CALL    ROM_MSGOUT 
64c1 cd ca 5f		                CALL    ROM_DSPCRLF 
64c4 cd 43 0d		                CALL    ROM_BEEP 
64c7 af			                XOR     A 
64c8 cd 8c 66		                CALL    TERM_SIO 
64cb e1			                POP     HL 
64cc c3 48 60		                JP      CMD_MYERR_EXIT 
64cf			CMD_END: 
64cf af			                XOR     A 
64d0 cd 8c 66		                CALL    TERM_SIO 
64d3 e1			                POP     HL 
64d4 c3 31 60		                JP      CMD_EXIT 
64d7			; 
64d7			; 
64d7			; 
64d7			PARSER_CMDPARAM: 
64d7 e5			                PUSH    HL 
64d8 21 00 00		                LD      HL,0 
64db 22 1c f2		                LD      (LOADADRS),HL 
64de 22 1e f2		                LD      (EXECADRS),HL 
64e1 af			                XOR     A 
64e2 32 22 f2		                LD      (CMDNO),A 
64e5 3a ff f2		                LD      A,(FLGDATA) 
64e8 e6 fd		                AND     ~FLG_LOADBAS 
64ea e6 fb		                AND     ~FLG_RCVTIMEOUT 
64ec 32 ff f2		                LD      (FLGDATA),A 
64ef e1			                POP     HL 
64f0 11 20 68		                LD      DE,TBL_CMD 
64f3			PARSER_CMDPARAM_000: 
64f3 1a			                LD      A,(DE) 
64f4 fe 00		                CP      0 
64f6 ca a7 65		                JP      Z,SETCFRET 
64f9 e5			                PUSH    HL 
64fa			PARSER_CMDPARAM_010: 
64fa be			                CP      (HL) 
64fb 20 09		                JR      NZ,PARSER_CMDPARAM_020 
64fd 23			                INC     HL 
64fe 13			                INC     DE 
64ff 1a			                LD      A,(DE) 
6500 fe 00		                CP      0 
6502 28 11		                JR      Z,PARSER_CMDPARAM_040 
6504 18 f4		                JR      PARSER_CMDPARAM_010 
6506			PARSER_CMDPARAM_020: 
6506 e1			                POP     HL 
6507			PARSER_CMDPARAM_030: 
6507 13			                INC     DE 
6508 1a			                LD      A,(DE) 
6509 fe 00		                CP      0 
650b 20 fa		                JR      NZ,PARSER_CMDPARAM_030 
650d 13			                INC     DE 
650e 13			                INC     DE 
650f 13			                INC     DE 
6510 13			                INC     DE 
6511 13			                INC     DE 
6512 13			                INC     DE 
6513 18 de		                JR      PARSER_CMDPARAM_000 
6515			PARSER_CMDPARAM_040: 
6515 2b			                DEC     HL 
6516 13			                INC     DE 
6517 1a			                LD      A,(DE) 
6518 32 22 f2		                LD      (CMDNO),A 
651b 13			                INC     DE 
651c e5			                PUSH    HL 
651d 1a			                LD      A,(DE) 
651e 6f			                LD      L,A 
651f 13			                INC     DE 
6520 1a			                LD      A,(DE) 
6521 67			                LD      H,A 
6522 e5			                PUSH    HL 
6523 dd e1		                POP     IX 
6525 13			                INC     DE 
6526 1a			                LD      A,(DE) 
6527 6f			                LD      L,A 
6528 13			                INC     DE 
6529 1a			                LD      A,(DE) 
652a 67			                LD      H,A 
652b e5			                PUSH    HL 
652c fd e1		                POP     IY 
652e e1			                POP     HL 
652f d1			                POP     DE 
6530 dd e9		                JP      (IX) 
6532			PARSER_CMD_BME: 
6532			PARSER_CMD_FTPLIST: 
6532			PARSER_CMD_SNTP: 
6532			PARSER_CMD_VER: 
6532 23			                INC     HL 
6533 7e			                LD      A,(HL) 
6534 fe 00		                CP      0 
6536 28 6c		                JR      Z,CLRCFRET 
6538 fe 3a		                CP      ':' 
653a 28 68		                JR      Z,CLRCFRET 
653c 18 69		                JR      SETCFRET 
653e			PARSER_CMD_FTPGET: 
653e cd 90 65		                CALL    PARSER_SKIP 
6541 fe 0f		                CP      0FH             ; ID CODE 0FH : 1 byte hex 
6543 28 17		                JR      Z,PARSER_CMD_FTPGET_010 
6545 fe 11		                CP      11H             ; ID CODE 11H -> 0, 12H -> 1, ... 19H -> 8, 1AH -> 9 
6547 28 0c		                JR      Z,PARSER_CMD_FTPGET_000 
6549 fe 1a		                CP      1AH 
654b 38 08		                JR      C,PARSER_CMD_FTPGET_000 
654d 28 06		                JR      Z,PARSER_CMD_FTPGET_000 
654f fe 1c		                CP      1CH             ; ID CODE 0CH : 2 byte hex 
6551 28 0f		                JR      Z,PARSER_CMD_FTPGET_020 
6553 18 52		                JR      SETCFRET 
6555			PARSER_CMD_FTPGET_000: 
6555 d6 11		                SUB     A,11H 
6557 5f			                LD      E,A 
6558 af			                XOR     A 
6559 57			                LD      D,A 
655a 18 0a		                JR      PARSER_CMD_FTPGET_030 
655c			PARSER_CMD_FTPGET_010: 
655c 23			                INC     HL 
655d 5e			                LD      E,(HL) 
655e af			                XOR     A 
655f 57			                LD      D,A 
6560 18 04		                JR      PARSER_CMD_FTPGET_030 
6562			PARSER_CMD_FTPGET_020: 
6562 23			                INC     HL 
6563 5e			                LD      E,(HL) 
6564 23			                INC     HL 
6565 56			                LD      D,(HL) 
6566			PARSER_CMD_FTPGET_030: 
6566 ed 53 1a f2	                LD      (SELLISTNO),DE 
656a 23			                INC     HL 
656b 7e			                LD      A,(HL) 
656c fe 00		                CP      0 
656e 28 34		                JR      Z,CLRCFRET 
6570 fe 3a		                CP      ':' 
6572 28 30		                JR      Z,CLRCFRET 
6574 2b			                DEC     HL 
6575 cd 90 65		                CALL    PARSER_SKIP 
6578 fe 0c		                CP      0CH             ; ID CODE "&H" 
657a 20 2b		                JR      NZ,SETCFRET 
657c 23			                INC     HL 
657d 5e			                LD      E,(HL) 
657e 23			                INC     HL 
657f 56			                LD      D,(HL) 
6580 ed 53 1e f2	                LD      (EXECADRS),DE 
6584 23			                INC     HL 
6585 7e			                LD      A,(HL) 
6586 fe 00		                CP      0 
6588 28 1a		                JR      Z,CLRCFRET 
658a fe 3a		                CP      ':' 
658c 28 16		                JR      Z,CLRCFRET 
658e 18 17		                JR      SETCFRET 
6590			PARSER_SKIP: 
6590 23			                INC     HL 
6591 7e			                LD      A,(HL) 
6592 fe 20		                CP      ' ' 
6594 28 fa		                JR      Z,PARSER_SKIP 
6596 fe 2c		                CP      ',' 
6598 28 03		                JR      Z,PARSER_SKIP_010 
659a d1			                POP     DE 
659b 18 0a		                JR      SETCFRET 
659d			PARSER_SKIP_010: 
659d 23			                INC     HL 
659e 7e			                LD      A,(HL) 
659f fe 20		                CP      ' ' 
65a1 28 fa		                JR      Z,PARSER_SKIP_010 
65a3 c9			                RET 
65a4			CLRCFRET: 
65a4 37			                SCF 
65a5 3f			                CCF 
65a6 c9			                RET 
65a7			SETCFRET: 
65a7 37			                SCF 
65a8 c9			                RET 
65a9			; 
65a9			; 
65a9			; 
65a9			CLR_RCVBUF: 
65a9 21 70 f2		                LD      HL,RCVBUF_TOP 
65ac f5			                PUSH    AF 
65ad e5			                PUSH    HL 
65ae 06 84		                LD      B,RCVBUF_BOTTOM - RCVBUF_TOP + 1 
65b0 af			                XOR     A 
65b1			CLR_RCVBUF_L010: 
65b1 77			                LD      (HL),A 
65b2 23			                INC     HL 
65b3 10 fc		                DJNZ    CLR_RCVBUF_L010 
65b5 e1			                POP     HL 
65b6 f1			                POP     AF 
65b7 c9			                RET 
65b8			; 
65b8			; 
65b8			; 
65b8			CHK_MEMOVER: 
65b8 01 80 00		                LD      BC,128 
65bb d5			                PUSH    DE 
65bc 21 00 60		                LD      HL,_PROG_TOP 
65bf 11 00 80		                LD      DE,PC8001RAM_TOP 
65c2 cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
65c5			                                        ; HL<DE : 0  1 
65c5			                                        ; HL=DE : 1  0 
65c5			                                        ; HL>DE : 0  0 
65c5 d1			                POP     DE 
65c6 38 0c		                JR      C,CHK_MEMOVER_010 
65c8 d5			                PUSH    DE 
65c9 eb			                EX      DE,HL 
65ca 09			                ADD     HL,BC 
65cb eb			                EX      DE,HL 
65cc 21 00 60		                LD      HL,_PROG_TOP 
65cf cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
65d2			                                        ; HL<DE : 0  1 
65d2			                                        ; HL=DE : 1  0 
65d2			                                        ; HL>DE : 0  0 
65d2 d1			                POP     DE 
65d3 d8			                RET     C 
65d4			CHK_MEMOVER_010: 
65d4 d5			                PUSH    DE 
65d5 eb			                EX      DE,HL 
65d6 09			                ADD     HL,BC 
65d7 eb			                EX      DE,HL 
65d8 21 00 ea		                LD      HL,ROMBAS_WORKTOP 
65db cd d3 5e		                CALL    ROM_CMPHLDE     ;         Z CY 
65de			                                        ; HL<DE : 0  1 
65de			                                        ; HL=DE : 1  0 
65de			                                        ; HL>DE : 0  0 
65de d1			                POP     DE 
65df c9			                RET 
65e0			; 
65e0			; 
65e0			; 
65e0			CHKDATA: 
65e0 21 70 f2		                LD      HL,RCVBUF_TOP 
65e3 7e			                LD      A,(HL) 
65e4 fe 01		                CP      SOH 
65e6 20 bf		                JR      NZ,SETCFRET 
65e8 4f			                LD      C,A 
65e9 23			                INC     HL 
65ea 3a 23 f2		                LD      A,(CHKBLKNO) 
65ed be			                CP      (HL) 
65ee 20 b7		                JR      NZ,SETCFRET 
65f0 81			                ADD     A,C 
65f1 4f			                LD      C,A 
65f2 23			                INC     HL 
65f3 3a 23 f2		                LD      A,(CHKBLKNO) 
65f6 2f			                CPL 
65f7 be			                CP      (HL) 
65f8 20 ad		                JR      NZ,SETCFRET 
65fa 81			                ADD     A,C 
65fb 4f			                LD      C,A 
65fc 23			                INC     HL 
65fd 06 80		                LD      B,128 
65ff			CHKDATA_L010: 
65ff 7e			                LD      A,(HL) 
6600 81			                ADD     A,C 
6601 4f			                LD      C,A 
6602 23			                INC     HL 
6603 10 fa		                DJNZ    CHKDATA_L010 
6605 79			                LD      A,C 
6606 be			                CP      (HL) 
6607 c2 a7 65		                JP      NZ,SETCFRET 
660a c3 a4 65		                JP      CLRCFRET 
660d			; 
660d			; 
660d			; 
660d			DISP_PROGRESS: 
660d d5			                PUSH    DE 
660e e5			                PUSH    HL 
660f 3e 01		                LD      A,1 
6611 32 64 ea		                LD      (CURSOR_XPOS),A 
6614 3e 5b		                LD      A,'[' 
6616 cd 57 02		                CALL    ROM_DSPCHR 
6619 2a 1c f2		                LD      HL,(LOADADRS) 
661c cd c0 5e		                CALL    ROM_DSPHEX4 
661f 3e 2d		                LD      A,'-' 
6621 cd 57 02		                CALL    ROM_DSPCHR 
6624 eb			                EX      DE,HL 
6625 2b			                DEC     HL 
6626 cd c0 5e		                CALL    ROM_DSPHEX4 
6629 3e 5d		                LD      A,']' 
662b cd 57 02		                CALL    ROM_DSPCHR 
662e e1			                POP     HL 
662f d1			                POP     DE 
6630 c9			                RET 
6631			; 
6631			; 
6631			; 
6631			INIT_SIO: 
6631 cd ae 66		                CALL    ENABLE_SIO 
6634 af			                XOR     A               ; DUMMY OUT 
6635 d3 21		                OUT     (USARTCW),A 
6637 d3 21		                OUT     (USARTCW),A 
6639 d3 21		                OUT     (USARTCW),A 
663b 3e 40		                LD      A,01000000B     ; SOFT RESET 
663d d3 21		                OUT     (USARTCW),A 
663f 3e 4e		                LD      A,01001110B     ; MODE SETUP                    : 8N11 
6641			                                        ; BAUD RATE FACTOR              : 16X 
6641			                                        ; CHARACTER LENGTH              : 8BITS 
6641			                                        ; PARITY ENABLE                 : DISABLE 
6641			                                        ; EVEN PARITY GENARATION/CHECK  : ODD 
6641			                                        ; NUMBER OF STOP BITS           : 1 BIT 
6641 d3 21		                OUT     (USARTCW),A 
6643 32 20 f2		                LD      (MODEWORD),A 
6646 3e 05		                LD      A,00000101B     ; COMMAND SETUP  TRANSMIT ENABLE 
6648			                                        ;                DATA TERMINAL READY : FALSE 
6648			                                        ;                RECEIVE ENABLE 
6648			                                        ;                ERROR RESET         : FALSE 
6648			                                        ;                REQUEST TO SEND     : FALSE 
6648 d3 21		                OUT     (USARTCW),A 
664a 32 21 f2		                LD      (CTLWORD),A 
664d cd c6 66		                CALL    ENABLE_DTR 
6650 cd d6 66		                CALL    ENABLE_RTS 
6653			INIT_SIO_000: 
6653 db 21		                IN      A,(USARTCW)     ; ESP32-WROOM-32 -> 8251 power-on receive dust removal support 
6655 57			                LD      D,A 
6656 e6 38		                AND     00111000B 
6658 20 29		                JR      NZ,INIT_SIO_010 
665a 7a			                LD      A,D 
665b e6 02		                AND     00000010B 
665d 28 04		                JR      Z,INIT_SIO_020 
665f db 20		                IN      A,(USARTDW) 
6661 18 f0		                JR      INIT_SIO_000 
6663			INIT_SIO_020: 
6663 3a ff f2		                LD      A,(FLGDATA) 
6666 e6 01		                AND     FLG_FIRSTSEND 
6668 20 18		                JR      NZ,INIT_SIO_030 
666a 11 70 f2		                LD      DE,SNDBUF_TOP   ; 8251 -> ESP32-WROOM-32 power-on send dust removal support 
666d 21 b9 68		                LD      HL,TBL_CRLF 
6670 01 02 00		                LD      BC,2 
6673 ed b0		                LDIR 
6675 06 02		                LD      B,2 
6677 cd 4a 67		                CALL    SENDBUF_OUT 
667a 3a ff f2		                LD      A,(FLGDATA) 
667d f6 01		                OR      FLG_FIRSTSEND 
667f 32 ff f2		                LD      (FLGDATA),A 
6682			INIT_SIO_030: 
6682 c9			                RET 
6683			INIT_SIO_010: 
6683 3a 21 f2		                LD      A,(CTLWORD) 
6686 f6 10		                OR      00010000B 
6688 d3 21		                OUT     (USARTCW),A 
668a 18 c7		                JR      INIT_SIO_000 
668c			; 
668c			; A :  0 no wait term sio 
668c			;   : !0 1sec wait term sio 
668c			; 
668c			TERM_SIO: 
668c d5			                PUSH    DE 
668d fe 00		                CP      0 
668f 28 12		                JR      Z,TERM_SIO_020 
6691 cd 02 16		                CALL    ROM_TIMEREAD 
6694 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
6697 57			                LD      D,A 
6698			TERM_SIO_010: 
6698 d5			                PUSH    DE 
6699 cd 02 16		                CALL    ROM_TIMEREAD 
669c d1			                POP     DE 
669d 3a 76 ea		                LD      A,(BCD_TIME_SEC) 
66a0 ba			                CP      D 
66a1 28 f5		                JR      Z,TERM_SIO_010 
66a3			TERM_SIO_020: 
66a3 cd de 66		                CALL    DISABLE_RTS 
66a6 cd ce 66		                CALL    DISABLE_DTR 
66a9 cd bb 66		                CALL    DISABLE_SIO 
66ac d1			                POP     DE 
66ad c9			                RET 
66ae			; 
66ae			; 
66ae			; 
66ae			ENABLE_SIO: 
66ae 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
66b1 e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
66b3 f6 20		                OR      00100000B       ; BS2 ON 
66b5 d3 30		                OUT     (CONTROL1),A 
66b7 32 66 ea		                LD      (CTL1_OUTDATA),A 
66ba c9			                RET 
66bb			; 
66bb			; 
66bb			; 
66bb			DISABLE_SIO: 
66bb 3a 66 ea		                LD      A,(CTL1_OUTDATA) 
66be e6 cf		                AND     11001111B       ; BS2,BS1 CLR 
66c0 d3 30		                OUT     (CONTROL1),A 
66c2 32 66 ea		                LD      (CTL1_OUTDATA),A 
66c5 c9			                RET 
66c6			; 
66c6			; 
66c6			; 
66c6			ENABLE_DTR: 
66c6 3a 21 f2		                LD      A,(CTLWORD) 
66c9 f6 02		                OR      00000010B       ; DATA TERMINAL READY : TRUE 
66cb d3 21		                OUT     (USARTCW),A 
66cd c9			                RET 
66ce			; 
66ce			; 
66ce			; 
66ce			DISABLE_DTR: 
66ce 3a 21 f2		                LD      A,(CTLWORD) 
66d1 e6 fd		                AND     11111101B       ; DATA TERMINAL READY : FALSE 
66d3 d3 21		                OUT     (USARTCW),A 
66d5 c9			                RET 
66d6			; 
66d6			; 
66d6			; 
66d6			ENABLE_RTS: 
66d6 3a 21 f2		                LD      A,(CTLWORD) 
66d9 f6 20		                OR      00100000B       ; REQUEST TO SEND : TRUE 
66db d3 21		                OUT     (USARTCW),A 
66dd c9			                RET 
66de			; 
66de			; 
66de			; 
66de			DISABLE_RTS: 
66de 3a 21 f2		                LD      A,(CTLWORD) 
66e1 e6 df		                AND     11011111B       ; REQUEST TO SEND : FALSE 
66e3 d3 21		                OUT     (USARTCW),A 
66e5 c9			                RET 
66e6			; 
66e6			; 
66e6			; 
66e6			IN_SIO: 
66e6 3a ff f2		                LD      A,(FLGDATA) 
66e9 e6 fb		                AND     ~FLG_RCVTIMEOUT 
66eb 32 ff f2		                LD      (FLGDATA),A 
66ee c5			                PUSH    BC 
66ef d5			                PUSH    DE 
66f0 e5			                PUSH    HL 
66f1 21 03 00		                LD      HL,3            ; 5194msec Timer 
66f4 01 00 80		                LD      BC,8000H 
66f7			IN_SIO_010: 
66f7 db 21		                IN      A,(USARTCW) 
66f9 57			                LD      D,A 
66fa e6 38		                AND     00111000B 
66fc 20 2c		                JR      NZ,IN_SIO_050 
66fe 7a			                LD      A,D 
66ff e6 02		                AND     00000010B 
6701 20 21		                JR      NZ,IN_SIO_030 
6703			IN_SIO_020: 
6703 0b			                DEC     BC 
6704 79			                LD      A,C 
6705 fe 00		                CP      0 
6707 20 ee		                JR      NZ,IN_SIO_010 
6709 78			                LD      A,B 
670a fe 00		                CP      0 
670c 20 e9		                JR      NZ,IN_SIO_010 
670e 2b			                DEC     HL 
670f 7d			                LD      A,L 
6710 fe 00		                CP      0 
6712 20 e3		                JR      NZ,IN_SIO_010 
6714 7c			                LD      A,H 
6715 fe 00		                CP      0 
6717 20 de		                JR      NZ,IN_SIO_010 
6719			IN_SIO_060: 
6719 3a ff f2		                LD      A,(FLGDATA) 
671c f6 04		                OR      FLG_RCVTIMEOUT 
671e 32 ff f2		                LD      (FLGDATA),A 
6721 af			                XOR     A 
6722 18 02		                JR      IN_SIO_040 
6724			IN_SIO_030: 
6724 db 20		                IN      A,(USARTDW) 
6726			IN_SIO_040: 
6726 e1			                POP     HL 
6727 d1			                POP     DE 
6728 c1			                POP     BC 
6729 c9			                RET 
672a			IN_SIO_050: 
672a 3a 21 f2		                LD      A,(CTLWORD) 
672d f6 10		                OR      00010000B 
672f d3 21		                OUT     (USARTCW),A 
6731 18 d0		                JR      IN_SIO_020 
6733			; 
6733			; 
6733			; 
6733			IN_SIO3: 
6733 db 21		                IN      A,(USARTCW) 
6735 e6 02		                AND     00000010B 
6737 ca a7 65		                JP      Z,SETCFRET 
673a db 20		                IN      A,(USARTDW) 
673c c3 a4 65		                JP      CLRCFRET 
673f			; 
673f			; 
673f			; 
673f			OUT_SIO: 
673f f5			                PUSH    AF 
6740			OUT_SIO1: 
6740 db 21		                IN      A,(USARTCW) 
6742 e6 01		                AND     00000001B 
6744 28 fa		                JR      Z,OUT_SIO1 
6746 f1			                POP     AF 
6747 d3 20		                OUT     (USARTDW),A 
6749 c9			                RET 
674a			; 
674a			; 
674a			; 
674a			SENDBUF_OUT: 
674a 21 70 f2		                LD      HL,SNDBUF_TOP 
674d			SENDBUF_OUT_000: 
674d 7e			                LD      A,(HL) 
674e cd 3f 67		                CALL    OUT_SIO 
6751 23			                INC     HL 
6752 10 f9		                DJNZ    SENDBUF_OUT_000 
6754 c9			                RET 
6755			; 
6755			; 
6755			; 
6755			RECVBUF_IN: 
6755 78			                LD      A,B 
6756 32 24 f2		                LD      (LFRECVCOUNT),A 
6759 21 70 f2		                LD      HL,RCVBUF_TOP 
675c			RECVBUF_IN_000: 
675c cd e6 66		                CALL    IN_SIO 
675f c5			                PUSH    BC 
6760 47			                LD      B,A 
6761 3a ff f2		                LD      A,(FLGDATA) 
6764 e6 04		                AND     FLG_RCVTIMEOUT 
6766 78			                LD      A,B 
6767 c1			                POP     BC 
6768 20 08		                JR      NZ,RECVBUF_IN_020                 
676a 77			                LD      (HL),A 
676b fe 0a		                CP      LF 
676d 28 15		                JR      Z,RECVBUF_IN_030 
676f			RECVBUF_IN_010: 
676f 23			                INC     HL 
6770 18 ea		                JR      RECVBUF_IN_000 
6772			RECVBUF_IN_020: 
6772 3a 24 f2		                LD      A,(LFRECVCOUNT) 
6775 4f			                LD      C,A 
6776 78			                LD      A,B 
6777 b9			                CP      C 
6778 28 11		                JR      Z,RECVBUF_IN_040 
677a 3a ff f2		                LD      A,(FLGDATA) 
677d e6 fb		                AND     ~FLG_RCVTIMEOUT 
677f 32 ff f2		                LD      (FLGDATA),A 
6782 18 07		                JR      RECVBUF_IN_040 
6784			RECVBUF_IN_030: 
6784 05			                DEC     B 
6785 af			                XOR     A 
6786 b8			                CP      B 
6787 28 02		                JR      Z,RECVBUF_IN_040 
6789 18 e4		                JR      RECVBUF_IN_010 
678b			RECVBUF_IN_040: 
678b c9			                RET 
678c			; 
678c			; 
678c			; 
678c			RECVBUF_CHK: 
678c 21 70 f2		                LD      HL,RCVBUF_TOP 
678f			RECVBUF_CHK1: 
678f 1a			                LD      A,(DE) 
6790 be			                CP      (HL) 
6791 c2 a7 65		                JP      NZ,SETCFRET 
6794 23			                INC     HL 
6795 13			                INC     DE 
6796 10 f7		                DJNZ    RECVBUF_CHK1 
6798 3e 3a		                LD      A,':' 
679a be			                CP      (HL) 
679b c2 a7 65		                JP      NZ,SETCFRET 
679e 23			                INC     HL 
679f c3 a4 65		                JP      CLRCFRET 
67a2			; 
67a2			; 
67a2			; 
67a2			MSG_DISP: 
67a2 af			                XOR     A 
67a3 12			                LD      (DE),A 
67a4 32 49 eb		                LD      (OUTPUT_DEVICE),A 
67a7 3c			                INC     A 
67a8 32 64 ea		                LD      (CURSOR_XPOS),A 
67ab 21 30 f2		                LD      HL,DISPBUF_TOP 
67ae cd ed 52		                CALL    ROM_MSGOUT 
67b1 cd ca 5f		                CALL    ROM_DSPCRLF 
67b4 c9			                RET 
67b5			; 
67b5			; D = 0 
67b5			; HL = E * A 
67b5			; 
67b5			MUL_88_2_16: 
67b5 16 00		                LD      D,0 
67b7 21 00 00		                LD      HL,0 
67ba 06 08		                LD      B,8 
67bc			MUL_L000: 
67bc 29			                ADD     HL,HL 
67bd 87			                ADD     A,A 
67be 30 01		                JR      NC,MUL_000 
67c0 19			                ADD     HL,DE 
67c1			MUL_000: 
67c1 10 f9		                DJNZ    MUL_L000 
67c3 c9			                RET 
67c4			; 
67c4			; 
67c4			; 
67c4 .. 00		ERR_MSG_000:    DB      "abort Receive", 0 
67d2 .. 00		ERR_MSG_001:    DB      "receive time out", 0 
67e3 .. 00		ERR_MSG_002:    DB      "received command mismatch", 0 
67fd .. 00		ERR_MSG_003:    DB      "ftpget failed", 0 
680b .. 00		ERR_MSG_004:    DB      "load address not set", 0 
6820			TBL_CMD: 
6820 .. 00 01		TBL_CMD_BME:    DB      "BME",       0, 1 
6825 32 65		                DW      PARSER_CMD_BME 
6827 50 60		                DW      CMD_BME 
6829 .. 93 00 02	TBL_CMD_FTPLIST:DB      "FTP", 93H,  0, 2       ; reserve code 93H : "LIST" 
682f 32 65		                DW      PARSER_CMD_FTPLIST 
6831 f4 60		                DW      CMD_FTPLIST 
6833 .. c7 00 03	TBL_CMD_FTPGET: DB      "FTP", 0C7H, 0, 3       ; reserve code C7H : "GET" 
6839 3e 65		                DW      PARSER_CMD_FTPGET 
683b 44 62		                DW      CMD_FTPGET 
683d .. 00 04		TBL_CMD_SNTP:   DB      "SNTP",      0, 4 
6843 32 65		                DW      PARSER_CMD_SNTP 
6845 d9 63		                DW      CMD_SNTP 
6847 .. 00 06		TBL_CMD_VER:    DB      "VER",       0, 6 
684c 32 65		                DW      PARSER_CMD_VER 
684e 34 64		                DW      CMD_VER 
6850 00			                DB      0 
6851			TBL_CMD_FTPLIST2: 
6851 ..			                DB      "FTPLIST" 
6858 ..			TBL_CMD_FTPGET2:DB      "FTPGET:" 
685f ..			TBL_CMD_LIST:   DB      "LIST:" 
6864 .. 00		TBL_COUNT_MSG0: DB      "file count: ", 0 
6871 .. 00		TBL_TEMP_MSG0:  DB      "temp : ", 0 
6879 df 43 00		TBL_TEMP_MSG1:  DB      0DFH, "C", 0 
687c .. 00		TBL_HUMI_MSG0:  DB      "humi : ", 0 
6884 .. 00		TBL_HUMI_MSG1:  DB      "%", 0 
6886 .. 00		TBL_PRESS_MSG0: DB      "press: ", 0 
688e .. 00		TBL_PRESS_MSG1: DB      "hPa", 0 
6892 .. 00		TBL_ESP32_VER:  DB      "esp32 firmware v", 0 
68a3 .. 31 2e 30 2e 30 00	TBL_SIO_VER:    DB      "sio   firmware v", 30H + VER_MAJOR, ".", 30H + VER_MINOR, ".", 30H + VER_REVISION, 0 
68b9 0d 0a		TBL_CRLF:       DB      CR, LF 
68bb			                ;END 
68bb			 
# End of file esp32pc8001sio.asm
68bb			; 
68bb			; 
68bb			; 
68bb			_USER_ROM_END: 
68bb 0xff...		                DS      4096 - ( _USER_ROM_END - _USER_ROM_START ), 0FFH 
7000			                END 
			

# End of file esp32pc8001sio_4krom.asm
7000
